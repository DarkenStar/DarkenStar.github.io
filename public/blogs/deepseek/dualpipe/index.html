<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>DualPipe | WITHER</title>
<meta name="keywords" content="DeepSeek, DualPipe">
<meta name="description" content="Source code reading of DualPipe">
<meta name="author" content="WITHER">
<link rel="canonical" href="http://localhost:1313/blogs/deepseek/dualpipe/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.dd3b5b907a50db3238b81d49d094cf1c04a091227797dc9cfde4e2fa3f35df49.css" integrity="sha256-3TtbkHpQ2zI4uB1J0JTPHASgkSJ3l9yc/eTi&#43;j8130k=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blogs/deepseek/dualpipe/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    }
  };
</script>




<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.1.6/mermaid.min.js"></script>
<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: localStorage.getItem("pref-theme") === "dark" ? "dark" : "forest" 
    });
</script>

<meta property="og:url" content="http://localhost:1313/blogs/deepseek/dualpipe/">
  <meta property="og:site_name" content="WITHER">
  <meta property="og:title" content="DualPipe">
  <meta property="og:description" content="Source code reading of DualPipe">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blogs">
    <meta property="article:published_time" content="2025-06-21T22:00:13+08:00">
    <meta property="article:modified_time" content="2025-06-21T22:00:13+08:00">
    <meta property="article:tag" content="DeepSeek">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DualPipe">
<meta name="twitter:description" content="Source code reading of DualPipe">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "http://localhost:1313/blogs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "DeepSeek Related",
      "item": "http://localhost:1313/blogs/deepseek/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "DualPipe",
      "item": "http://localhost:1313/blogs/deepseek/dualpipe/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "DualPipe",
  "name": "DualPipe",
  "description": "Source code reading of DualPipe",
  "keywords": [
    "DeepSeek", "DualPipe"
  ],
  "articleBody": "Preliminary æœ¬èŠ‚å…ˆå›é¡¾æµæ°´çº¿å¹¶è¡Œä»¥åŠ DeepSeek-V3 ä¸­ä½œä¸º baseline çš„ PipeDream è®ºæ–‡ä¸­çš„ 1F1B å’Œ ZeroBubble è®ºæ–‡ä¸­çš„ ZB1P (ZB-H1 çš„è‡ªåŠ¨æœç´¢ç»“æœ).\nPipeDream 1F1B 1F1B (One-Forward-One-Backward) çš„å·¥ä½œæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼Œæƒ³è±¡ä¸€æ¡å·¥å‚æµæ°´çº¿ï¼Œç”¨äºç»„è£…ä¸€ä¸ªå¤æ‚çš„è®¾å¤‡ã€‚è¿™ä¸ªè®¾å¤‡éœ€è¦ç»è¿‡å¤šä¸ªå·¥ä½ï¼ˆGPUï¼‰ï¼Œæ¯ä¸ªå·¥ä½è´Ÿè´£ä¸€éƒ¨åˆ†è£…é…ä»»åŠ¡ï¼ˆæ¨¡å‹çš„ä¸åŒå±‚ï¼‰ã€‚å½“ç¬¬ä¸€ä¸ªäº§å“çš„ç¬¬ä¸€ä¸ªéƒ¨ä»¶åœ¨å·¥ä½1ä¸ŠåŠ å·¥æ—¶ï¼Œå…¶ä»–æ‰€æœ‰å·¥ä½éƒ½åœ¨é—²ç½®ç­‰å¾…ã€‚å½“å®ƒè¢«ä¼ é€’åˆ°å·¥ä½2æ—¶ï¼Œå·¥ä½1å¼€å§‹åŠ å·¥ç¬¬äºŒä¸ªäº§å“ï¼Œä½†å·¥ä½3ã€4â€¦ä¾ç„¶åœ¨ç­‰å¾…ã€‚è¿™ç§åœ¨æµæ°´çº¿å¯åŠ¨å’Œç»“æŸé˜¶æ®µäº§ç”Ÿçš„è®¾å¤‡ç©ºé—²æ—¶é—´ï¼Œå°±æ˜¯æµæ°´çº¿æ°”æ³¡ (Pipeline Bubble). åœ¨å¤§æ¨¡å‹è®­ç»ƒä¸­ï¼Œè¿™æ„å‘³ç€ GPU ç®—åŠ›è¢«æµªè´¹ï¼Œç›´æ¥å¯¼è‡´è®­ç»ƒæ—¶é—´å»¶é•¿å’Œæˆæœ¬å¢åŠ ã€‚\n1F1B pipeline Schedule\nåç»­æ‰¹æ¬¡çš„åå‘ä¼ æ’­æ°¸è¿œåœ¨å‰ä¸€æ‰¹æ¬¡çš„åå‘ä¼ æ’­å…¨éƒ¨å¯åŠ¨åæ‰å¼€å§‹ï¼Œä¸ºäº†é˜²æ­¢æ¿€æ´»å ç”¨å†…å­˜è¿‡å¤šï¼Œå›¾ä¸­ 1F1B çš„ bs=8ï¼Œæµæ°´çº¿å¹¶è¡Œè¿‡ç¨‹ä¸­æœ€å¤šä¿å­˜ 4 ä¸ª batch çš„æ¿€æ´»ï¼Œå½“ batch1 åå‘ä¼ æ’­ç»“æŸåå†è¿›è¡Œ batch5 çš„æ­£å‘ä¼ æ’­ã€‚ä¸ºäº†å‡å°‘æ¿€æ´»å ç”¨ï¼Œ1F1B ä¸­è¿›è¡Œåå‘ä¼ æ’­çš„ä¼˜å…ˆçº§é«˜äºæ­£å‘ä¼ æ’­ã€‚\nZeroBubble ZB1P ZeroBubble å‡å°‘æ°”æ³¡çš„å…³é”®æ˜¯å°†åå‘ä¼ æ’­ä¸­å¯¹äºæƒé‡å’Œè¾“å…¥çš„æ¢¯åº¦è®¡ç®—åˆ†å¼€è¿›è¡Œã€‚ä¼ ç»Ÿä¸Šï¼Œä¸€ä¸ªå±‚çš„åå‘ä¼ æ’­åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒä»»åŠ¡:\nB Pass: è®¡ç®—å…³äºè¾“å…¥æ¢¯åº¦å¹¶å°†å…¶ä¼ é€’ç»™å‰ä¸€å±‚ï¼Œè¿™æ˜¯è¯¯å·®åå‘ä¼ æ’­é“¾çš„ä¸€éƒ¨åˆ†ã€‚ W Pass: è®¡ç®—è¯¥å±‚è‡ªèº«æƒé‡çš„æ¢¯åº¦ï¼Œç”¨äºåç»­çš„å‚æ•°æ›´æ–°ã€‚ å¦‚å›¾æ‰€ç¤ºç¬¬ i-1 å±‚çš„ B Pass ä¾èµ–äºç¬¬ i å±‚çš„ B Pass. ä½†ç¬¬ i å±‚çš„ W Passï¼Œåªè¦åœ¨å…¶ B Pass å®Œæˆä¹‹åï¼Œå¯ä»¥è¢«çµæ´»åœ°å®‰æ’åœ¨ä»»ä½•æ—¶é—´ç‚¹æ‰§è¡Œã€‚\nComputation Graph for MLP Handcrafted Pipeline Schedule\nåŸºäºè¿™ä¸ªæ€æƒ³ï¼Œæ–‡ä¸­æå‡ºäº†ä¸¤ä¸ªæ‰‹å·¥è®¾è®¡çš„è°ƒåº¦æ–¹æ¡ˆä½œä¸ºæ¦‚å¿µéªŒè¯:\nZB-H1 (Memory Efficient Schedule): åœ¨ç»´æŒä¸ 1F1B ç›¸ä¼¼å³°å€¼å†…å­˜æ¶ˆè€—çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å°† W Pass æ¨è¿Ÿæ‰§è¡Œï¼Œå¡«å……äº†æµæ°´çº¿æœ«å°¾çš„ cooldown æ°”æ³¡ï¼ŒæˆåŠŸå°†æ°”æ³¡å¤§å°å‡å°‘åˆ° 1F1B çš„ä¸‰åˆ†ä¹‹ä¸€ã€‚ ZB-H2 (Zero Bubble Schedule): å½“å†…å­˜é¢„ç®—æ›´å®½æ¾æ—¶ï¼Œåœ¨æµæ°´çº¿ warm-up å®‰æ’æ›´å¤šçš„ F Passï¼Œå¹¶å·§å¦™åœ°é‡æ’ W Passï¼Œå°†æ•´ä¸ªæµæ°´çº¿çš„æ‰§è¡Œè¿‡ç¨‹ä»ä¸€ä¸ªæ¢¯å½¢å˜æˆäº†ä¸€ä¸ªå¹³è¡Œå››è¾¹å½¢ï¼Œä»è€Œåœ¨ç†è®ºä¸Šå®Œå…¨æ¶ˆé™¤äº†æ°”æ³¡ã€‚ Handcrafted pipeline schedules ZB-H1 (top) \u0026 ZB-H2 (bottom)\næ–‡ä¸­åŸºäºä¸€ä¸ªæ ‡å‡†çš„ Transformeræ¶æ„ï¼Œå…¶ä¸­ FFN çš„ä¸­é—´å±‚ç»´åº¦æ˜¯æ¨¡å‹éšè—ç»´åº¦ h çš„4å€ã€‚ç»™å‡ºäº† F, B, W å„è‡ªçš„è®¡ç®—é‡å’Œæ¿€æ´»å ç”¨ã€‚å…¶ä¸­è®¡ç®—é‡åªç»Ÿè®¡å æ®ä¸»è¦éƒ¨åˆ†çš„çŸ©é˜µä¹˜æ³•çš„æµ®ç‚¹è¿ç®—æ¬¡æ•°ã€‚\nb: microbatch size s: sequence length h: hidden dimension size a: number of attention heads Transformer Architecture Table1: FLOPs and activations memory required per transformer layer for each pass\nPass FLOPs Activations Memory Required F $sbh(24h+4s)$ 0 B $sbh(24h+8s)$ $sb(34h+5as)$ W $sbh(24h)$ $32sbh$ å‰å‘ä¼ æ’­ $T_F \\approx (8bsh^2 + 4bs^2h) + 16bsh^2 = 24bsh^2 + 4bs^2h = sbh(24h + 4s)$. åå‘ä¼ æ’­å…³äºæƒé‡çš„è®¡ç®—é‡ç­‰äº Linear å±‚çš„ GEMM.\nSelf-Attention: $6bsh^2 + 2bs^2h + 2bs^2h + 2bsh^2 = 8bsh^2 + 4bs^2h$\nQ, K, V Projectionï¼šè¾“å…¥ (b, s, h) é€šè¿‡ä¸æƒé‡çŸ©é˜µ (h, h) ç›¸ä¹˜ï¼Œç”ŸæˆQ, K, Vã€‚è¿™æ¶‰åŠåˆ°3æ¬¡çŸ©é˜µä¹˜æ³•ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times s \\times h \\times 3h = 6bsh^2$ Attention Score:Q (b, a, s, h/a) ä¸ K^T (b, a, h/a, s) ç›¸ä¹˜ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times a \\times s \\times (h/a) \\times s = 2bshs$. Score@Vï¼šæ³¨æ„åŠ›åˆ†æ•° (b, a, s, s) ä¸ V (b, a, s, h/a) ç›¸ä¹˜ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times a \\times s \\times s \\times (h/a) = 2bshs$. O Projecyionï¼šç»“æœä¸è¾“å‡ºæƒé‡çŸ©é˜µ (h, h) ç›¸ä¹˜ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times s \\times h \\times h = 2bsh^2$. FFN FLOPs: $8bsh^2 + 8bsh^2 = 16bsh^2$\nUp Projectionï¼šè¾“å…¥ (b, s, h) ä¸æƒé‡çŸ©é˜µ (h, 4h) ç›¸ä¹˜ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times s \\times h \\times 4h = 8bsh^2$. Down Projectionï¼šä¸­é—´ç»“æœ (b, s, 4h) ä¸æƒé‡çŸ©é˜µ (4h, h) ç›¸ä¹˜ã€‚$\\text{FLOPs} \\approx 2 \\times b \\times s \\times 4h \\times h = 8bsh^2$. æ¿€æ´»å ç”¨æ–¹é¢é™¤äº† Dropout Mask æ˜¯ INT8 ç±»å‹ä»¥å¤–ï¼Œå‡è®¾ activations å‡ä»¥ 16-bit float ç±»å‹ä¿å­˜ã€‚è¡¨ä¸­çš„ activation memory å‡ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç»Ÿè®¡ã€‚å’Œæƒé‡æ¢¯åº¦æ— å…³çš„éƒ¨åˆ†åªæœ‰ dropout ç›¸å…³çš„ä»¥åŠ Softmax output.\nCategory Item Original TP Attention Total $11sbh + 5as^2b$ $3sbh + \\frac{8sbh}{t} + \\frac{5as^2b}{t}$ QKV input $2sbh$ $2sbh$ QK^T $4sbh$ $\\frac{4sbh}{t}$ Softmax output $2as^2b$ $\\frac{2as^2b}{t}$ Dropout mask $as^2b$ $\\frac{as^2b}{t}$ Dropout output $2as^2b$ $\\frac{2as^2b}{t}$ V $2sbh$ $\\frac{2sbh}{t}$ Linear projection input $2sbh$ $\\frac{2sbh}{t}$ Attention dropout mask $sbh$ $sbh$ MLP Total $19sbh$ $3sbh + \\frac{16sbh}{t}$ Linear1 input $2sbh$ $2sbh$ GeLU input $8sbh$ $\\frac{8sbh}{t}$ Linear2 input $8sbh$ $\\frac{8sbh}{t}$ Dropout mask $sbh$ $sbh$ LayerNorm Total $4sbh$ $4sbh$ LayerNorm1 input $2sbh$ $2sbh$ LayerNorm2 input $2sbh$ $2sbh$ åœ¨æ²¡æœ‰ $T_F = T_B = T_W$ å‡è®¾çš„æƒ…å†µä¸‹ï¼ŒZB-H1 å’Œ ZB-H2 çš„å³°å€¼æ¿€æ´»å†…å­˜å’Œæ°”æ³¡å¤§å°å¦‚ Table 2 æ‰€ç¤ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºè®¾å¤‡ iï¼Œå…¶åœ¨ ZB-H1 æ–¹æ¡ˆä¸‹çš„æ¿€æ´»å†…å­˜ä¸º $(p-i+1)M_B + (i-1)M_W$ï¼Œåœ¨ ZB-H2 æ–¹æ¡ˆä¸‹çš„æ¿€æ´»å†…å­˜ä¸º $(2p - 2i + 1)M_B + (2i - 2)M_W$ã€‚å¦‚ Table 1 æ‰€ç¤ºï¼ŒW æ‰€éœ€çš„æ¿€æ´»å†…å­˜å°äº B æ‰€éœ€çš„æ¿€æ´»å†…å­˜ã€‚å› æ­¤ï¼ŒZB-H1 å’Œ ZB-H2 çš„å³°å€¼æ¿€æ´»å†…å­˜åˆ†åˆ«ä¸º $pM_B$ å’Œ $(2p-1)M_B$ã€‚\nTable 2: Comparison between 1F1B and our handcrafted schedules.\nSchedule Bubble size Peak activations memory 1F1B $(p-1)(T_{F}+T_{B}+T_{W})$ $pM_{B}$ ZB-H1 $(p-1)(T_{F}+T_{B}-T_{W})$ $pM_{B}$ ZB-H2 $(p-1)(T_{F}+T_{B}-2T_{W})$ $(2p-1)M_{B}$ Automatic Pipeline Scheduling\næ‰‹å·¥è°ƒåº¦ä¾èµ–äº Fã€Bã€W çš„æ‰§è¡Œæ—¶é—´ç›¸ç­‰çš„ç†æƒ³æƒ…å†µã€‚ä¸ºäº†åº”å¯¹çœŸå®ä¸–ç•Œä¸­å¤æ‚çš„æ‰§è¡Œæ—¶é—´å’Œé€šä¿¡å»¶è¿Ÿï¼Œè¯¥æ–‡å¼€å‘äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–æµæ°´çº¿è°ƒåº¦ç®—æ³•ã€‚è¯¥ç®—æ³•é€šè¿‡ä¸€ç³»åˆ—å¯å‘å¼ç­–ç•¥ï¼Œåœ¨ä¸€ä¸ªç»™å®šçš„å†…å­˜é™åˆ¶ä¸‹ï¼Œè‡ªåŠ¨åœ°ä¸ºæµæ°´çº¿ç”Ÿæˆä¸€ä¸ªé«˜æ•ˆçš„è°ƒåº¦æ–¹æ¡ˆã€‚æ ¸\nWarm-upï¼š\nåœ¨å†…å­˜é™åˆ¶çš„èŒƒå›´å†…ï¼Œç®—æ³•ä¼šå°½å¯èƒ½å¤šåœ°è°ƒåº¦ F pass ï¼Œä»¥æœ€å°åŒ–åœ¨ç¬¬ä¸€ä¸ª B pass å¼€å§‹å‰äº§ç”Ÿçš„æ°”æ³¡ã€‚ æ­¤é˜¶æ®µä½¿ç”¨ä¸€ä¸ªè¶…å‚æ•°æ¥æ§åˆ¶æ˜¯å¦è¦è°ƒåº¦ä¸€ä¸ªå¯èƒ½ä¼šå»¶è¿Ÿåç»­B Passçš„é¢å¤–F Passã€‚ Steady Stateï¼š\nçƒ­èº«é˜¶æ®µç»“æŸåï¼Œè°ƒåº¦è¿›å…¥ä¸€ä¸ªè¿­ä»£æ¨¡å¼ï¼Œè½®æµè°ƒåº¦ä¸€ä¸ªF Passå’Œä¸€ä¸ªB Passã€‚ ä¸ºäº†å¡«å……æ°”æ³¡ï¼Œç®—æ³•ä¼šä¼ºæœºæ’å…¥ W pass. æ’å…¥ç­–ç•¥æ˜¯ï¼š å½“å‡ºç°ä¸€ä¸ªå¤§äº $T_W$ (W Pass æ‰§è¡Œæ—¶é—´) çš„æ°”æ³¡æ—¶ï¼Œç›´æ¥æ’å…¥ä¸€ä¸ªW Pass. å½“å‡ºç°ä¸€ä¸ªå°äº $T_W$ çš„æ°”æ³¡æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ°”æ³¡ä¼šå¯¼è‡´å½“å‰é˜¶æ®µçš„ç´¯è®¡æ°”æ³¡æ—¶é—´æˆä¸ºæ‰€æœ‰é˜¶æ®µä¸­æœ€é•¿çš„ï¼Œé‚£ä¹ˆä»ç„¶ä¼šæ’å…¥ä¸€ä¸ªW Pass. å½“å†…å­˜è¾¾åˆ°ä¸Šé™æ—¶ï¼Œä¹Ÿä¼šæ’å…¥ W Pass ä»¥å›æ”¶å’Œé‡Šæ”¾éƒ¨åˆ†å†…å­˜ã€‚ é€šå¸¸è¿™ä¸ªå¯å‘å¼ç­–ç•¥åœ¨ç¨³æ€é˜¶æ®µä¼šå½¢æˆä¸€ä¸ª 1F-1B-1W çš„è°ƒåº¦æ¨¡å¼ã€‚ Global Scheduleï¼š\nåœ¨æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œç®—æ³•å§‹ç»ˆä¿è¯åœ¨ F Pass ç”¨å®Œä¹‹å‰ï¼Œç¬¬ i é˜¶æ®µè°ƒåº¦çš„ F Pass æ•°é‡è‡³å°‘æ¯”ç¬¬ i+1 é˜¶æ®µå¤šä¸€ä¸ªã€‚ å½“è¿™ä¸ªæ•°é‡å·®è¶…è¿‡ä¸€æ—¶ï¼Œä¼šä½¿ç”¨å¦ä¸€ä¸ªè¶…å‚æ•°æ¥å†³å®šåœ¨ä¸äº§ç”Ÿé¢å¤–æ°”æ³¡çš„å‰æä¸‹ï¼Œæ˜¯å¦è¦è·³è¿‡ç¬¬ i é˜¶æ®µçš„ä¸€æ¬¡F Passè°ƒåº¦ã€‚ ç®—æ³•ä¼šé€šè¿‡ grid search æ¥å¯»æ‰¾è¿™äº›è¶…å‚æ•°çš„æœ€ä½³ç»„åˆã€‚ Finalï¼šå½“æŸä¸ªé˜¶æ®µçš„ F Pass å’Œ B Pass éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œç®—æ³•ä¼šä¸€æ¬¡æ€§é€ä¸ªè°ƒåº¦å®Œæ‰€æœ‰å‰©ä½™çš„ W Pass.\nBypassing Optimizer Synchronization\nè¦å®ç°å®Œç¾çš„å¹³è¡Œå››è¾¹å½¢è°ƒåº¦ï¼Œè¿˜éœ€è¦è§£å†³ä¼˜åŒ–å™¨åŒæ­¥ï¼ˆOptimizer Synchronizationï¼‰. åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œé€šå¸¸éœ€è¦åœ¨æ›´æ–°æ¨¡å‹å‚æ•°å‰ï¼Œåœ¨æ‰€æœ‰ GPU é—´è¿›è¡Œä¸€æ¬¡ All-Reduceï¼Œä»¥è¿›è¡Œæ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰æˆ–æ£€æŸ¥æ•°å€¼ç¨³å®šæ€§ (NaN/INF). è¿™ä¸ªåŒæ­¥ç‚¹ä¼šå¼ºåˆ¶æ‰€æœ‰è®¾å¤‡ç­‰å¾…ï¼Œä»è€Œç ´åå¹³è¡Œå››è¾¹å½¢ï¼Œé‡æ–°å¼•å…¥æ°”æ³¡ã€‚\nè®ºæ–‡æå‡ºäº† Bypassing Optimizer Synchronizationï¼Œæ¯ä¸ª GPU åœ¨æ‰§è¡Œä¼˜åŒ–å™¨æ›´æ–°æ­¥éª¤æ—¶ï¼Œä¸å†ç­‰å¾…å…¨å±€åŒæ­¥ï¼Œè€Œæ˜¯åŸºäºä»å‰ä¸€ä¸ª GPU ä¼ æ¥çš„éƒ¨åˆ† reduce çš„ä¿¡æ¯è¿›è¡Œæ¨æµ‹æ€§æ›´æ–°ã€‚è¯¥ micro-batch å®Œæ•´çš„å…¨å±€çŠ¶æ€ä¼šåœ¨ä¸‹ä¸€ä¸ªè¿­ä»£çš„ warp é˜¶æ®µå¼‚æ­¥åœ°ä¼ å›ã€‚æ¯ä¸ª GPU åœ¨æ”¶åˆ°æœ€ç»ˆçš„å…¨å±€çŠ¶æ€åï¼Œä¼šéªŒè¯è‡ªå·±ä¸Šä¸€æ­¥çš„æ›´æ–°æ˜¯å¦åˆæ³•ã€‚å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ï¼Œå…¨å±€æ¢¯åº¦èŒƒæ•°è¶…å‡ºäº†è£å‰ªé˜ˆå€¼ï¼‰ï¼Œå®ƒä¼šæ‰§è¡Œä¸€æ¬¡åŸåœ°å›æ»šï¼ˆIn-place Rollbackï¼‰ï¼Œç„¶åä½¿ç”¨æ­£ç¡®çš„å…¨å±€çŠ¶æ€é‡æ–°æ‰§è¡Œä¼˜åŒ–å™¨æ­¥éª¤ã€‚\nThe Post-validation Strategy to Replace Optimizer Synchronization\nDualPipe DualPipe æ˜¯ä¸€ç§åˆ›æ–°çš„åŒå‘æµæ°´çº¿å¹¶è¡Œç®—æ³•ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ä¸€ç»„è®¾å¤‡ä¸ŠåŒæ—¶å¤„ç†ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®æµï¼šä¸€ä¸ªå‰å‘æµæ°´çº¿å’Œä¸€ä¸ªåå‘æµæ°´çº¿ã€‚ä½¿å¾—è®¡ç®—å’Œé€šä¿¡èƒ½å¤Ÿæ›´å……åˆ†åœ°é‡å ï¼Œä»è€Œå‡å°‘æµæ°´çº¿æ°”æ³¡ï¼ˆå³ GPU ç©ºé—²æ—¶é—´ï¼‰.\nä¸ä¼ ç»Ÿçš„ GPipeï¼ˆ1F1Bï¼‰åªæœ‰ä¸€ä¸ªæ•°æ®æµæ–¹å‘ä¸åŒï¼ŒDualPipe å°†è®¾å¤‡å¯¹æŠ˜ï¼Œå½¢æˆä¸¤æ¡å¯¹ç§°çš„æµæ°´çº¿ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæœ‰ 8 ä¸ª PP ranks (GPU) çš„è®¾ç½®ä¸­ï¼š\nå‰å‘æµæ°´çº¿ (Forward Pipeline): æ•°æ®ä» rank 0 -\u003e 1 -\u003e 2 -\u003e 3. åå‘æµæ°´çº¿ (Backward Pipeline): åŒæ—¶æœ‰å¦ä¸€ç»„æ•°æ®ä» rank 7 -\u003e 6 -\u003e 5 -\u003e 4. Rank 3 å’Œ Rank 4 æˆä¸ºä¸¤æ¡æµæ°´çº¿çš„ä¸­é—´èŠ‚ç‚¹ï¼Œå®ƒä»¬ä¹‹é—´ä¼šäº¤æ¢æ•°æ®ã€‚æ¯ä¸ªè®¾å¤‡å®é™…ä¸Šä¼šå¤„ç†ä¸¤ä¸ªæµæ°´çº¿é˜¶æ®µçš„æ¨¡å‹å—ï¼Œä¸€ä¸ªç”¨äºå‰å‘æµæ°´çº¿ï¼Œå¦ä¸€ä¸ªç”¨äºåå‘æµæ°´çº¿ã€‚ Initialization modules: æ¯ä¸ª DualPipe å®ä¾‹æ¥æ”¶ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸¤ä¸ª nn.Module. modules[0] ç”¨äºå¤„ç†å‰å‘-\u003eåå‘çš„è®¡ç®—ï¼Œmodules[1] ç”¨äºå¤„ç†åå‘-\u003eå‰å‘çš„è®¡ç®—ã€‚ Rank è§’è‰²åˆ¤æ–­: ä»£ç ä¼šæ ¹æ®å½“å‰ rank çš„ ID åˆ¤æ–­å…¶åœ¨æ•´ä¸ªæµæ°´çº¿ä¸­çš„ä½ç½®ï¼ˆæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€æ˜¯å¦åœ¨ååŠéƒ¨åˆ†ã€æ˜¯å¦æ˜¯ä¸­é—´èŠ‚ç‚¹ï¼‰. è¿™ä¸ªè§’è‰²åˆ¤æ–­å¯¹äºåç»­çš„é€šä¿¡å’Œè®¡ç®—è°ƒåº¦è‡³å…³é‡è¦ã€‚ä¾‹å¦‚ is_in_second_half å†³å®šäº†è¯¥ rank çš„ phase 0 å’Œ phase 1 ç©¶ç«Ÿå¯¹åº”å‰å‘æµæ°´çº¿è¿˜æ˜¯åå‘æµæ°´çº¿ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class DualPipe(nn.Module): def __init__( self, modules: Tuple[nn.Module, nn.Module], # ... ) -\u003e None: super().__init__() # æ¯ä¸ª rank æŒæœ‰ä¸¤ä¸ªæ¨¡å‹æ¨¡å— self.module = nn.ModuleList(modules) # ... self.group = process_group or dist.distributed_c10d._get_default_group() self.num_ranks = self.group.size() # ... # è®¡ç®—å½“å‰ rank åœ¨æµæ°´çº¿ä¸­çš„è§’è‰² self.rank = rank_mapping[self.group.rank()] self.is_first_rank = self.rank == 0 self.is_last_rank = self.rank == self.num_ranks - 1 # åˆ¤æ–­ rank æ˜¯å¦åœ¨å¯¹æŠ˜åçš„ååŠéƒ¨åˆ† self.is_in_second_half = self.rank \u003e= self.num_ranks // 2 # åˆ¤æ–­æ˜¯å¦ä¸ºä¸­é—´çš„ rank self.is_middle_rank = (self.rank == self.num_ranks // 2 - 1) or (self.rank == self.num_ranks // 2) Core Function: step step æ–¹æ³•æ˜¯ DualPipe çš„æ ¸å¿ƒï¼Œå®ƒåè°ƒäº†æ‰€æœ‰ micro-batches çš„è®¡ç®—å’Œé€šä¿¡ã€‚æ•´ä¸ªè¿‡ç¨‹è¢«åˆ’åˆ†ä¸º 8 ä¸ªé˜¶æ®µï¼Œä»¥å®ç°æœ€å¤§ç¨‹åº¦çš„è®¡ç®—-é€šä¿¡é‡å ã€‚\nè¾“å…¥å¤„ç†: åªæœ‰ rank 0 å’Œ rank N-1 ä¼šæ¥æ”¶å¤–éƒ¨è¾“å…¥æ•°æ® inputs å’Œ labels. è¿™äº›æ•°æ®è¢« scatter (dualpipe/utils.py) åˆ‡åˆ†æˆ half_num_chunk ä¸ª micro-batch ã€‚Rank 0 çš„è¾“å…¥ç”¨äºå‰å‘æµæ°´çº¿ï¼ŒRank N-1 çš„è¾“å…¥ç”¨äºåå‘æµæ°´çº¿ã€‚\ndef step( self, *inputs: Optional[torch.Tensor], num_chunks: int = 0, # ... ) -\u003e Tuple[Optional[torch.Tensor], Optional[Union[torch.Tensor, Tuple[torch.Tensor]]]]: # ... # é‡ç½®çŠ¶æ€ self._reset_states() # å°†è¾“å…¥æ•°æ®åˆ‡åˆ†æˆ micro-batch inputs = scatter(inputs, half_num_chunks, self.batch_dim) labels = scatter(labels, half_num_chunks, self.batch_dim) if self.is_first_rank: self.input_chunks = (inputs, []) self.labels = ([], labels) elif self.is_last_rank: self.input_chunks = ([], inputs) self.labels = (labels, []) # ... æ¥ä¸‹æ¥æ˜¯ 8 ä¸ªæ ¸å¿ƒè°ƒåº¦é˜¶æ®µçš„ï¼Œåœ¨æ­¤ä¹‹å‰ä¼šè¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œï¼š\nçŠ¶æ€é‡ç½®: _reset_states() æ¸…ç©ºä¸Šä¸€è½®è¿­ä»£çš„ç¼“å­˜ï¼Œå¦‚è¾“å…¥/è¾“å‡ºå—ã€æ¢¯åº¦ã€æŸå¤±ç­‰ã€‚ rank ç¡®å®š: è®¡ç®— num_half_ranksï¼ˆæµæ°´çº¿å¯¹æŠ˜åçš„ä¸€åŠè®¾å¤‡æ•°ï¼‰å’Œ half_rankï¼ˆå½“å‰ç§©åœ¨å¯¹æŠ˜æµæ°´çº¿ä¸­çš„ä½ç½®. è¿™äº›å˜é‡å°†å†³å®šæ¯ä¸ªé˜¶æ®µçš„å¾ªç¯æ¬¡æ•°ã€‚ æ•°æ®åˆ†å‘: scatter å‡½æ•°å°†è¾“å…¥æ•°æ® inputs å’Œ labels åˆ‡åˆ†æˆ half_num_chunks ä¸ª micro-batch ã€‚æ ¹æ® is_first_rank æˆ– is_last_rankï¼Œå°†è¿™äº› micro-batch å­˜æ”¾åˆ° self.input_chunks å’Œ self.labels ä¸­ã€‚ è°ƒåº¦ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²çº¿åˆ†éš”äº†æ¯ä¸ªæ­¥éª¤\nDualPipe Schedule\nStep 1: Warm-up Forward nF0\nè¿™æ˜¯ä¸€ä¸ªçº¯å‰å‘è®¡ç®—é˜¶æ®µï¼Œç”¨äºå¡«æ»¡æµæ°´çº¿ã€‚è·ç¦»æµæ°´çº¿ä¸­ç‚¹è¶Šè¿œçš„ rankï¼ˆhalf_rank è¶Šå°ï¼‰æ‰§è¡Œçš„é¢„çƒ­æ­¥éª¤è¶Šå¤šã€‚ _forward_chunk(0) è¢«è°ƒç”¨ï¼Œåœ¨æ­¤å‡½æ•°å†…éƒ¨:\n_recv_forward(0): å°è¯•æ¥æ”¶å‰ä¸€ä¸ª rank çš„æ•°æ®ã€‚å¯¹äº rank 0 æ¥è¯´ï¼Œå®ƒç›´æ¥ä½¿ç”¨ self.input_chunks çš„æ•°æ®ï¼Œä¸æ¥æ”¶ã€‚ _commit_and_wait_comm(): ç­‰å¾…æ•°æ®æ¥æ”¶å®Œæˆã€‚ _forward_compute_chunk(0): æ‰§è¡Œ self.module[0] çš„å‰å‘è®¡ç®—ã€‚ _send_forward(0): å°†è®¡ç®—ç»“æœå¼‚æ­¥åœ°å‘é€ç»™ä¸‹ä¸€ä¸ª rank. 1 2 3 step_1 = (num_half_ranks - half_rank - 1) * 2 for i in range(step_1): self._forward_chunk(0) Step 2: Dual Forward nF0F1\nä¸¤æ¡æµæ°´çº¿éƒ½å¼€å§‹æ‰§è¡Œå‰å‘è®¡ç®—ã€‚ä¸¤æ¡æµæ°´çº¿éƒ½å¼€å§‹å·¥ä½œã€‚å½“å‰ rank ä¸ä»…ç»§ç»­å¤„ç† phase 0 çš„å‰å‘è®¡ç®—ï¼Œä¹Ÿå¼€å§‹å¤„ç†ä»å¦ä¸€ç«¯ï¼ˆphase 1ï¼‰ä¼ æ¥çš„æ•°æ®çš„å‰å‘è®¡ç®—ã€‚\n_forward_chunk(0, recv=False, ...) å¤„ç†ä¸€ä¸ª phase 0 çš„ micro-batch ï¼Œä½†ä¸ç«‹å³æ¥æ”¶ä¸‹ä¸€ä¸ªï¼Œå› ä¸ºå‰é¢å·²ç»è°ƒç”¨äº† _recv_forward(0). _forward_chunk(1, ...): å¤„ç†ä¸€ä¸ª phase 1 çš„ micro-batch ã€‚ 1 2 3 4 5 6 7 8 9 # Step 2: nF0F1 step_2 = half_rank + 1 self._recv_forward(0) for i in range(step_2): self._forward_chunk(0, recv=False, send=self.is_middle_rank) self._recv_forward(0) self._forward_chunk(1, send=(not self.is_middle_rank) or (i \u003c step_2 - 1)) if not self.is_middle_rank: self._send_forward(0) Step 3: å‰å‘-åå‘-æƒé‡æ··åˆé˜¶æ®µ (Zero Bubble) nB1W1F1\nè¿™æ˜¯ DualPipe æé«˜æ•ˆç‡çš„å…³é”®ã€‚å½“ä¸€æ¡æµæ°´çº¿å¼€å§‹è¿›è¡Œåå‘è®¡ç®—æ—¶ï¼Œå¦ä¸€æ¡æµæ°´çº¿ä»åœ¨è¿›è¡Œå‰å‘è®¡ç®—ã€‚\n_backward_chunk(1, enable_zb=True): æ‰§è¡Œåå‘è®¡ç®—ï¼Œå¹¶å¯ç”¨ Zero Bubble (ZB) ä¼˜åŒ–ã€‚ZB é€šè¿‡ WeightGradStore å°†æƒé‡æ¢¯åº¦ï¼ˆweight gradientsï¼‰çš„è®¡ç®—ï¼ˆé€šå¸¸åœ¨åå‘ä¼ æ’­ä¸­é˜»å¡ï¼‰ç¼“å­˜èµ·æ¥ï¼Œæ¨è¿Ÿæ‰§è¡Œï¼Œä»è€Œè®©è·¯ç»™å…¶ä»–è®¡ç®—æˆ–é€šä¿¡ã€‚ _weight_chunk(): æ‰§è¡Œè¢«æ¨è¿Ÿçš„æƒé‡æ¢¯åº¦è®¡ç®—ã€‚ _forward_chunk(1): åŒæ—¶æ‰§è¡Œå¦ä¸€ä¸ªæ–¹å‘çš„å‰å‘è®¡ç®—ã€‚ # Step 3: nB1W1F1 (Use zero bubble) step_3 = num_half_ranks - half_rank - 1 for i in range(step_3): self._backward_chunk(1, enable_zb=True) self._recv_forward(1) self._weight_chunk() self._forward_chunk(1, recv=False) Step 4: Main Steady State nF0B1F1B0\nè¿™æ˜¯æµæ°´çº¿å®Œå…¨å¡«æ»¡åçš„ä¸»å¾ªç¯ã€‚åœ¨ä¸€ä¸ªå¾ªç¯è¿­ä»£ä¸­ï¼Œä¸€ä¸ª rank ä¼šæ‰§è¡Œä¸¤æ¬¡è®¡ç®—å’Œé€šä¿¡çš„é‡å æ“ä½œï¼šä¸€æ¬¡æ˜¯ï¼ˆå‰å‘è®¡ç®— + åå‘è®¡ç®—ï¼‰ï¼Œå¦ä¸€æ¬¡ä¹Ÿæ˜¯ï¼ˆå‰å‘è®¡ç®— + åå‘è®¡ç®—ï¼‰. è¿™é‡Œè°ƒç”¨ _forward_backward_chunk(0, 1) å’Œ _forward_backward_chunk(1, 0). è¿™ä¸ªå‡½æ•°å°è¯•å°†ä¸€ä¸ªæ–¹å‘çš„å‰å‘è®¡ç®—ï¼ˆFï¼‰ä¸å¦ä¸€ä¸ªæ–¹å‘çš„åå‘è®¡ç®—ï¼ˆBï¼‰æ‰“åŒ…åœ¨ä¸€èµ·æ‰§è¡Œï¼Œå®ç° F\u0026B é‡å ã€‚\n# Step 4 (Main step): nF0B1F1B0 step_4 = half_num_chunks - num_ranks + half_rank + 1 for i in range(step_4): # ... self._forward_backward_chunk(0, 1) # i != 0 self._forward_backward_chunk(1, 0) Step 5 \u0026 6: åå‘-åå‘æ··åˆé˜¶æ®µ (Cooldown Backward) nB1F1B0 å’Œ nB1B0\nå½“å‰å‘æ•°æ®æµè€—å°½åï¼Œæµæ°´çº¿è¿›å…¥æ”¶å°¾é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µä¸»è¦æ‰§è¡Œå‰©ä½™çš„åå‘è®¡ç®—ã€‚åŒæ ·ï¼ŒZB ä¼˜åŒ–åœ¨ååŠæ®µè¢«å¯ç”¨ï¼Œä»¥å‡å°‘æ°”æ³¡ã€‚\n# Step 5: nB1F1B0 step_5 = num_half_ranks - half_rank - 1 for i in range(step_5): self._backward_chunk(1) self._forward_backward_chunk(1, 0) # Step 6: nB1B0 (The second half of the chunks use zero bubble) step_6 = half_rank + 1 enable_zb = False for i in range(step_6): if i == step_6 // 2 and half_rank % 2 == 1: enable_zb = True self._backward_chunk(1, enable_zb=enable_zb) if i == step_6 // 2 and half_rank % 2 == 0: enable_zb = True self._backward_chunk(0, enable_zb=enable_zb) Step 7 \u0026 8: æƒé‡æ›´æ–°æ”¶å°¾é˜¶æ®µ nWB0 å’Œ nW\nStep 7 å°†æœ€åçš„åå‘è®¡ç®—ä¸æƒé‡è®¡ç®—é‡å ã€‚ Step 8 æ˜¯çº¯ç²¹çš„æƒé‡è®¡ç®—é˜¶æ®µï¼Œå¾ªç¯è°ƒç”¨ _weight_chunk() ç›´åˆ° WeightGradStore.funcs_queue é˜Ÿåˆ—ä¸ºç©ºï¼Œç¡®ä¿æ‰€æœ‰æ¢¯åº¦éƒ½å·²è®¡ç®—å®Œæ¯•ã€‚ # Step 7: nWB0 (Use zero bubble) step_7 = num_half_ranks - half_rank - 1 for i in range(step_7): self._weight_chunk() self._backward_chunk(0, enable_zb=True) # Step 8: nW step_8 = half_rank + 1 for i in range(step_8): self._weight_chunk() assert WeightGradStore.funcs_queue.empty() Computation-Communication Overlap _forward_backward_compute_chunk å‡½æ•°æ˜¯å®ç°è®¡ç®—é‡å çš„å…³é”®ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ˆå¦‚æœæ¨¡å‹ç»“æ„æ”¯æŒï¼‰ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ª micro-batch çš„å‰å‘è®¡ç®—å’Œå¦ä¸€ä¸ª micro-batch çš„åå‘è®¡ç®—åœ¨åŒä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸­å®Œæˆã€‚è¯¥å‡½æ•°åœ¨ step4 ä½¿ç”¨çš„_forward_backward_chunk å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 def _forward_backward_compute_chunk(self, phase0: int, phase1: int) -\u003e None: # ... if not self.overlapped_forward_backward: self._forward_compute_chunk(phase0) self._backward_compute_chunk(phase1) return # ... # forward \u0026 backward outputs0, loss0 = type(module0).overlapped_forward_backward( module0, inputs0, criterion0, labels0, module1, loss1, outputs1, output_grads1, ) # ... å¦‚æœæ¨¡å‹å®šä¹‰äº†ä¸€ä¸ª overlapped_forward_backward (@classmethod)ï¼ŒDualPipe å°±ä¼šè°ƒç”¨å®ƒã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œå¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰å‰å‘å’Œåå‘è®¡ç®—çš„äº¤é”™æ‰§è¡Œé¡ºåºï¼Œä»¥è¾¾åˆ°æœ€ä½³çš„é‡å æ•ˆæœã€‚DeepSeek-v3 çš„é‡å æ–¹æ³•åœ¨æŠ€æœ¯æŠ¥å‘Šé‡Œå·²ç»è®²è§£ã€‚\nReal Case é€šè¿‡ examples/example_dualpipe.py ä¸­çš„ main å‡½æ•°æ¥è¯¦ç»†è®²è§£ä¸€ä¸ªå®Œæ•´çš„ DualPipe æµç¨‹ã€‚\nç¯å¢ƒåˆå§‹åŒ–å’Œé…ç½® åˆ†å¸ƒå¼è®¾ç½®: main å‡½æ•°é¦–å…ˆåˆå§‹åŒ– PyTorch çš„åˆ†å¸ƒå¼é€šä¿¡ç»„ï¼ˆinit_process_groupï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªè¿›ç¨‹ï¼ˆrankï¼‰åˆ†é…ä¸€ä¸ª GPU. å‚æ•°é…ç½®: å®šä¹‰äº† micro-batch æ•°é‡ (num_chunks)ã€æ¯ä¸ª micro-batch çš„å¤§å° (micro_batch_size) ç­‰è¶…å‚æ•°ã€‚ P2Pé€šä¿¡è®¾ç½®: åœ¨æ‰§è¡Œ DualPipe çš„ step æ–¹æ³•å‰ï¼Œå¿…é¡»è°ƒç”¨ set_p2p_tensor_shapes å’Œ set_p2p_tensor_dtype æ¥å‘ŠçŸ¥ DualPipe åœ¨æµæ°´çº¿ä¸­ä¼ é€’çš„å¼ é‡çš„å½¢çŠ¶å’Œæ•°æ®ç±»å‹ã€‚è¿™æ˜¯å› ä¸º DualPipe éœ€è¦é¢„å…ˆåˆ†é…å†…å­˜æ¥æ¥æ”¶æ¥è‡ªå…¶ä»– rank çš„æ•°æ®ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 def main(rank, pp_size): # åˆ¤æ–­å½“å‰è¿›ç¨‹çš„è§’è‰² is_first_rank = rank == 0 is_last_rank = rank == pp_size - 1 # åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ dist.init_process_group(backend='nccl', init_method=\"env://\", world_size=pp_size, rank=rank) torch.cuda.set_device(rank) torch.set_default_device(f\"cuda:{rank}\") torch.manual_seed(233) os.environ[\"CUBLAS_WORKSPACE_CONFIG\"] = \":4096:8\" # å®šä¹‰æµæ°´çº¿å‚æ•° num_chunks = 20 micro_batch_size = 3 seq_len = 256 hidden_size = 512 if is_first_rank: print(f\"{pp_size=}, {num_chunks=}, {seq_len=}, {hidden_size=}\", flush=True) # è®¾ç½®P2Pé€šä¿¡çš„Tensorå½¢çŠ¶å’Œç±»å‹ set_p2p_tensor_shapes([(micro_batch_size, seq_len, hidden_size)]) set_p2p_tensor_dtype(torch.float32) æ¨¡å‹å’Œå‚è€ƒåŸºå‡†çš„åˆ›å»º 1 2 3 4 5 6 7 8 9 # åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ã€æœªåˆ†å‰²çš„æ¨¡å‹ full_modules = nn.Sequential(*[PipelineStage(hidden_size) for _ in range(pp_size)]) # åˆ›å»ºå®Œæ•´çš„è¾“å…¥æ•°æ® full_x = torch.randn(num_chunks * micro_batch_size, seq_len, hidden_size) full_l = torch.randn(num_chunks * micro_batch_size, seq_len, hidden_size) # å‚è€ƒæ­¥éª¤ï¼šåœ¨ä¸€ä¸ªGPUä¸Šï¼Œç”¨æ ‡å‡†çš„æ•°æ®å¹¶è¡Œæ–¹å¼è¿è¡Œå®Œæ•´æ¨¡å‹ï¼Œå¾—åˆ°åŸºå‡†ç»“æœ loss_ref, output_ref = ref_step(full_x, full_l, full_modules, num_chunks) åˆ›å»ºæ¨¡å‹: ä»£ç é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ nn.Sequential æ¨¡å‹ (full_modules)ï¼Œå®ƒåŒ…å«äº†æµæ°´çº¿æ‰€æœ‰çš„é˜¶æ®µã€‚ å‚è€ƒæ­¥éª¤ (ref_step): ä¸ºäº†éªŒè¯ DualPipe çš„æ­£ç¡®æ€§ï¼Œref_step å‡½æ•°æ¨¡æ‹Ÿäº†æ ‡å‡†çš„ã€éæµæ°´çº¿å¹¶è¡Œçš„è®­ç»ƒè¿‡ç¨‹ã€‚å®ƒå°†æ•°æ®åˆ†å—ï¼Œä¾æ¬¡é€šè¿‡å®Œæ•´æ¨¡å‹è®¡ç®—æŸå¤±å’Œè¾“å‡ºã€‚loss_ref å’Œ output_ref å°†ä½œä¸ºåç»­æ¯”è¾ƒçš„æ­£ç¡®ç­”æ¡ˆã€‚ DualPipeæ¨¡å‹çš„åˆ›å»ºå’Œè¾“å…¥å‡†å¤‡ æ¨¡å‹åˆ†å‰²: æ¯ä¸ª rank r ä¼šæŒæœ‰ä¸¤ä¸ª PipelineStage: ä¸€ä¸ªæ˜¯ full_modules[r]ï¼Œå¦ä¸€ä¸ªæ˜¯ full_modules[pp_size - 1 - r]. è¿™å°±æ˜¯ Dual (åŒå‘) çš„ä½“ç°ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ª 4-GPU çš„è®¾ç½®ä¸­ï¼š Rank 0 æŒæœ‰ stage 0 å’Œ stage 3 çš„æ¨¡å‹ã€‚ Rank 1 æŒæœ‰ stage 1 å’Œ stage 2 çš„æ¨¡å‹ã€‚ Rank 2 æŒæœ‰ stage 2 å’Œ stage 1 çš„æ¨¡å‹ã€‚ Rank 3 æŒæœ‰ stage 3 å’Œ stage 0 çš„æ¨¡å‹ã€‚ è¾“å…¥æ•°æ®åˆ†å‰²: DualPipe æœ‰ä¸¤ä¸ªæ•°æ®å…¥å£ç‚¹ï¼šrank 0 å’Œæœ€åä¸€ä¸ª rank. rank 0 æ¥æ”¶å‰åŠéƒ¨åˆ†çš„è¾“å…¥ (full_x.chunk(2)[0]) å’Œ ååŠéƒ¨åˆ† çš„æ ‡ç­¾ (full_l.chunk(2)[1]). last rank æ¥æ”¶ååŠéƒ¨åˆ†çš„è¾“å…¥ (full_x.chunk(2)[1]) å’Œ å‰åŠéƒ¨åˆ† çš„æ ‡ç­¾ (full_l.chunk(2)[0]). ä¸€å…±æœ‰ä¸¤ä¸ªæ•°æ®æµ: ä¸€ä¸ªä» rank 0 å¼€å§‹ï¼Œå…¶å¯¹åº”çš„æ ‡ç­¾åœ¨æœ€åä¸€ä¸ª rankï¼›å¦ä¸€ä¸ªä»æœ€åä¸€ä¸ª rank å¼€å§‹ï¼Œå…¶å¯¹åº”çš„æ ‡ç­¾åœ¨ rank 0.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # DualPipe æ¨¡å‹åˆ›å»º # æ¯ä¸ª rank è·å–ä¸¤ä¸ªå¤„äºå¯¹ç§°ä½ç½®çš„æ¨¡å‹å— local_full_modules = nn.Sequential(full_modules[rank], full_modules[pp_size - 1 - rank]) local_modules = nn.Sequential(PipelineStage(hidden_size), PipelineStage(hidden_size)) # ... åŠ è½½æƒé‡ ... dualpipe_model = DualPipe(local_modules) # DualPipeè¾“å…¥æ•°æ®å‡†å¤‡ if is_first_rank: x = full_x.chunk(2)[0] l = full_l.chunk(2)[1] elif is_last_rank: x = full_x.chunk(2)[1] l = full_l.chunk(2)[0] else: x = None l = None æ‰§è¡Œè®­ç»ƒæ­¥éª¤ è°ƒç”¨ dualpipe_model.stepï¼Œè§¦å‘äº†å‰é¢è®²è§£ä¸­æåˆ°çš„å¤æ‚çš„8é˜¶æ®µè°ƒåº¦æµç¨‹ã€‚\nloss, outputs = dualpipe_model.step(x, num_chunks=num_chunks, criterion=criterion, labels=(l,), return_outputs=False) ç»“æœéªŒè¯ æ£€æŸ¥æŸå¤±\nif is_first_rank: assert torch.equal(loss, loss_ref.chunk(2)[1]) elif is_last_rank: assert torch.equal(loss, loss_ref.chunk(2)[0]) else: assert loss is None è®­ç»ƒæ­¥éª¤å®Œæˆåï¼Œstep æ–¹æ³•ä¼šè¿”å›è®¡ç®—å‡ºçš„æŸå¤±ã€‚\nrank0 è®¡ç®—å‡ºçš„ loss å¯¹åº”çš„æ˜¯ä» last rank è¾“å…¥çš„æ•°æ®æµï¼Œç­‰äºå‚è€ƒæŸå¤±çš„ååŠéƒ¨åˆ† (loss_ref.chunk(2)[1]). åŒç†ï¼Œlast rank è®¡ç®—å‡ºçš„ loss å¯¹åº”çš„æ˜¯ä» rank0 è¾“å…¥çš„æ•°æ®æµï¼Œç­‰äºå‚è€ƒæŸå¤±çš„å‰åŠéƒ¨åˆ† (loss_ref.chunk(2)[0]). ä¸­é—´çš„ ranks ä¸è®¡ç®—æœ€ç»ˆæŸå¤±ï¼Œè¿”å› None. æ£€æŸ¥æ¢¯åº¦\n1 2 3 4 5 6 7 8 9 for (p0, p1) in zip(local_modules[0].parameters(), local_modules[1].parameters()): # ... dist.all_gather_into_tensor(p0all, p0.grad) dist.all_gather_into_tensor(p1all, p1.grad) # æ‰‹åŠ¨èšåˆå¯¹ç§°rankçš„æ¢¯åº¦ p0.grad += p1all[pp_size - 1 - rank] p1.grad += p0all[pp_size - 1 - rank] for ((n, p), p_ref) in zip(local_modules.named_parameters(), local_full_modules.parameters()): assert cal_diff(p.grad, p_ref.grad) \u003c 1e-13 ç”±äºæ¯ä¸ª rank r æŒæœ‰ r å’Œ pp_size - 1 - r ä¸¤ä¸ªé˜¶æ®µçš„æ¨¡å‹ï¼Œå¦‚æœè¿™ä¸¤ä¸ªé˜¶æ®µåœ¨é€»è¾‘ä¸Šæ˜¯åŒä¸€ä¸ªæƒé‡ï¼ˆä¾‹å¦‚ï¼Œåœ¨Encoder-Decoderç»“æ„ä¸­å…±äº«æƒé‡ï¼‰ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ¢¯åº¦éœ€è¦æ‰‹åŠ¨èšåˆã€‚ç¤ºä¾‹é€šè¿‡ dist.all_gather_into_tensor æ”¶é›†æ‰€æœ‰ rank ä¸Šå¯¹ç§°æ¨¡å—çš„æ¢¯åº¦ï¼Œç„¶åæ‰‹åŠ¨å°†å®ƒä»¬ç›¸åŠ ã€‚æœ€åï¼Œå°†èšåˆåçš„æ¢¯åº¦ä¸ ref_step ä¸­è®¡ç®—å‡ºçš„å‚è€ƒæ¢¯åº¦è¿›è¡Œæ¯”è¾ƒï¼ŒéªŒè¯åå‘ä¼ æ’­çš„æ­£ç¡®æ€§ã€‚\n",
  "wordCount" : "6075",
  "inLanguage": "en",
  "datePublished": "2025-06-21T22:00:13+08:00",
  "dateModified": "2025-06-21T22:00:13+08:00",
  "author":[{
    "@type": "Person",
    "name": "WITHER"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blogs/deepseek/dualpipe/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "WITHER",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="WITHER (Alt + H)">WITHER</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/zh/" title="ç®€ä½“ä¸­æ–‡"
                            aria-label="ç®€ä½“ä¸­æ–‡">ç®€ä½“ä¸­æ–‡</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="ğŸ  Home">
                    <span>ğŸ  Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about_me/" title="ğŸ™‹ğŸ»â€â™‚ï¸ Me">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸ Me</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blogs/" title="ğŸ“š Blogs">
                    <span>ğŸ“š Blogs</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="ğŸ§© Categories">
                    <span>ğŸ§© Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ”– Tags">
                    <span>ğŸ”– Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="â± Archive">
                    <span>â± Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ” Search (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/friends/" title="ğŸ¤ Friends">
                    <span>ğŸ¤ Friends</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/blogs/">Blogs</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/blogs/deepseek/">DeepSeek Related</a></div>
    <h1 class="post-title entry-hint-parent">
      DualPipe
    </h1>
    <div class="post-description">
      Source code reading of DualPipe
    </div>
    <div class="post-meta"><span title='2025-06-21 22:00:13 +0800 CST'>Jun-21-2025</span>&nbsp;Â·&nbsp;13 min&nbsp;Â·&nbsp;6075 words&nbsp;Â·&nbsp;WITHER

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#preliminary" aria-label="Preliminary">Preliminary</a><ul>
                            
                    <li>
                        <a href="#pipedream-1f1b" aria-label="PipeDream 1F1B">PipeDream 1F1B</a></li>
                    <li>
                        <a href="#zerobubble-zb1p" aria-label="ZeroBubble ZB1P">ZeroBubble ZB1P</a></li></ul>
                    </li>
                    <li>
                        <a href="#dualpipe" aria-label="DualPipe">DualPipe</a><ul>
                            
                    <li>
                        <a href="#initialization" aria-label="Initialization">Initialization</a></li>
                    <li>
                        <a href="#core-function-step" aria-label="Core Function: step">Core Function: step</a></li>
                    <li>
                        <a href="#computation-communication-overlap" aria-label="Computation-Communication Overlap">Computation-Communication Overlap</a></li></ul>
                    </li>
                    <li>
                        <a href="#real-case" aria-label="Real Case">Real Case</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="preliminary">Preliminary<a hidden class="anchor" aria-hidden="true" href="#preliminary">#</a></h1>
<p>æœ¬èŠ‚å…ˆå›é¡¾æµæ°´çº¿å¹¶è¡Œä»¥åŠ DeepSeek-V3 ä¸­ä½œä¸º baseline çš„ <a href="https://arxiv.org/pdf/1806.03377">PipeDream</a> è®ºæ–‡ä¸­çš„ 1F1B å’Œ <a href="https://openreview.net/pdf?id=tuzTN0eIO5">ZeroBubble</a> è®ºæ–‡ä¸­çš„ ZB1P (ZB-H1 çš„è‡ªåŠ¨æœç´¢ç»“æœ).</p>
<h2 id="pipedream-1f1b">PipeDream 1F1B<a hidden class="anchor" aria-hidden="true" href="#pipedream-1f1b">#</a></h2>
<p>1F1B (One-Forward-One-Backward) çš„å·¥ä½œæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼Œæƒ³è±¡ä¸€æ¡å·¥å‚æµæ°´çº¿ï¼Œç”¨äºç»„è£…ä¸€ä¸ªå¤æ‚çš„è®¾å¤‡ã€‚è¿™ä¸ªè®¾å¤‡éœ€è¦ç»è¿‡å¤šä¸ªå·¥ä½ï¼ˆGPUï¼‰ï¼Œæ¯ä¸ªå·¥ä½è´Ÿè´£ä¸€éƒ¨åˆ†è£…é…ä»»åŠ¡ï¼ˆæ¨¡å‹çš„ä¸åŒå±‚ï¼‰ã€‚å½“ç¬¬ä¸€ä¸ªäº§å“çš„ç¬¬ä¸€ä¸ªéƒ¨ä»¶åœ¨å·¥ä½1ä¸ŠåŠ å·¥æ—¶ï¼Œå…¶ä»–æ‰€æœ‰å·¥ä½éƒ½åœ¨é—²ç½®ç­‰å¾…ã€‚å½“å®ƒè¢«ä¼ é€’åˆ°å·¥ä½2æ—¶ï¼Œå·¥ä½1å¼€å§‹åŠ å·¥ç¬¬äºŒä¸ªäº§å“ï¼Œä½†å·¥ä½3ã€4â€¦ä¾ç„¶åœ¨ç­‰å¾…ã€‚è¿™ç§åœ¨æµæ°´çº¿å¯åŠ¨å’Œç»“æŸé˜¶æ®µäº§ç”Ÿçš„è®¾å¤‡ç©ºé—²æ—¶é—´ï¼Œå°±æ˜¯æµæ°´çº¿æ°”æ³¡ (Pipeline Bubble). åœ¨å¤§æ¨¡å‹è®­ç»ƒä¸­ï¼Œè¿™æ„å‘³ç€ GPU ç®—åŠ›è¢«æµªè´¹ï¼Œç›´æ¥å¯¼è‡´è®­ç»ƒæ—¶é—´å»¶é•¿å’Œæˆæœ¬å¢åŠ ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEB787301b994e9c90258f8ad84fd1f8b67?method=download&amp;shareKey=db772d656fe8be439988e887fd6910a3" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEB787301b994e9c90258f8ad84fd1f8b67?method=download&amp;shareKey=db772d656fe8be439988e887fd6910a3" alt="1F1B pipeline Schedule">
    </a><figcaption>1F1B pipeline Schedule</figcaption></figure></p>
<p>åç»­æ‰¹æ¬¡çš„åå‘ä¼ æ’­æ°¸è¿œåœ¨å‰ä¸€æ‰¹æ¬¡çš„åå‘ä¼ æ’­å…¨éƒ¨å¯åŠ¨åæ‰å¼€å§‹ï¼Œä¸ºäº†é˜²æ­¢æ¿€æ´»å ç”¨å†…å­˜è¿‡å¤šï¼Œå›¾ä¸­ 1F1B çš„ bs=8ï¼Œæµæ°´çº¿å¹¶è¡Œè¿‡ç¨‹ä¸­æœ€å¤šä¿å­˜ 4 ä¸ª batch çš„æ¿€æ´»ï¼Œå½“ batch1 åå‘ä¼ æ’­ç»“æŸåå†è¿›è¡Œ batch5 çš„æ­£å‘ä¼ æ’­ã€‚ä¸ºäº†å‡å°‘æ¿€æ´»å ç”¨ï¼Œ1F1B ä¸­è¿›è¡Œåå‘ä¼ æ’­çš„ä¼˜å…ˆçº§é«˜äºæ­£å‘ä¼ æ’­ã€‚</p>
<h2 id="zerobubble-zb1p">ZeroBubble ZB1P<a hidden class="anchor" aria-hidden="true" href="#zerobubble-zb1p">#</a></h2>
<p>ZeroBubble å‡å°‘æ°”æ³¡çš„å…³é”®æ˜¯å°†åå‘ä¼ æ’­ä¸­å¯¹äºæƒé‡å’Œè¾“å…¥çš„æ¢¯åº¦è®¡ç®—åˆ†å¼€è¿›è¡Œã€‚ä¼ ç»Ÿä¸Šï¼Œä¸€ä¸ªå±‚çš„åå‘ä¼ æ’­åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒä»»åŠ¡:</p>
<ul>
<li>B Pass: è®¡ç®—å…³äºè¾“å…¥æ¢¯åº¦å¹¶å°†å…¶ä¼ é€’ç»™å‰ä¸€å±‚ï¼Œè¿™æ˜¯è¯¯å·®åå‘ä¼ æ’­é“¾çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>W Pass: è®¡ç®—è¯¥å±‚è‡ªèº«æƒé‡çš„æ¢¯åº¦ï¼Œç”¨äºåç»­çš„å‚æ•°æ›´æ–°ã€‚</li>
</ul>
<p>å¦‚å›¾æ‰€ç¤ºç¬¬ i-1 å±‚çš„ B Pass ä¾èµ–äºç¬¬ i å±‚çš„ B Pass. ä½†ç¬¬ i å±‚çš„ W Passï¼Œåªè¦åœ¨å…¶ B Pass å®Œæˆä¹‹åï¼Œå¯ä»¥è¢«çµæ´»åœ°å®‰æ’åœ¨ä»»ä½•æ—¶é—´ç‚¹æ‰§è¡Œã€‚</p>
<h2 id="computation-graph-for-mlp">
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEBeef090dd44e296a4a4e985200c62e4c7?method=download&amp;shareKey=2d9e68a50dd5b0b3c46f079499ed2bec" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEBeef090dd44e296a4a4e985200c62e4c7?method=download&amp;shareKey=2d9e68a50dd5b0b3c46f079499ed2bec" alt="Computation Graph for MLP">
    </a><figcaption>Computation Graph for MLP</figcaption></figure></h2>
<p><strong>Handcrafted Pipeline Schedule</strong></p>
<p>åŸºäºè¿™ä¸ªæ€æƒ³ï¼Œæ–‡ä¸­æå‡ºäº†ä¸¤ä¸ªæ‰‹å·¥è®¾è®¡çš„è°ƒåº¦æ–¹æ¡ˆä½œä¸ºæ¦‚å¿µéªŒè¯:</p>
<ul>
<li>ZB-H1 (Memory Efficient Schedule): åœ¨ç»´æŒä¸ 1F1B ç›¸ä¼¼å³°å€¼å†…å­˜æ¶ˆè€—çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å°† W Pass æ¨è¿Ÿæ‰§è¡Œï¼Œå¡«å……äº†æµæ°´çº¿æœ«å°¾çš„ cooldown æ°”æ³¡ï¼ŒæˆåŠŸå°†æ°”æ³¡å¤§å°å‡å°‘åˆ° 1F1B çš„ä¸‰åˆ†ä¹‹ä¸€ã€‚</li>
<li>ZB-H2 (Zero Bubble Schedule): å½“å†…å­˜é¢„ç®—æ›´å®½æ¾æ—¶ï¼Œåœ¨æµæ°´çº¿ warm-up å®‰æ’æ›´å¤šçš„ F Passï¼Œå¹¶å·§å¦™åœ°é‡æ’ W Passï¼Œå°†æ•´ä¸ªæµæ°´çº¿çš„æ‰§è¡Œè¿‡ç¨‹ä»ä¸€ä¸ªæ¢¯å½¢å˜æˆäº†ä¸€ä¸ªå¹³è¡Œå››è¾¹å½¢ï¼Œä»è€Œåœ¨ç†è®ºä¸Šå®Œå…¨æ¶ˆé™¤äº†æ°”æ³¡ã€‚</li>
</ul>
<p>
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEB9f702f88f4b48c048d602ddfe7b69ffb?method=download&amp;shareKey=010eea5b8230b6175d7777444e4dcc64" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEB9f702f88f4b48c048d602ddfe7b69ffb?method=download&amp;shareKey=010eea5b8230b6175d7777444e4dcc64" alt="Handcrafted pipeline schedules ZB-H1 (top)  &amp; ZB-H2 (bottom)">
    </a><figcaption>Handcrafted pipeline schedules ZB-H1 (top)  &amp; ZB-H2 (bottom)</figcaption></figure></p>
<p>æ–‡ä¸­åŸºäºä¸€ä¸ªæ ‡å‡†çš„ Transformeræ¶æ„ï¼Œå…¶ä¸­ FFN çš„ä¸­é—´å±‚ç»´åº¦æ˜¯æ¨¡å‹éšè—ç»´åº¦ <code>h</code> çš„4å€ã€‚ç»™å‡ºäº† F, B, W å„è‡ªçš„è®¡ç®—é‡å’Œæ¿€æ´»å ç”¨ã€‚å…¶ä¸­è®¡ç®—é‡åªç»Ÿè®¡å æ®ä¸»è¦éƒ¨åˆ†çš„çŸ©é˜µä¹˜æ³•çš„æµ®ç‚¹è¿ç®—æ¬¡æ•°ã€‚</p>
<ul>
<li><code>b</code>: microbatch size</li>
<li><code>s</code>: sequence length</li>
<li><code>h</code>: hidden dimension size</li>
<li><code>a</code>: number of attention heads</li>
</ul>
<h2 id="transformer-architecture">
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEBd9f810c1f506d383eb59a0c1186e602b?method=download&amp;shareKey=ee9e8a521ed880701b05e9b25b1ae001" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEBd9f810c1f506d383eb59a0c1186e602b?method=download&amp;shareKey=ee9e8a521ed880701b05e9b25b1ae001" alt="Transformer Architecture">
    </a><figcaption>Transformer Architecture</figcaption></figure></h2>
<p><em>Table1: FLOPs and activations memory required per transformer layer for each pass</em></p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Pass</th>
          <th style="text-align: center">FLOPs</th>
          <th style="text-align: center">Activations Memory Required</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">F</td>
          <td style="text-align: center">$sbh(24h+4s)$</td>
          <td style="text-align: center">0</td>
      </tr>
      <tr>
          <td style="text-align: center">B</td>
          <td style="text-align: center">$sbh(24h+8s)$</td>
          <td style="text-align: center">$sb(34h+5as)$</td>
      </tr>
      <tr>
          <td style="text-align: center">W</td>
          <td style="text-align: center">$sbh(24h)$</td>
          <td style="text-align: center">$32sbh$</td>
      </tr>
  </tbody>
</table>
<hr>
<p>å‰å‘ä¼ æ’­ $T_F \approx (8bsh^2 + 4bs^2h) + 16bsh^2 = 24bsh^2 + 4bs^2h = sbh(24h + 4s)$. åå‘ä¼ æ’­å…³äºæƒé‡çš„è®¡ç®—é‡ç­‰äº Linear å±‚çš„ GEMM.</p>
<ul>
<li>
<p><strong>Self-Attention</strong>: $6bsh^2 + 2bs^2h + 2bs^2h + 2bsh^2 = 8bsh^2 + 4bs^2h$</p>
<ul>
<li><strong>Q, K, V Projection</strong>ï¼šè¾“å…¥ <code>(b, s, h)</code> é€šè¿‡ä¸æƒé‡çŸ©é˜µ <code>(h, h)</code> ç›¸ä¹˜ï¼Œç”ŸæˆQ, K, Vã€‚è¿™æ¶‰åŠåˆ°3æ¬¡çŸ©é˜µä¹˜æ³•ã€‚$\text{FLOPs} \approx 2 \times b \times s \times h \times 3h = 6bsh^2$</li>
<li><strong>Attention Score</strong>:<code>Q</code> <code>(b, a, s, h/a)</code> ä¸ <code>K^T</code> <code>(b, a, h/a, s)</code> ç›¸ä¹˜ã€‚$\text{FLOPs} \approx 2 \times b \times a \times s \times (h/a) \times s = 2bshs$.</li>
<li><strong>Score@V</strong>ï¼šæ³¨æ„åŠ›åˆ†æ•° <code>(b, a, s, s)</code> ä¸ <code>V</code> <code>(b, a, s, h/a)</code> ç›¸ä¹˜ã€‚$\text{FLOPs} \approx 2 \times b \times a \times s \times s \times (h/a) = 2bshs$.</li>
<li><strong>O Projecyion</strong>ï¼šç»“æœä¸è¾“å‡ºæƒé‡çŸ©é˜µ <code>(h, h)</code> ç›¸ä¹˜ã€‚$\text{FLOPs} \approx 2 \times b \times s \times h \times h = 2bsh^2$.</li>
</ul>
</li>
<li>
<p><strong>FFN FLOPs</strong>: $8bsh^2 + 8bsh^2 = 16bsh^2$</p>
<ul>
<li><strong>Up Projection</strong>ï¼šè¾“å…¥ <code>(b, s, h)</code> ä¸æƒé‡çŸ©é˜µ <code>(h, 4h)</code> ç›¸ä¹˜ã€‚$\text{FLOPs} \approx 2 \times b \times s \times h \times 4h = 8bsh^2$.</li>
<li><strong>Down Projection</strong>ï¼šä¸­é—´ç»“æœ <code>(b, s, 4h)</code> ä¸æƒé‡çŸ©é˜µ <code>(4h, h)</code> ç›¸ä¹˜ã€‚$\text{FLOPs} \approx 2 \times b \times s \times 4h \times h = 8bsh^2$.</li>
</ul>
</li>
</ul>
<hr>
<p>æ¿€æ´»å ç”¨æ–¹é¢é™¤äº† Dropout Mask æ˜¯ INT8 ç±»å‹ä»¥å¤–ï¼Œå‡è®¾ activations å‡ä»¥ 16-bit float ç±»å‹ä¿å­˜ã€‚è¡¨ä¸­çš„ activation memory å‡ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç»Ÿè®¡ã€‚å’Œæƒé‡æ¢¯åº¦æ— å…³çš„éƒ¨åˆ†åªæœ‰ dropout ç›¸å…³çš„ä»¥åŠ Softmax output.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Category</th>
          <th style="text-align: center">Item</th>
          <th style="text-align: center">Original</th>
          <th style="text-align: center">TP</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><strong>Attention</strong></td>
          <td style="text-align: center"><strong>Total</strong></td>
          <td style="text-align: center"><strong>$11sbh + 5as^2b$</strong></td>
          <td style="text-align: center"><strong>$3sbh + \frac{8sbh}{t} + \frac{5as^2b}{t}$</strong></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">QKV input</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$2sbh$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">QK^T</td>
          <td style="text-align: center">$4sbh$</td>
          <td style="text-align: center">$\frac{4sbh}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Softmax output</td>
          <td style="text-align: center">$2as^2b$</td>
          <td style="text-align: center">$\frac{2as^2b}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Dropout mask</td>
          <td style="text-align: center">$as^2b$</td>
          <td style="text-align: center">$\frac{as^2b}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Dropout output</td>
          <td style="text-align: center">$2as^2b$</td>
          <td style="text-align: center">$\frac{2as^2b}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">V</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$\frac{2sbh}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Linear projection input</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$\frac{2sbh}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Attention dropout mask</td>
          <td style="text-align: center">$sbh$</td>
          <td style="text-align: center">$sbh$</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>MLP</strong></td>
          <td style="text-align: center"><strong>Total</strong></td>
          <td style="text-align: center"><strong>$19sbh$</strong></td>
          <td style="text-align: center"><strong>$3sbh + \frac{16sbh}{t}$</strong></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Linear1 input</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$2sbh$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">GeLU input</td>
          <td style="text-align: center">$8sbh$</td>
          <td style="text-align: center">$\frac{8sbh}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Linear2 input</td>
          <td style="text-align: center">$8sbh$</td>
          <td style="text-align: center">$\frac{8sbh}{t}$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">Dropout mask</td>
          <td style="text-align: center">$sbh$</td>
          <td style="text-align: center">$sbh$</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>LayerNorm</strong></td>
          <td style="text-align: center"><strong>Total</strong></td>
          <td style="text-align: center"><strong>$4sbh$</strong></td>
          <td style="text-align: center"><strong>$4sbh$</strong></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">LayerNorm1 input</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$2sbh$</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">LayerNorm2 input</td>
          <td style="text-align: center">$2sbh$</td>
          <td style="text-align: center">$2sbh$</td>
      </tr>
  </tbody>
</table>
<hr>
<p>åœ¨æ²¡æœ‰ $T_F = T_B = T_W$ å‡è®¾çš„æƒ…å†µä¸‹ï¼ŒZB-H1 å’Œ ZB-H2 çš„å³°å€¼æ¿€æ´»å†…å­˜å’Œæ°”æ³¡å¤§å°å¦‚ Table 2 æ‰€ç¤ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºè®¾å¤‡ <em>i</em>ï¼Œå…¶åœ¨ ZB-H1 æ–¹æ¡ˆä¸‹çš„æ¿€æ´»å†…å­˜ä¸º $(p-i+1)M_B + (i-1)M_W$ï¼Œåœ¨ ZB-H2 æ–¹æ¡ˆä¸‹çš„æ¿€æ´»å†…å­˜ä¸º $(2p - 2i + 1)M_B + (2i - 2)M_W$ã€‚å¦‚ Table 1 æ‰€ç¤ºï¼Œ<em>W</em> æ‰€éœ€çš„æ¿€æ´»å†…å­˜å°äº <em>B</em> æ‰€éœ€çš„æ¿€æ´»å†…å­˜ã€‚å› æ­¤ï¼ŒZB-H1 å’Œ ZB-H2 çš„å³°å€¼æ¿€æ´»å†…å­˜åˆ†åˆ«ä¸º $pM_B$ å’Œ $(2p-1)M_B$ã€‚</p>
<p><em>Table 2: Comparison between 1F1B and our handcrafted schedules.</em></p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Schedule</th>
          <th style="text-align: center">Bubble size</th>
          <th style="text-align: center">Peak activations memory</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">1F1B</td>
          <td style="text-align: center">$(p-1)(T_{F}+T_{B}+T_{W})$</td>
          <td style="text-align: center">$pM_{B}$</td>
      </tr>
      <tr>
          <td style="text-align: center">ZB-H1</td>
          <td style="text-align: center">$(p-1)(T_{F}+T_{B}-T_{W})$</td>
          <td style="text-align: center">$pM_{B}$</td>
      </tr>
      <tr>
          <td style="text-align: center">ZB-H2</td>
          <td style="text-align: center">$(p-1)(T_{F}+T_{B}-2T_{W})$</td>
          <td style="text-align: center">$(2p-1)M_{B}$</td>
      </tr>
  </tbody>
</table>
<p><strong>Automatic Pipeline Scheduling</strong></p>
<p>æ‰‹å·¥è°ƒåº¦ä¾èµ–äº Fã€Bã€W çš„æ‰§è¡Œæ—¶é—´ç›¸ç­‰çš„ç†æƒ³æƒ…å†µã€‚ä¸ºäº†åº”å¯¹çœŸå®ä¸–ç•Œä¸­å¤æ‚çš„æ‰§è¡Œæ—¶é—´å’Œé€šä¿¡å»¶è¿Ÿï¼Œè¯¥æ–‡å¼€å‘äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–æµæ°´çº¿è°ƒåº¦ç®—æ³•ã€‚è¯¥ç®—æ³•é€šè¿‡ä¸€ç³»åˆ—å¯å‘å¼ç­–ç•¥ï¼Œåœ¨ä¸€ä¸ªç»™å®šçš„å†…å­˜é™åˆ¶ä¸‹ï¼Œè‡ªåŠ¨åœ°ä¸ºæµæ°´çº¿ç”Ÿæˆä¸€ä¸ªé«˜æ•ˆçš„è°ƒåº¦æ–¹æ¡ˆã€‚æ ¸</p>
<ol>
<li>
<p><strong>Warm-up</strong>ï¼š</p>
<ul>
<li>åœ¨å†…å­˜é™åˆ¶çš„èŒƒå›´å†…ï¼Œç®—æ³•ä¼šå°½å¯èƒ½å¤šåœ°è°ƒåº¦ F pass ï¼Œä»¥æœ€å°åŒ–åœ¨ç¬¬ä¸€ä¸ª B pass å¼€å§‹å‰äº§ç”Ÿçš„æ°”æ³¡ã€‚</li>
<li>æ­¤é˜¶æ®µä½¿ç”¨ä¸€ä¸ªè¶…å‚æ•°æ¥æ§åˆ¶æ˜¯å¦è¦è°ƒåº¦ä¸€ä¸ªå¯èƒ½ä¼šå»¶è¿Ÿåç»­B Passçš„é¢å¤–F Passã€‚</li>
</ul>
</li>
<li>
<p><strong>Steady State</strong>ï¼š</p>
<ul>
<li>çƒ­èº«é˜¶æ®µç»“æŸåï¼Œè°ƒåº¦è¿›å…¥ä¸€ä¸ªè¿­ä»£æ¨¡å¼ï¼Œè½®æµè°ƒåº¦ä¸€ä¸ªF Passå’Œä¸€ä¸ªB Passã€‚</li>
<li>ä¸ºäº†å¡«å……æ°”æ³¡ï¼Œç®—æ³•ä¼šä¼ºæœºæ’å…¥ W pass. æ’å…¥ç­–ç•¥æ˜¯ï¼š
<ul>
<li>å½“å‡ºç°ä¸€ä¸ªå¤§äº $T_W$ (W Pass æ‰§è¡Œæ—¶é—´) çš„æ°”æ³¡æ—¶ï¼Œç›´æ¥æ’å…¥ä¸€ä¸ªW Pass.</li>
<li>å½“å‡ºç°ä¸€ä¸ªå°äº $T_W$ çš„æ°”æ³¡æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ°”æ³¡ä¼šå¯¼è‡´å½“å‰é˜¶æ®µçš„ç´¯è®¡æ°”æ³¡æ—¶é—´æˆä¸ºæ‰€æœ‰é˜¶æ®µä¸­æœ€é•¿çš„ï¼Œé‚£ä¹ˆä»ç„¶ä¼šæ’å…¥ä¸€ä¸ªW Pass.</li>
<li>å½“å†…å­˜è¾¾åˆ°ä¸Šé™æ—¶ï¼Œä¹Ÿä¼šæ’å…¥ W Pass ä»¥å›æ”¶å’Œé‡Šæ”¾éƒ¨åˆ†å†…å­˜ã€‚</li>
</ul>
</li>
<li>é€šå¸¸è¿™ä¸ªå¯å‘å¼ç­–ç•¥åœ¨ç¨³æ€é˜¶æ®µä¼šå½¢æˆä¸€ä¸ª 1F-1B-1W çš„è°ƒåº¦æ¨¡å¼ã€‚</li>
</ul>
</li>
<li>
<p><strong>Global Schedule</strong>ï¼š</p>
<ul>
<li>åœ¨æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œç®—æ³•å§‹ç»ˆä¿è¯åœ¨ F Pass ç”¨å®Œä¹‹å‰ï¼Œç¬¬ i é˜¶æ®µè°ƒåº¦çš„ F Pass æ•°é‡è‡³å°‘æ¯”ç¬¬ i+1 é˜¶æ®µå¤šä¸€ä¸ªã€‚</li>
<li>å½“è¿™ä¸ªæ•°é‡å·®è¶…è¿‡ä¸€æ—¶ï¼Œä¼šä½¿ç”¨å¦ä¸€ä¸ªè¶…å‚æ•°æ¥å†³å®šåœ¨ä¸äº§ç”Ÿé¢å¤–æ°”æ³¡çš„å‰æä¸‹ï¼Œæ˜¯å¦è¦è·³è¿‡ç¬¬ i é˜¶æ®µçš„ä¸€æ¬¡F Passè°ƒåº¦ã€‚</li>
<li>ç®—æ³•ä¼šé€šè¿‡ grid search æ¥å¯»æ‰¾è¿™äº›è¶…å‚æ•°çš„æœ€ä½³ç»„åˆã€‚</li>
</ul>
</li>
<li>
<p><strong>Final</strong>ï¼šå½“æŸä¸ªé˜¶æ®µçš„ F Pass å’Œ B Pass éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œç®—æ³•ä¼šä¸€æ¬¡æ€§é€ä¸ªè°ƒåº¦å®Œæ‰€æœ‰å‰©ä½™çš„ W Pass.</p>
</li>
</ol>
<hr>
<p><strong>Bypassing Optimizer Synchronization</strong></p>
<p>è¦å®ç°å®Œç¾çš„å¹³è¡Œå››è¾¹å½¢è°ƒåº¦ï¼Œè¿˜éœ€è¦è§£å†³ä¼˜åŒ–å™¨åŒæ­¥ï¼ˆOptimizer Synchronizationï¼‰. åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œé€šå¸¸éœ€è¦åœ¨æ›´æ–°æ¨¡å‹å‚æ•°å‰ï¼Œåœ¨æ‰€æœ‰ GPU é—´è¿›è¡Œä¸€æ¬¡ All-Reduceï¼Œä»¥è¿›è¡Œæ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰æˆ–æ£€æŸ¥æ•°å€¼ç¨³å®šæ€§ (NaN/INF). è¿™ä¸ªåŒæ­¥ç‚¹ä¼šå¼ºåˆ¶æ‰€æœ‰è®¾å¤‡ç­‰å¾…ï¼Œä»è€Œç ´åå¹³è¡Œå››è¾¹å½¢ï¼Œé‡æ–°å¼•å…¥æ°”æ³¡ã€‚</p>
<p>è®ºæ–‡æå‡ºäº† Bypassing Optimizer Synchronizationï¼Œæ¯ä¸ª GPU åœ¨æ‰§è¡Œä¼˜åŒ–å™¨æ›´æ–°æ­¥éª¤æ—¶ï¼Œä¸å†ç­‰å¾…å…¨å±€åŒæ­¥ï¼Œè€Œæ˜¯åŸºäºä»å‰ä¸€ä¸ª GPU ä¼ æ¥çš„éƒ¨åˆ† reduce çš„ä¿¡æ¯è¿›è¡Œæ¨æµ‹æ€§æ›´æ–°ã€‚è¯¥ micro-batch å®Œæ•´çš„å…¨å±€çŠ¶æ€ä¼šåœ¨ä¸‹ä¸€ä¸ªè¿­ä»£çš„ warp é˜¶æ®µå¼‚æ­¥åœ°ä¼ å›ã€‚æ¯ä¸ª GPU åœ¨æ”¶åˆ°æœ€ç»ˆçš„å…¨å±€çŠ¶æ€åï¼Œä¼šéªŒè¯è‡ªå·±ä¸Šä¸€æ­¥çš„æ›´æ–°æ˜¯å¦åˆæ³•ã€‚å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ï¼Œå…¨å±€æ¢¯åº¦èŒƒæ•°è¶…å‡ºäº†è£å‰ªé˜ˆå€¼ï¼‰ï¼Œå®ƒä¼šæ‰§è¡Œä¸€æ¬¡åŸåœ°å›æ»šï¼ˆIn-place Rollbackï¼‰ï¼Œç„¶åä½¿ç”¨æ­£ç¡®çš„å…¨å±€çŠ¶æ€é‡æ–°æ‰§è¡Œä¼˜åŒ–å™¨æ­¥éª¤ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEB69834a68b841e1af30873b5a95a2fc90?method=download&amp;shareKey=0544362bccaefd3cad59bb0be406a145" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEB69834a68b841e1af30873b5a95a2fc90?method=download&amp;shareKey=0544362bccaefd3cad59bb0be406a145" alt="The Post-validation Strategy to Replace Optimizer Synchronization">
    </a><figcaption>The Post-validation Strategy to Replace Optimizer Synchronization</figcaption></figure></p>
<h1 id="dualpipe">DualPipe<a hidden class="anchor" aria-hidden="true" href="#dualpipe">#</a></h1>
<p>DualPipe æ˜¯ä¸€ç§åˆ›æ–°çš„åŒå‘æµæ°´çº¿å¹¶è¡Œç®—æ³•ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ä¸€ç»„è®¾å¤‡ä¸ŠåŒæ—¶å¤„ç†ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®æµï¼šä¸€ä¸ªå‰å‘æµæ°´çº¿å’Œä¸€ä¸ªåå‘æµæ°´çº¿ã€‚ä½¿å¾—è®¡ç®—å’Œé€šä¿¡èƒ½å¤Ÿæ›´å……åˆ†åœ°é‡å ï¼Œä»è€Œå‡å°‘æµæ°´çº¿æ°”æ³¡ï¼ˆå³ GPU ç©ºé—²æ—¶é—´ï¼‰.</p>
<p>ä¸ä¼ ç»Ÿçš„ GPipeï¼ˆ1F1Bï¼‰åªæœ‰ä¸€ä¸ªæ•°æ®æµæ–¹å‘ä¸åŒï¼ŒDualPipe å°†è®¾å¤‡å¯¹æŠ˜ï¼Œå½¢æˆä¸¤æ¡å¯¹ç§°çš„æµæ°´çº¿ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæœ‰ 8 ä¸ª PP ranks (GPU) çš„è®¾ç½®ä¸­ï¼š</p>
<ul>
<li>å‰å‘æµæ°´çº¿ (Forward Pipeline): æ•°æ®ä» rank 0 -&gt; 1 -&gt; 2 -&gt; 3.</li>
<li>åå‘æµæ°´çº¿ (Backward Pipeline): åŒæ—¶æœ‰å¦ä¸€ç»„æ•°æ®ä» rank 7 -&gt; 6 -&gt; 5 -&gt; 4.
Rank 3 å’Œ Rank 4 æˆä¸ºä¸¤æ¡æµæ°´çº¿çš„ä¸­é—´èŠ‚ç‚¹ï¼Œå®ƒä»¬ä¹‹é—´ä¼šäº¤æ¢æ•°æ®ã€‚æ¯ä¸ªè®¾å¤‡å®é™…ä¸Šä¼šå¤„ç†ä¸¤ä¸ªæµæ°´çº¿é˜¶æ®µçš„æ¨¡å‹å—ï¼Œä¸€ä¸ªç”¨äºå‰å‘æµæ°´çº¿ï¼Œå¦ä¸€ä¸ªç”¨äºåå‘æµæ°´çº¿ã€‚</li>
</ul>
<h2 id="initialization">Initialization<a hidden class="anchor" aria-hidden="true" href="#initialization">#</a></h2>
<ul>
<li>modules: æ¯ä¸ª DualPipe å®ä¾‹æ¥æ”¶ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸¤ä¸ª nn.Module. <code>modules[0]</code> ç”¨äºå¤„ç†å‰å‘-&gt;åå‘çš„è®¡ç®—ï¼Œ<code>modules[1]</code> ç”¨äºå¤„ç†åå‘-&gt;å‰å‘çš„è®¡ç®—ã€‚</li>
<li>Rank è§’è‰²åˆ¤æ–­: ä»£ç ä¼šæ ¹æ®å½“å‰ rank çš„ ID åˆ¤æ–­å…¶åœ¨æ•´ä¸ªæµæ°´çº¿ä¸­çš„ä½ç½®ï¼ˆæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€æ˜¯å¦åœ¨ååŠéƒ¨åˆ†ã€æ˜¯å¦æ˜¯ä¸­é—´èŠ‚ç‚¹ï¼‰. è¿™ä¸ªè§’è‰²åˆ¤æ–­å¯¹äºåç»­çš„é€šä¿¡å’Œè®¡ç®—è°ƒåº¦è‡³å…³é‡è¦ã€‚ä¾‹å¦‚ <code>is_in_second_half</code> å†³å®šäº†è¯¥ rank çš„ phase 0 å’Œ phase 1 ç©¶ç«Ÿå¯¹åº”å‰å‘æµæ°´çº¿è¿˜æ˜¯åå‘æµæ°´çº¿ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DualPipe</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># æ¯ä¸ª rank æŒæœ‰ä¸¤ä¸ªæ¨¡å‹æ¨¡å—</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">process_group</span> <span class="ow">or</span> <span class="n">dist</span><span class="o">.</span><span class="n">distributed_c10d</span><span class="o">.</span><span class="n">_get_default_group</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è®¡ç®—å½“å‰ rank åœ¨æµæ°´çº¿ä¸­çš„è§’è‰²</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">rank</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_first_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_last_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ranks</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ¤æ–­ rank æ˜¯å¦åœ¨å¯¹æŠ˜åçš„ååŠéƒ¨åˆ†</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_in_second_half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ranks</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ¤æ–­æ˜¯å¦ä¸ºä¸­é—´çš„ rank</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_middle_rank</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ranks</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ranks</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="core-function-step">Core Function: step<a hidden class="anchor" aria-hidden="true" href="#core-function-step">#</a></h2>
<p><a href="https://github.com/deepseek-ai/DualPipe/blob/main/dualpipe/dualpipe.py#L294">step</a> æ–¹æ³•æ˜¯ <code>DualPipe</code> çš„æ ¸å¿ƒï¼Œå®ƒåè°ƒäº†æ‰€æœ‰ micro-batches çš„è®¡ç®—å’Œé€šä¿¡ã€‚æ•´ä¸ªè¿‡ç¨‹è¢«åˆ’åˆ†ä¸º 8 ä¸ªé˜¶æ®µï¼Œä»¥å®ç°æœ€å¤§ç¨‹åº¦çš„è®¡ç®—-é€šä¿¡é‡å ã€‚</p>
<p>è¾“å…¥å¤„ç†: åªæœ‰ rank 0 å’Œ rank N-1 ä¼šæ¥æ”¶å¤–éƒ¨è¾“å…¥æ•°æ® <code>inputs</code> å’Œ <code>labels</code>. è¿™äº›æ•°æ®è¢« <code>scatter</code> (<code>dualpipe/utils.py</code>) åˆ‡åˆ†æˆ <code>half_num_chunk</code> ä¸ª micro-batch ã€‚Rank 0 çš„è¾“å…¥ç”¨äºå‰å‘æµæ°´çº¿ï¼ŒRank N-1 çš„è¾“å…¥ç”¨äºåå‘æµæ°´çº¿ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_chunks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># é‡ç½®çŠ¶æ€</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_states</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># å°†è¾“å…¥æ•°æ®åˆ‡åˆ†æˆ micro-batch</span>
</span></span><span class="line"><span class="cl">        <span class="n">inputs</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">half_num_chunks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">half_num_chunks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_first_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">input_chunks</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">([],</span> <span class="n">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_last_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">input_chunks</span> <span class="o">=</span> <span class="p">([],</span> <span class="n">inputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥æ˜¯ 8 ä¸ªæ ¸å¿ƒè°ƒåº¦é˜¶æ®µçš„ï¼Œåœ¨æ­¤ä¹‹å‰ä¼šè¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œï¼š</p>
<ul>
<li>çŠ¶æ€é‡ç½®: <code>_reset_states()</code> æ¸…ç©ºä¸Šä¸€è½®è¿­ä»£çš„ç¼“å­˜ï¼Œå¦‚è¾“å…¥/è¾“å‡ºå—ã€æ¢¯åº¦ã€æŸå¤±ç­‰ã€‚</li>
<li>rank ç¡®å®š: è®¡ç®— <code>num_half_ranks</code>ï¼ˆæµæ°´çº¿å¯¹æŠ˜åçš„ä¸€åŠè®¾å¤‡æ•°ï¼‰å’Œ <code>half_rank</code>ï¼ˆå½“å‰ç§©åœ¨å¯¹æŠ˜æµæ°´çº¿ä¸­çš„ä½ç½®. è¿™äº›å˜é‡å°†å†³å®šæ¯ä¸ªé˜¶æ®µçš„å¾ªç¯æ¬¡æ•°ã€‚</li>
<li>æ•°æ®åˆ†å‘: <code>scatter</code> å‡½æ•°å°†è¾“å…¥æ•°æ® inputs å’Œ labels åˆ‡åˆ†æˆ half_num_chunks ä¸ª micro-batch ã€‚æ ¹æ® is_first_rank æˆ– is_last_rankï¼Œå°†è¿™äº› micro-batch å­˜æ”¾åˆ° self.input_chunks å’Œ self.labels ä¸­ã€‚</li>
</ul>
<p>è°ƒåº¦ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²çº¿åˆ†éš”äº†æ¯ä¸ªæ­¥éª¤</p>
<p>
<figure class="post-figure">
    <a href="https://share.note.youdao.com/yws/api/personal/file/WEB6ab2cfcee4bad0937e6f0c4c0d225598?method=download&amp;shareKey=754ad9e0092a41faf2c692912283f5ff" target="_blank" rel="noopener">
        <img loading="lazy" src="https://share.note.youdao.com/yws/api/personal/file/WEB6ab2cfcee4bad0937e6f0c4c0d225598?method=download&amp;shareKey=754ad9e0092a41faf2c692912283f5ff" alt="DualPipe Schedule">
    </a><figcaption>DualPipe Schedule</figcaption></figure></p>
<p><strong>Step 1: Warm-up Forward nF0</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªçº¯å‰å‘è®¡ç®—é˜¶æ®µï¼Œç”¨äºå¡«æ»¡æµæ°´çº¿ã€‚è·ç¦»æµæ°´çº¿ä¸­ç‚¹è¶Šè¿œçš„ rankï¼ˆhalf_rank è¶Šå°ï¼‰æ‰§è¡Œçš„é¢„çƒ­æ­¥éª¤è¶Šå¤šã€‚ <code>_forward_chunk(0)</code> è¢«è°ƒç”¨ï¼Œåœ¨æ­¤å‡½æ•°å†…éƒ¨:</p>
<ol>
<li><code>_recv_forward(0)</code>: å°è¯•æ¥æ”¶å‰ä¸€ä¸ª rank çš„æ•°æ®ã€‚å¯¹äº rank 0 æ¥è¯´ï¼Œå®ƒç›´æ¥ä½¿ç”¨ self.input_chunks çš„æ•°æ®ï¼Œä¸æ¥æ”¶ã€‚</li>
<li><code>_commit_and_wait_comm()</code>: ç­‰å¾…æ•°æ®æ¥æ”¶å®Œæˆã€‚</li>
<li><code>_forward_compute_chunk(0)</code>: æ‰§è¡Œ <code>self.module[0]</code> çš„å‰å‘è®¡ç®—ã€‚</li>
<li><code>_send_forward(0)</code>: å°†è®¡ç®—ç»“æœå¼‚æ­¥åœ°å‘é€ç»™ä¸‹ä¸€ä¸ª rank.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">step_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_half_ranks</span> <span class="o">-</span> <span class="n">half_rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>Step 2: Dual Forward nF0F1</strong></p>
<p>ä¸¤æ¡æµæ°´çº¿éƒ½å¼€å§‹æ‰§è¡Œå‰å‘è®¡ç®—ã€‚ä¸¤æ¡æµæ°´çº¿éƒ½å¼€å§‹å·¥ä½œã€‚å½“å‰ rank ä¸ä»…ç»§ç»­å¤„ç† phase 0 çš„å‰å‘è®¡ç®—ï¼Œä¹Ÿå¼€å§‹å¤„ç†ä»å¦ä¸€ç«¯ï¼ˆphase 1ï¼‰ä¼ æ¥çš„æ•°æ®çš„å‰å‘è®¡ç®—ã€‚</p>
<ul>
<li><code>_forward_chunk(0, recv=False, ...)</code> å¤„ç†ä¸€ä¸ª phase 0 çš„ micro-batch ï¼Œä½†ä¸ç«‹å³æ¥æ”¶ä¸‹ä¸€ä¸ªï¼Œå› ä¸ºå‰é¢å·²ç»è°ƒç”¨äº† <code>_recv_forward(0).</code></li>
<li><code>_forward_chunk(1, ...)</code>: å¤„ç†ä¸€ä¸ª phase 1 çš„ micro-batch ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 2: nF0F1</span>
</span></span><span class="line"><span class="cl"><span class="n">step_2</span> <span class="o">=</span> <span class="n">half_rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">_recv_forward</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">recv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">send</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_middle_rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv_forward</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">send</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_middle_rank</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">step_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_middle_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send_forward</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>Step 3: å‰å‘-åå‘-æƒé‡æ··åˆé˜¶æ®µ (Zero Bubble) nB1W1F1</strong></p>
<p>è¿™æ˜¯ DualPipe æé«˜æ•ˆç‡çš„å…³é”®ã€‚å½“ä¸€æ¡æµæ°´çº¿å¼€å§‹è¿›è¡Œåå‘è®¡ç®—æ—¶ï¼Œå¦ä¸€æ¡æµæ°´çº¿ä»åœ¨è¿›è¡Œå‰å‘è®¡ç®—ã€‚</p>
<ul>
<li><code>_backward_chunk(1, enable_zb=True)</code>: æ‰§è¡Œåå‘è®¡ç®—ï¼Œå¹¶å¯ç”¨ Zero Bubble (ZB) ä¼˜åŒ–ã€‚ZB é€šè¿‡ <code>WeightGradStore</code> å°†æƒé‡æ¢¯åº¦ï¼ˆweight gradientsï¼‰çš„è®¡ç®—ï¼ˆé€šå¸¸åœ¨åå‘ä¼ æ’­ä¸­é˜»å¡ï¼‰ç¼“å­˜èµ·æ¥ï¼Œæ¨è¿Ÿæ‰§è¡Œï¼Œä»è€Œè®©è·¯ç»™å…¶ä»–è®¡ç®—æˆ–é€šä¿¡ã€‚</li>
<li><code>_weight_chunk()</code>: æ‰§è¡Œè¢«æ¨è¿Ÿçš„æƒé‡æ¢¯åº¦è®¡ç®—ã€‚</li>
<li><code>_forward_chunk(1)</code>: åŒæ—¶æ‰§è¡Œå¦ä¸€ä¸ªæ–¹å‘çš„å‰å‘è®¡ç®—ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 3: nB1W1F1 (Use zero bubble)</span>
</span></span><span class="line"><span class="cl"><span class="n">step_3</span> <span class="o">=</span> <span class="n">num_half_ranks</span> <span class="o">-</span> <span class="n">half_rank</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">enable_zb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv_forward</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_weight_chunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">recv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<p><strong>Step 4: Main Steady State nF0B1F1B0</strong></p>
<p>è¿™æ˜¯æµæ°´çº¿å®Œå…¨å¡«æ»¡åçš„ä¸»å¾ªç¯ã€‚åœ¨ä¸€ä¸ªå¾ªç¯è¿­ä»£ä¸­ï¼Œä¸€ä¸ª rank ä¼šæ‰§è¡Œä¸¤æ¬¡è®¡ç®—å’Œé€šä¿¡çš„é‡å æ“ä½œï¼šä¸€æ¬¡æ˜¯ï¼ˆå‰å‘è®¡ç®— + åå‘è®¡ç®—ï¼‰ï¼Œå¦ä¸€æ¬¡ä¹Ÿæ˜¯ï¼ˆå‰å‘è®¡ç®— + åå‘è®¡ç®—ï¼‰. è¿™é‡Œè°ƒç”¨ <code>_forward_backward_chunk(0, 1)</code> å’Œ <code>_forward_backward_chunk(1, 0)</code>. è¿™ä¸ªå‡½æ•°å°è¯•å°†ä¸€ä¸ªæ–¹å‘çš„å‰å‘è®¡ç®—ï¼ˆFï¼‰ä¸å¦ä¸€ä¸ªæ–¹å‘çš„åå‘è®¡ç®—ï¼ˆBï¼‰æ‰“åŒ…åœ¨ä¸€èµ·æ‰§è¡Œï¼Œå®ç° F&amp;B é‡å ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 4 (Main step): nF0B1F1B0</span>
</span></span><span class="line"><span class="cl"><span class="n">step_4</span> <span class="o">=</span> <span class="n">half_num_chunks</span> <span class="o">-</span> <span class="n">num_ranks</span> <span class="o">+</span> <span class="n">half_rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_backward_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># i != 0</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_backward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<p><strong>Step 5 &amp; 6: åå‘-åå‘æ··åˆé˜¶æ®µ (Cooldown Backward) nB1F1B0 å’Œ nB1B0</strong></p>
<p>å½“å‰å‘æ•°æ®æµè€—å°½åï¼Œæµæ°´çº¿è¿›å…¥æ”¶å°¾é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µä¸»è¦æ‰§è¡Œå‰©ä½™çš„åå‘è®¡ç®—ã€‚åŒæ ·ï¼ŒZB ä¼˜åŒ–åœ¨ååŠæ®µè¢«å¯ç”¨ï¼Œä»¥å‡å°‘æ°”æ³¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 5: nB1F1B0</span>
</span></span><span class="line"><span class="cl"><span class="n">step_5</span> <span class="o">=</span> <span class="n">num_half_ranks</span> <span class="o">-</span> <span class="n">half_rank</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_backward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 6: nB1B0 (The second half of the chunks use zero bubble)</span>
</span></span><span class="line"><span class="cl"><span class="n">step_6</span> <span class="o">=</span> <span class="n">half_rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">enable_zb</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">step_6</span> <span class="o">//</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">half_rank</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">enable_zb</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">enable_zb</span><span class="o">=</span><span class="n">enable_zb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">step_6</span> <span class="o">//</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">half_rank</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">enable_zb</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">enable_zb</span><span class="o">=</span><span class="n">enable_zb</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<p><strong>Step 7 &amp; 8: æƒé‡æ›´æ–°æ”¶å°¾é˜¶æ®µ nWB0 å’Œ nW</strong></p>
<ul>
<li>Step 7 å°†æœ€åçš„åå‘è®¡ç®—ä¸æƒé‡è®¡ç®—é‡å ã€‚</li>
<li>Step 8 æ˜¯çº¯ç²¹çš„æƒé‡è®¡ç®—é˜¶æ®µï¼Œå¾ªç¯è°ƒç”¨ _weight_chunk() ç›´åˆ° WeightGradStore.funcs_queue é˜Ÿåˆ—ä¸ºç©ºï¼Œç¡®ä¿æ‰€æœ‰æ¢¯åº¦éƒ½å·²è®¡ç®—å®Œæ¯•ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Step 7: nWB0 (Use zero bubble)</span>
</span></span><span class="line"><span class="cl"><span class="n">step_7</span> <span class="o">=</span> <span class="n">num_half_ranks</span> <span class="o">-</span> <span class="n">half_rank</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_weight_chunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_backward_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">enable_zb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Step 8: nW</span>
</span></span><span class="line"><span class="cl"><span class="n">step_8</span> <span class="o">=</span> <span class="n">half_rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_weight_chunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">WeightGradStore</span><span class="o">.</span><span class="n">funcs_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="computation-communication-overlap">Computation-Communication Overlap<a hidden class="anchor" aria-hidden="true" href="#computation-communication-overlap">#</a></h2>
<p><code>_forward_backward_compute_chunk</code> å‡½æ•°æ˜¯å®ç°è®¡ç®—é‡å çš„å…³é”®ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ˆå¦‚æœæ¨¡å‹ç»“æ„æ”¯æŒï¼‰ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ª micro-batch çš„å‰å‘è®¡ç®—å’Œå¦ä¸€ä¸ª micro-batch çš„åå‘è®¡ç®—åœ¨åŒä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸­å®Œæˆã€‚è¯¥å‡½æ•°åœ¨ step4 ä½¿ç”¨çš„<code>_forward_backward_chunk</code> å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_forward_backward_compute_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">phase1</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlapped_forward_backward</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_compute_chunk</span><span class="p">(</span><span class="n">phase0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_backward_compute_chunk</span><span class="p">(</span><span class="n">phase1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># forward &amp; backward</span>
</span></span><span class="line"><span class="cl">    <span class="n">outputs0</span><span class="p">,</span> <span class="n">loss0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">module0</span><span class="p">)</span><span class="o">.</span><span class="n">overlapped_forward_backward</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">module0</span><span class="p">,</span> <span class="n">inputs0</span><span class="p">,</span> <span class="n">criterion0</span><span class="p">,</span> <span class="n">labels0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">module1</span><span class="p">,</span> <span class="n">loss1</span><span class="p">,</span> <span class="n">outputs1</span><span class="p">,</span> <span class="n">output_grads1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ¨¡å‹å®šä¹‰äº†ä¸€ä¸ª <code>overlapped_forward_backward</code> (@classmethod)ï¼ŒDualPipe å°±ä¼šè°ƒç”¨å®ƒã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œå¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰å‰å‘å’Œåå‘è®¡ç®—çš„äº¤é”™æ‰§è¡Œé¡ºåºï¼Œä»¥è¾¾åˆ°æœ€ä½³çš„é‡å æ•ˆæœã€‚DeepSeek-v3 çš„é‡å æ–¹æ³•åœ¨æŠ€æœ¯æŠ¥å‘Šé‡Œå·²ç»è®²è§£ã€‚</p>
<h1 id="real-case">Real Case<a hidden class="anchor" aria-hidden="true" href="#real-case">#</a></h1>
<p>é€šè¿‡ <code>examples/example_dualpipe.py </code>ä¸­çš„ main å‡½æ•°æ¥è¯¦ç»†è®²è§£ä¸€ä¸ªå®Œæ•´çš„ DualPipe æµç¨‹ã€‚</p>
<ol>
<li>ç¯å¢ƒåˆå§‹åŒ–å’Œé…ç½®</li>
</ol>
<ul>
<li>åˆ†å¸ƒå¼è®¾ç½®: main å‡½æ•°é¦–å…ˆåˆå§‹åŒ– PyTorch çš„åˆ†å¸ƒå¼é€šä¿¡ç»„ï¼ˆinit_process_groupï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªè¿›ç¨‹ï¼ˆrankï¼‰åˆ†é…ä¸€ä¸ª GPU.</li>
<li>å‚æ•°é…ç½®: å®šä¹‰äº† micro-batch æ•°é‡ (num_chunks)ã€æ¯ä¸ª micro-batch çš„å¤§å° (micro_batch_size) ç­‰è¶…å‚æ•°ã€‚</li>
<li>P2Pé€šä¿¡è®¾ç½®: åœ¨æ‰§è¡Œ DualPipe çš„ step æ–¹æ³•å‰ï¼Œå¿…é¡»è°ƒç”¨ <code>set_p2p_tensor_shapes</code> å’Œ <code>set_p2p_tensor_dtype</code> æ¥å‘ŠçŸ¥ DualPipe åœ¨æµæ°´çº¿ä¸­ä¼ é€’çš„å¼ é‡çš„å½¢çŠ¶å’Œæ•°æ®ç±»å‹ã€‚è¿™æ˜¯å› ä¸º DualPipe éœ€è¦é¢„å…ˆåˆ†é…å†…å­˜æ¥æ¥æ”¶æ¥è‡ªå…¶ä»– rank çš„æ•°æ®ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">pp_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆ¤æ–­å½“å‰è¿›ç¨‹çš„è§’è‰²</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_first_rank</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_last_rank</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">pp_size</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ</span>
</span></span><span class="line"><span class="cl">    <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;nccl&#39;</span><span class="p">,</span> <span class="n">init_method</span><span class="o">=</span><span class="s2">&#34;env://&#34;</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">pp_size</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">torch</span><span class="o">.</span><span class="n">set_default_device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;cuda:</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">233</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;CUBLAS_WORKSPACE_CONFIG&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;:4096:8&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># å®šä¹‰æµæ°´çº¿å‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_chunks</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">    <span class="n">micro_batch_size</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">512</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_first_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">pp_size</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_chunks</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">seq_len</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">hidden_size</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è®¾ç½®P2Pé€šä¿¡çš„Tensorå½¢çŠ¶å’Œç±»å‹</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_p2p_tensor_shapes</span><span class="p">([(</span><span class="n">micro_batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_p2p_tensor_dtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>æ¨¡å‹å’Œå‚è€ƒåŸºå‡†çš„åˆ›å»º</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ã€æœªåˆ†å‰²çš„æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="n">full_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">PipelineStage</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pp_size</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºå®Œæ•´çš„è¾“å…¥æ•°æ®</span>
</span></span><span class="line"><span class="cl"><span class="n">full_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_chunks</span> <span class="o">*</span> <span class="n">micro_batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">full_l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_chunks</span> <span class="o">*</span> <span class="n">micro_batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å‚è€ƒæ­¥éª¤ï¼šåœ¨ä¸€ä¸ªGPUä¸Šï¼Œç”¨æ ‡å‡†çš„æ•°æ®å¹¶è¡Œæ–¹å¼è¿è¡Œå®Œæ•´æ¨¡å‹ï¼Œå¾—åˆ°åŸºå‡†ç»“æœ</span>
</span></span><span class="line"><span class="cl"><span class="n">loss_ref</span><span class="p">,</span> <span class="n">output_ref</span> <span class="o">=</span> <span class="n">ref_step</span><span class="p">(</span><span class="n">full_x</span><span class="p">,</span> <span class="n">full_l</span><span class="p">,</span> <span class="n">full_modules</span><span class="p">,</span> <span class="n">num_chunks</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åˆ›å»ºæ¨¡å‹: ä»£ç é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ <code>nn.Sequential</code> æ¨¡å‹ (full_modules)ï¼Œå®ƒåŒ…å«äº†æµæ°´çº¿æ‰€æœ‰çš„é˜¶æ®µã€‚</li>
<li>å‚è€ƒæ­¥éª¤ (ref_step): ä¸ºäº†éªŒè¯ DualPipe çš„æ­£ç¡®æ€§ï¼Œ<code>ref_step</code> å‡½æ•°æ¨¡æ‹Ÿäº†æ ‡å‡†çš„ã€éæµæ°´çº¿å¹¶è¡Œçš„è®­ç»ƒè¿‡ç¨‹ã€‚å®ƒå°†æ•°æ®åˆ†å—ï¼Œä¾æ¬¡é€šè¿‡å®Œæ•´æ¨¡å‹è®¡ç®—æŸå¤±å’Œè¾“å‡ºã€‚<code>loss_ref</code> å’Œ <code>output_ref</code> å°†ä½œä¸ºåç»­æ¯”è¾ƒçš„æ­£ç¡®ç­”æ¡ˆã€‚</li>
</ul>
<ol start="3">
<li>DualPipeæ¨¡å‹çš„åˆ›å»ºå’Œè¾“å…¥å‡†å¤‡</li>
</ol>
<ul>
<li>æ¨¡å‹åˆ†å‰²: æ¯ä¸ª rank r ä¼šæŒæœ‰ä¸¤ä¸ª PipelineStage: ä¸€ä¸ªæ˜¯ <code>full_modules[r]</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>full_modules[pp_size - 1 - r]</code>. è¿™å°±æ˜¯ Dual (åŒå‘) çš„ä½“ç°ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ª 4-GPU çš„è®¾ç½®ä¸­ï¼š
<ul>
<li>Rank 0 æŒæœ‰ stage 0 å’Œ stage 3 çš„æ¨¡å‹ã€‚</li>
<li>Rank 1 æŒæœ‰ stage 1 å’Œ stage 2 çš„æ¨¡å‹ã€‚</li>
<li>Rank 2 æŒæœ‰ stage 2 å’Œ stage 1 çš„æ¨¡å‹ã€‚</li>
<li>Rank 3 æŒæœ‰ stage 3 å’Œ stage 0 çš„æ¨¡å‹ã€‚</li>
</ul>
</li>
<li>è¾“å…¥æ•°æ®åˆ†å‰²: DualPipe æœ‰ä¸¤ä¸ªæ•°æ®å…¥å£ç‚¹ï¼šrank 0 å’Œæœ€åä¸€ä¸ª rank.
<ul>
<li>rank 0 æ¥æ”¶å‰åŠéƒ¨åˆ†çš„è¾“å…¥ (<code>full_x.chunk(2)[0]</code>) å’Œ ååŠéƒ¨åˆ† çš„æ ‡ç­¾ (<code>full_l.chunk(2)[1]</code>).</li>
<li>last rank æ¥æ”¶ååŠéƒ¨åˆ†çš„è¾“å…¥ (<code>full_x.chunk(2)[1]</code>) å’Œ å‰åŠéƒ¨åˆ† çš„æ ‡ç­¾ (<code>full_l.chunk(2)[0]</code>).</li>
</ul>
</li>
</ul>
<p>ä¸€å…±æœ‰ä¸¤ä¸ªæ•°æ®æµ: ä¸€ä¸ªä» rank 0 å¼€å§‹ï¼Œå…¶å¯¹åº”çš„æ ‡ç­¾åœ¨æœ€åä¸€ä¸ª rankï¼›å¦ä¸€ä¸ªä»æœ€åä¸€ä¸ª rank å¼€å§‹ï¼Œå…¶å¯¹åº”çš„æ ‡ç­¾åœ¨ rank 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># DualPipe æ¨¡å‹åˆ›å»º</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ¯ä¸ª rank è·å–ä¸¤ä¸ªå¤„äºå¯¹ç§°ä½ç½®çš„æ¨¡å‹å—</span>
</span></span><span class="line"><span class="cl"><span class="n">local_full_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">full_modules</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">full_modules</span><span class="p">[</span><span class="n">pp_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rank</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">local_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">),</span> <span class="n">PipelineStage</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... åŠ è½½æƒé‡ ...</span>
</span></span><span class="line"><span class="cl"><span class="n">dualpipe_model</span> <span class="o">=</span> <span class="n">DualPipe</span><span class="p">(</span><span class="n">local_modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># DualPipeè¾“å…¥æ•°æ®å‡†å¤‡</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">is_first_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">full_x</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="n">full_l</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="n">is_last_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">full_x</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="n">full_l</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>æ‰§è¡Œè®­ç»ƒæ­¥éª¤</li>
</ol>
<p>è°ƒç”¨ <code>dualpipe_model.step</code>ï¼Œè§¦å‘äº†å‰é¢è®²è§£ä¸­æåˆ°çš„å¤æ‚çš„8é˜¶æ®µè°ƒåº¦æµç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">loss</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">dualpipe_model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_chunks</span><span class="o">=</span><span class="n">num_chunks</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="n">l</span><span class="p">,),</span> <span class="n">return_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></div><ol start="5">
<li>ç»“æœéªŒè¯</li>
</ol>
<p>æ£€æŸ¥æŸå¤±</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">is_first_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">loss_ref</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="n">is_last_rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">loss_ref</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">loss</span> <span class="ow">is</span> <span class="kc">None</span>
</span></span></code></pre></div><p>è®­ç»ƒæ­¥éª¤å®Œæˆåï¼Œstep æ–¹æ³•ä¼šè¿”å›è®¡ç®—å‡ºçš„æŸå¤±ã€‚</p>
<ul>
<li>rank0 è®¡ç®—å‡ºçš„ loss å¯¹åº”çš„æ˜¯ä» last rank è¾“å…¥çš„æ•°æ®æµï¼Œç­‰äºå‚è€ƒæŸå¤±çš„ååŠéƒ¨åˆ† (<code>loss_ref.chunk(2)[1]</code>).</li>
<li>åŒç†ï¼Œlast rank è®¡ç®—å‡ºçš„ loss å¯¹åº”çš„æ˜¯ä» rank0 è¾“å…¥çš„æ•°æ®æµï¼Œç­‰äºå‚è€ƒæŸå¤±çš„å‰åŠéƒ¨åˆ† (<code>loss_ref.chunk(2)[0]</code>).</li>
<li>ä¸­é—´çš„ ranks ä¸è®¡ç®—æœ€ç»ˆæŸå¤±ï¼Œè¿”å› None.</li>
</ul>
<p>æ£€æŸ¥æ¢¯åº¦</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">local_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">dist</span><span class="o">.</span><span class="n">all_gather_into_tensor</span><span class="p">(</span><span class="n">p0all</span><span class="p">,</span> <span class="n">p0</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dist</span><span class="o">.</span><span class="n">all_gather_into_tensor</span><span class="p">(</span><span class="n">p1all</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ‰‹åŠ¨èšåˆå¯¹ç§°rankçš„æ¢¯åº¦</span>
</span></span><span class="line"><span class="cl">    <span class="n">p0</span><span class="o">.</span><span class="n">grad</span> <span class="o">+=</span> <span class="n">p1all</span><span class="p">[</span><span class="n">pp_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">p1</span><span class="o">.</span><span class="n">grad</span> <span class="o">+=</span> <span class="n">p0all</span><span class="p">[</span><span class="n">pp_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">p_ref</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_modules</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(),</span> <span class="n">local_full_modules</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">cal_diff</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">p_ref</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-13</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äºæ¯ä¸ª rank r æŒæœ‰ r å’Œ <code>pp_size - 1 - r</code> ä¸¤ä¸ªé˜¶æ®µçš„æ¨¡å‹ï¼Œå¦‚æœè¿™ä¸¤ä¸ªé˜¶æ®µåœ¨é€»è¾‘ä¸Šæ˜¯åŒä¸€ä¸ªæƒé‡ï¼ˆä¾‹å¦‚ï¼Œåœ¨Encoder-Decoderç»“æ„ä¸­å…±äº«æƒé‡ï¼‰ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ¢¯åº¦éœ€è¦æ‰‹åŠ¨èšåˆã€‚ç¤ºä¾‹é€šè¿‡ <code>dist.all_gather_into_tensor</code> æ”¶é›†æ‰€æœ‰ rank ä¸Šå¯¹ç§°æ¨¡å—çš„æ¢¯åº¦ï¼Œç„¶åæ‰‹åŠ¨å°†å®ƒä»¬ç›¸åŠ ã€‚æœ€åï¼Œå°†èšåˆåçš„æ¢¯åº¦ä¸ ref_step ä¸­è®¡ç®—å‡ºçš„å‚è€ƒæ¢¯åº¦è¿›è¡Œæ¯”è¾ƒï¼ŒéªŒè¯åå‘ä¼ æ’­çš„æ­£ç¡®æ€§ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/deepseek/">DeepSeek</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/blogs/deepseek/deepseek-v3technicalreport/">
    <span class="title">Next Â»</span>
    <br>
    <span>DeepSeek-V3 Technical Report</span>
  </a>
</nav>

  </footer><script src="https://giscus.app/client.js"
        data-repo="jamesnulliu/jamesnulliu.github.io"
        data-repo-id="R_kgDOMPCQIw"
        data-category="Announcements"
        data-category-id="DIC_kwDOMPCQI84Cgb2t"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>Â© 2024-2025 WITHER</span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
