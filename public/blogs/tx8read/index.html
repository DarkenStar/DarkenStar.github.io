<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tx8read | WITHER</title>
<meta name="keywords" content="bsh">
<meta name="description" content="tx8 regression">
<meta name="author" content="WITHER">
<link rel="canonical" href="http://localhost:1313/blogs/tx8read/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.dd3b5b907a50db3238b81d49d094cf1c04a091227797dc9cfde4e2fa3f35df49.css" integrity="sha256-3TtbkHpQ2zI4uB1J0JTPHASgkSJ3l9yc/eTi&#43;j8130k=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blogs/tx8read/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    }
  };
</script>




<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.1.6/mermaid.min.js"></script>
<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: localStorage.getItem("pref-theme") === "dark" ? "dark" : "forest" 
    });
</script>

<meta property="og:url" content="http://localhost:1313/blogs/tx8read/">
  <meta property="og:site_name" content="WITHER">
  <meta property="og:title" content="Tx8read">
  <meta property="og:description" content="tx8 regression">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blogs">
    <meta property="article:published_time" content="2025-06-11T10:21:42+08:00">
    <meta property="article:modified_time" content="2025-06-13T15:12:24+08:00">
    <meta property="article:tag" content="Tx8-Script">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tx8read">
<meta name="twitter:description" content="tx8 regression">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "http://localhost:1313/blogs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tx8read",
      "item": "http://localhost:1313/blogs/tx8read/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tx8read",
  "name": "Tx8read",
  "description": "tx8 regression",
  "keywords": [
    "bsh"
  ],
  "articleBody": "TestGraphCompute 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 int main(int argc, char **argv) { // 1. åˆå§‹åŒ–ä¸å‘½ä»¤è¡Œå‚æ•°å¤„ç† Timer timer(\"TestGraphCompute\"); mlir::registerAsmPrinterCLOptions(); mlir::registerMLIRContextCLOptions(); mlir::registerPassManagerCLOptions(); // è§£æå‘½ä»¤è¡Œå‚æ•° cl::ParseCommandLineOptions(argc, argv, \"tx8be compiler\\n\"); // 2. åˆå§‹åŒ– MLIR æ¨¡å—å’Œä¸Šä¸‹æ–‡ mlir::OwningOpRef\u003cmlir::ModuleOp\u003e module; mlir::MLIRContext context; // å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºä»å‘½ä»¤è¡Œé€‰é¡¹ä¸­æå– codegen_path å‚æ•° std::regex pattern(\"codegen_path=([a-zA-Z0-9_]+)\"); std::smatch matches; std::string cachePath = \"codegen\"; // é»˜è®¤æ–‡ä»¶å¤¹åå­— if (std::regex_search(optionstr, matches, pattern)) { // å¯»æ‰¾å‘½ä»¤è¡Œé€‰é¡¹ä¸­æ˜¯å¦æŒ‡å®š codegen_path cachePath = matches[1]; // 3. åŠ è½½ MLIR æ¨¡å— // å¦‚æœ cache ä¸º 2 æˆ– 4ï¼Œåˆ™ä»ç¼“å­˜è·¯å¾„åŠ è½½æ¨¡å—ï¼›å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ gModelFil gModelFile = (cache == 2 || cache == 4) ? cachePath + \"/cache.mlir\" : gModelFile; if (int error = getMLIRFromFile(module, context, gModelFile)) { return error; } // 4. é…ç½®æ¨¡å— auto mconfig = getModuleConfig(module.get()); if (optionstr.size() \u003e 0) { mconfig.option += optionstr; } mconfig.constCache = cache; updateModuleConfig(module, context, mconfig); mconfig = getModuleConfig(module.get()); showModuleConfig(mconfig); // 5. å¤„ç†å¤šå¡ä¿¡æ¯ json_info_multi_card_t *multi_card_jinfo = nullptr; multi_card_jinfo = (cache == 2 || cache == 4) ? get_multi_card_info_from_file(cachePath + \"/model_info.json\") : parseMultiCardModuleInfo(module, context); if (0) { dumpIR(module.get(), true); } // 6. è¯»å–å‚è€ƒè·¯å¾„ if (!fast_codegen) { // NOT fast_codegen std::vector\u003cstd::string\u003e in_files = parseStringArgs(gInputBin, std::string(\",\")); std::vector\u003cstd::string\u003e out_files = parseStringArgs(gOutputBin, std::string(\",\")); // å®šä¹‰ä¸€ä¸ª lambda å‡½æ•°ï¼Œç”¨äºä»æ–‡ä»¶ä¸­è¯»å–å‚è€ƒæ–‡ä»¶è·¯å¾„ã€‚ auto getRefFiles = [] (std::string gFile, std::vector\u003cstd::string\u003e \u0026files) { if (gFile.size() == 0) { return 0; } if (!llvm::sys::fs::exists(gFile)) { return 0; } std::ifstream gf(gFile); std::string text((std::istreambuf_iterator\u003cchar\u003e(gf)), (std::istreambuf_iterator\u003cchar\u003e())); files = parseStringArgs(text, std::string(\",\")); return 0; }; if ((gInputBin.size() == 0) \u0026\u0026 (gInputFile.size() != 0)) { getRefFiles(gInputFile, in_files); getRefFiles(gOutputFile, out_files); } } // 7. computeGolden if (cache \u003c 2) { for (int32_t i = 0; i \u003c mconfig.tile.chip_num; i++) { // éå†èŠ¯ç‰‡æ•°é‡ï¼Œåˆ›å»ºå¯¹åº”çš„ç›®å½•ç»“æ„ // æ„é€ å¹¶åˆ›å»ºåˆ›å»ºç›® codegen/node_0_0/chip0/agent/data std::string path = \"codegen/node_0_0/chip\"; path += std::to_string(i) + \"/agent/data\"; createDir(path); } // è°ƒç”¨ computeGolden å‡½æ•°ï¼Œè®¡ç®—å‚è€ƒè¾“å‡ºä¿å­˜åˆ° codegenPath computeGolden(module, multi_card_jinfo, in_files, out_files, mconfig.codegenPath); } // è°ƒç”¨ moduleCompileCodegen å‡½æ•°ï¼Œå¯¹ MLIR æ¨¡å—è¿›è¡Œç¼–è¯‘å’Œä»£ç ç”Ÿæˆ int32_t ret = moduleCompileCodegen(module, context); ASSERT(ret == true); // 9. è·å–å†…å­˜å¤§å° // ä»æ¨¡å—ä¸­è·å–ç«‹å³æ•° (Immediate) å’Œå¸¸é‡å‚æ•°çš„ DDR å¤§å° uint64_t imm_size = module.get()-\u003ehasAttr(tx8be::ModuleAttr::ImmDdrSize) ? module.get()-\u003egetAttrOfType\u003cmlir::IntegerAttr\u003e(tx8be::ModuleAttr::ImmDdrSize).getInt() : 2147483648; uint64_t params_size = module.get()-\u003ehasAttr(tx8be::ModuleAttr::ConstDdrSize) ? module.get()-\u003egetAttrOfType\u003cmlir::IntegerAttr\u003e(tx8be::ModuleAttr::ConstDdrSize).getInt() : 0; // 10. æ›´æ–°æ¯ä¸ªèŠ¯ç‰‡çš„å†…å­˜å¤§å°ä¿¡æ¯ for (int32_t i = 0; i \u003c mconfig.tile.chip_num; i++) { multi_card_jinfo-\u003echip_infos[i]-\u003eimm_size = imm_size; multi_card_jinfo-\u003echip_infos[i]-\u003eparams_size.emplace_back(params_size); } // 11. ä¿å­˜å¤šå¡æ¨¡å‹ä¿¡æ¯ std::vector\u003cint32_t\u003e chipIds; if (module.get()-\u003ehasAttr(tx8be::ModuleAttr::ChipIds)) { // è·å–èŠ¯ç‰‡ ID mlir::ArrayAttr chipIdsAttr = module.get()-\u003egetAttrOfType\u003cmlir::ArrayAttr\u003e(tx8be::ModuleAttr::ChipIds); for (int i = 0; i \u003c chipIdsAttr.size(); i++) { chipIds.push_back(chipIdsAttr[i].cast\u003cmlir::IntegerAttr\u003e().getInt()); } } // å¤šå¡æ¨¡å‹æ–‡ä»¶ä¿å­˜åˆ° codegenPath è·¯å¾„ä¸‹ saveMultiCardModelJson(multi_card_jinfo, mconfig.codegenPath, chipIds); // uint64_t ddrSize = getModelDDRSize(multi_card_jinfo); return 0; } } computeGolden è¾“å…¥å‚æ•°çš„æ¥æºï¼š\nmoduleï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ getMLIRFromFile å‡½æ•°ä»æ–‡ä»¶ä¸­åŠ è½½ MLIR æ¨¡å— multi_card_jinfoï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ get_multi_card_info_from_file æˆ– parseMultiCardModuleInfo ä» JSON æ–‡ä»¶æˆ– MLIR æ¨¡å—ä¸­æå–å¤šå¡ä¿¡æ¯ã€‚ in_files å’Œ out_filesï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ parseStringArgs æˆ– getRefFiles è§£æè¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„ã€‚ mconfig.codegenPathï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹æˆ–é»˜è®¤å€¼è®¾ç½®ä»£ç ç”Ÿæˆè·¯å¾„ï¼Œå¹¶ä¼ é€’ç»™ computeGoldenã€‚ computeGolden å‡½æ•°ç”Ÿæˆçš„æ•°æ®ï¼ˆè¾“å…¥å’Œè¾“å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰å°†ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„ mconfig.codegenPath.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 void computeGolden(mlir::OwningOpRef\u003cmlir::ModuleOp\u003e \u0026module, json_info_multi_card_t *multi_card_jinfo, std::vector\u003cstd::string\u003e \u0026inFiles, std::vector\u003cstd::string\u003e \u0026outFiles, std::string file_path) { // å®šä¹‰å½¢çŠ¶ç±»å‹ï¼Œç”¨äºå­˜å‚¨å¤šç»´å¼ é‡çš„å½¢çŠ¶ä¿¡æ¯ using ShapeType = std::vector\u003cstd::vector\u003cint64_t\u003e\u003e; // ç”¨äºå­˜å‚¨å¤šèŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ® std::vector\u003cstd::vector\u003cint8_t *\u003e\u003e multiInputDdata; std::vector\u003cstd::vector\u003cint8_t *\u003e\u003e multiOutputData; std::vector\u003cstd::thread\u003e threads; uint32_t chip_num = multi_card_jinfo-\u003echip_num; // è·å–èŠ¯ç‰‡æ•°é‡ auto tile_info = get_tileinfo(module.get()); // ä» MLIR æ¨¡å—ä¸­æå– tile ä¿¡æ¯ std::vector\u003cShapeType\u003e outShapes(chip_num); // å­˜å‚¨æ¯ä¸ªèŠ¯ç‰‡çš„è¾“å‡ºå½¢çŠ¶ä¿¡æ¯ for (int i = 0; i \u003c chip_num; i++) { chip_info_t *chip_info = multi_card_jinfo-\u003echip_infos[i]; // åˆ†é…å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®æŒ‡é’ˆæ•°ç»„ std::vector\u003cint8_t *\u003e input_data(chip_info-\u003einput_num); std::vector\u003cint8_t *\u003e output_data(chip_info-\u003eoutput_num); // ç”¨äº OneDNN è®¡ç®—çš„è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒº std::vector\u003cchar *\u003e computeInputs; std::vector\u003cchar *\u003e computeOutputs; // å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„ std::vector\u003cstd::string\u003e chipInFiles; std::vector\u003cstd::string\u003e chipOutFiles; parseInOutfile(inFiles, chipInFiles, i, chip_num, chip_info-\u003einput_num); parseInOutfile(outFiles, chipOutFiles, i, chip_num, chip_info-\u003eoutput_num); // ç”Ÿæˆå½“å‰èŠ¯ç‰‡çš„è¾“å…¥è¾“å‡ºæ•°æ® genInputs4SingleChip(computeInputs, input_data, chip_info, chipInFiles); genOutputs4SingleChip(computeOutputs, output_data, chip_info, chipOutFiles); // å¦‚æœè¾“å…¥æ–‡ä»¶ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®å¹¶æ ¡æ­£ if (chipInFiles.size() == 0) { updateSpecialInputData(computeModuleRef, computeInputs, input_data, chip_info); } multiInputDdata.push_back(input_data); multiOutputData.push_back(output_data); if (outFiles.size() == 0) { threads.emplace_back(moduleComputeInterface, std::ref(computeModuleRef), std::ref(outShapes[i]), computeInputs, computeOutputs, i); } } // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆè®¡ç®— for (auto \u0026thread : threads) { thread.join(); } // éå†æ¯ä¸ªèŠ¯ç‰‡ï¼Œä¿å­˜è¾“å…¥å’Œè¾“å‡ºæ•°æ® for (int32_t i = 0; i \u003c chip_num; i++) { chip_info_t *chip_info = multi_card_jinfo-\u003echip_infos[i]; uint32_t node_id = get_node_id(i, tile_info); int32_t relative_chip_id = get_relative_chip_id(i, tile_info); // æ„é€ å½“å‰èŠ¯ç‰‡çš„æ•°æ®ä¿å­˜è·¯å¾„ file_path/node_x_y/chip_z/agent/data std::string data_path = file_path + \"/node_\" + std::to_string(node_id / tile_info.node_y) + \"_\" + std::to_string(node_id % tile_info.node_y) + \"/chip\" + std::to_string(relative_chip_id) + \"/agent/data\"; createDir(data_path); // binæ ¼å¼ä¿å­˜å½“å‰èŠ¯ç‰‡çš„è¾“å…¥æ•°æ® for (uint32_t j = 0; j \u003c chip_info-\u003einput_num; j++) { inout_tensor_info_t *tensor = chip_info-\u003einput[j]; saveInOutTensor(tensor-\u003eshape, tensor-\u003edim, tensor-\u003elayout, tensor-\u003edtype, data_path + \"/in\" + std::to_string(j) + \".bin\", multiInputDdata[i][j]); } // binæ ¼å¼ä¿å­˜å½“å‰èŠ¯ç‰‡çš„è¾“å‡ºæ•°æ® out_j_ref.bin for (uint32_t j = 0; j \u003c chip_info-\u003eoutput_num; j++) { inout_tensor_info_t *tensor = chip_info-\u003eoutput[j]; int32_t tensorShape[MAX_SHAPE_DIM]; // æ ¹æ® outShapes æˆ–åŸå§‹å½¢çŠ¶è®¡ç®—è¾“å‡ºå¼ é‡çš„å½¢çŠ¶ for (int idx = 0; idx \u003c tensor-\u003edim; ++idx) { if (!outShapes[i].empty()) { tensorShape[idx] = outShapes[i][j][idx]; } else { tensorShape[idx] = tensor-\u003eshape[idx]; } } // ä¿å­˜è¾“å‡ºæ•°æ® saveInOutTensor(tensorShape, tensor-\u003edim, tensor-\u003elayout, tensor-\u003edtype, data_path + \"/out\" + std::to_string(j) + \"_ref.bin\", multiOutputData[i][j]); } // é‡Šæ”¾å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®å†…å­˜ for (uint32_t j = 0; j \u003c chip_info-\u003einput_num; j++) { free(multiInputDdata[i][j]); } for (uint32_t j = 0; j \u003c chip_info-\u003eoutput_num; j++) { free(multiOutputData[i][j]); } } } run_code_gen_layer ä¸»è¦ç”¨äºè¿è¡Œä»£ç ç”Ÿæˆ (codegen) ç›¸å…³çš„ä»»åŠ¡ï¼Œä»¥ä¸‹æ˜¯å‡½æ•°çš„è¯¦ç»†åŠŸèƒ½è§£é‡Šï¼š\nè§£æå‚æ•°ï¼š æ¥å—è‡³å°‘ä¸¤ä¸ªå‚æ•°ï¼š$1 æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ï¼Œ$2 æ˜¯ç§å­æ–‡ä»¶ (seed file) å¦‚æœæœ‰æ›´å¤šå‚æ•° ($# \u003e 2)ï¼Œåˆ™å°†é¢å¤–å‚æ•°å­˜å‚¨ä¸ºé…ç½®å‚æ•° (config_params) ä» config_params ä¸­æå– codegen_path (ä»£ç ç”Ÿæˆè¾“å‡ºè·¯å¾„) ï¼Œå¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤å€¼ â€œcodegenâ€ åˆ‡æ¢å·¥ä½œç›®å½•ï¼š åˆ‡æ¢åˆ° ${BEMLIR_PROJECT_ROOT}/build/bin ç›®å½•ã€‚ åˆ é™¤æ—§çš„ codegen_path ç›®å½•ï¼Œç¡®ä¿ç¯å¢ƒå¹²å‡€ã€‚ æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼š ä½¿ç”¨ ${layer_cmd} (å³ ./$1) è¿è¡ŒæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¼ å…¥ç§å­æ–‡ä»¶å’Œé…ç½®å‚æ•°ã€‚ æ£€æŸ¥è¿”å›å€¼ï¼Œå¦‚æœå¤±è´¥ (ret != 0)ï¼Œåˆ™æ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯ã€‚ å¤„ç†ç”Ÿæˆçš„ä»£ç ï¼š æ ¹æ®å‚æ•°ä¸­çš„ chip_num æˆ– static_shape åˆ¤æ–­ host_type. è°ƒç”¨ get_codegen_file å¤„ç†ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ã€‚ è¿è¡Œ cmodel æµ‹è¯•: æ ¹æ®å‚æ•°ä¸­çš„ fast_codegen æˆ– not_run è®¾ç½® cmp_flag. è°ƒç”¨ run_on_cmodel åœ¨ cmodel ä¸Šè¿è¡Œç”Ÿæˆçš„ä»£ç ã€‚ æ£€æŸ¥è¿”å›å€¼ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ã€‚ # å®šä¹‰ run_codegen_layer å‡½æ•°ï¼Œç”¨äºè¿è¡Œä»£ç ç”Ÿæˆå±‚æµ‹è¯•æµç¨‹ function run_codegen_layer() { # 1. æ‰“å°å¼€å§‹æ—¶é—´ï¼Œç”¨äºè°ƒè¯•å’Œæ€§èƒ½è¿½è¸ª echo -n \"time==\u003e\u003erun_codegen_layer-start \"; date; # 2. å‡½æ•°å‚æ•°è¯´æ˜ # $1: å¯æ‰§è¡Œæ–‡ä»¶åç§° # $2: ç§å­æ–‡ä»¶ (seed fileï¼‰ layer_cmd=\"./$1\" # åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ seed_file=$2 # ç§å­æ–‡ä»¶æˆ–é…ç½®æ–‡ä»¶ config_params=\"\" # é…ç½®å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º # é»˜è®¤ä»£ç ç”Ÿæˆè¾“å‡ºè·¯å¾„ codegen_path=\"codegen\" # 3. æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡2ä¸ªå‚æ•° if [ $# -gt 2 ]; then # æå–é™¤å‰ä¸¤ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°ä½œä¸ºé…ç½®å‚æ•° config_params=$* config_params=${config_params#*} # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•° (å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ config_params=${config_params#*} # ç§»é™¤ç¬¬äºŒä¸ªå‚æ•° (ç§å­æ–‡ä»¶ï¼‰ fi # 4. å¦‚æœé…ç½®å‚æ•°ä¸­åŒ…å« --codegen_pathï¼Œæå–å…¶å€¼ä½œä¸ºä»£ç ç”Ÿæˆè·¯å¾„ if [[ ${config_params} == *\"--codegen_path=\"* ]]; then # æå– --codegen_path= åé¢çš„å€¼ codegen_path=${config_params#*codegen_path=} # ç§»é™¤å¯èƒ½å­˜åœ¨çš„å¼•å·æˆ–å…¶ä»–å­—ç¬¦ codegen_path=${codegen_path%%\\\"*} codegen_path=${codegen_path-*} codegen_path=${codegen_path*} fi # 5. åˆ‡æ¢åˆ° build/bin ç›®å½•æ‰§è¡Œå‘½ä»¤ pushd ${BEMLIR_PROJECT_ROOT}/build/bin # åˆ é™¤æ—§çš„ codegen_path ç›®å½•ï¼Œç¡®ä¿ç¯å¢ƒå¹²å‡€ rm -rf ${codegen_path} # æ‰§è¡Œå±‚å‘½ä»¤ï¼Œä¼ å…¥ç§å­æ–‡ä»¶å’Œé…ç½®å‚æ•° ${layer_cmd} ${seed_file} ${config_params} # æ•è·å‘½ä»¤çš„è¿”å›å€¼ ret=$? # å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥ (è¿”å›ç é0ï¼‰ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯ if [[ ${ret} -ne 0 ]]; then popd echo ${ret} return ${ret} fi popd # æ¢å¤åŸå§‹ç›®å½• # 6. æ‰“å°ä»£ç ç”Ÿæˆå®Œæˆçš„æ—¶é—´ echo -n \"time==\u003e\u003erun_codegen_layer-codegen=== \"; date; # 7. æ ¹æ®å‚æ•°åˆ¤æ–­ä¸»æœºç±»å‹ host_type=0 # å¦‚æœå‚æ•°ä¸­åŒ…å« chip_num æˆ– static_shapeï¼Œåˆ™å°† host_type è®¾ä¸º 1 if [[ $* == *\"chip_num\"* ]] || [[ $* == *\"static_shape\"* ]]; then host_type=1 fi # 8. è°ƒç”¨ get_codegen_file å¤„ç†ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ get_codegen_file ${codegen_path} ${host_type} # æ•è·è¿”å›å€¼ ret=$? # å¦‚æœå¤„ç†å¤±è´¥ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯ if [[ ${ret} -ne 0 ]]; then popd echo ${ret} return ${ret} fi # 9. åˆå§‹åŒ–æ¯”è¾ƒæ ‡å¿— cmp_flag=\"\" # å¦‚æœå‚æ•°ä¸­åŒ…å« fast_codegen æˆ– not_runï¼Œåˆ™è®¾ç½® cmp_flag ä¸º \"not_run\" if [[ $* == *\"fast_codegen\"* ]] || [[ $* == *\"not_run\"* ]]; then cmp_flag=\"not_run\" fi # 10. åœ¨ cmodel ä¸Šè¿è¡Œç”Ÿæˆçš„ä»£ç ï¼Œä¼ å…¥æ¯”è¾ƒæ ‡å¿— run_on_cmodel ${codegen_path} ${cmp_flag} # æ•è·è¿”å›å€¼ ret=$? # å¦‚æœè¿è¡Œå¤±è´¥ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯ if [[ ${ret} -ne 0 ]]; then popd echo ${ret} return ${ret} fi # 11. æ‰“å°ç»“æŸæ—¶é—´ echo -n \"time==\u003e\u003erun codegen layer-end=== \"; date; } get_codegen_file get_codegen_file ç”¨äºæ•´ç†ä»£ç ç”Ÿæˆçš„ç»“æœ (ä½äº ${BEMLIR_PROJECT_ROOT}/build/bin/${codegen_case})ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ (version.txt)ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°æµ‹è¯•ç›®å½• (${BEMLIR_PROJECT_ROOT}/external/tx8be-oplib/tests/test_codegen)ï¼Œæœ€åè°ƒç”¨ get_codegen_host å®Œæˆä¸»æœºç›¸å…³å¤„ç†ã€‚\n# Function to process and organize generated codegen files function get_codegen_file() { # Print all input arguments for debugging echo \"$*\" # Assign first argument as the codegen case name or path codegen_case=$1 # Second argument: 0 for host thread mode, 1 for host stream mode # Note: $2 is passed to get_codegen_host # Change to the codegen case directory under build/bin pushd \"${BEMLIR_PROJECT_ROOT}/build/bin/${codegen_case}\" # Find node directories matching node_[0-9]+_[0-9] pattern (e.g., node_123_4) node_dirs=$(find . -maxdepth 1 -type d -regex '.*/node_[0-9]+_[0-9]' -exec basename {} \\;) # Iterate through each node directory for dir in $node_dirs; do # Check if libTX8MLIRTransforms.a exists to determine version type if [ ! -e \"${BEMLIR_PROJECT_ROOT}/lib/libTX8MLIRTransforms.a\" ]; then # Write 'tx8be-mlir' to version.txt if library is absent echo -e \"tx8be-mlir\" \u003e \"${dir}/version.txt\" else # Write 'tx8be-mlir-sdk' to version.txt if library is present echo -e \"tx8be-mlir-sdk\" \u003e \"${dir}/version.txt\" fi # Append git status to version.txt to record repository state git status --porcelain \u003e\u003e \"${dir}/version.txt\" # Append last two git commits to version.txt for version history git log -2 \u003e\u003e \"${dir}/version.txt\" done popd # Change to the test_codegen directory pushd \"${BEMLIR_PROJECT_ROOT}/external/tx8be-oplib/tests/test_codegen\" # Remove existing codegen_case directory to ensure a clean state rm -rf \"${codegen_case}\" # Copy the codegen_case directory from build/bin cp -r \"${BEMLIR_PROJECT_ROOT}/build/bin/${codegen_case}\" . popd # Call get_codegen_host to process host-related tasks get_codegen_host \"${codegen_case}\" \"$2\" } get_codegen_host get_codegen_host ç”¨äºä¸º host ç¯å¢ƒå‡†å¤‡ä»£ç ç”Ÿæˆç”¨ä¾‹çš„æµ‹è¯•æ–‡ä»¶ã€‚å®ƒåœ¨æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸­å¤„ç† node \u0026 chip ç›¸å…³çš„æ–‡ä»¶ï¼Œå¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶ã€æºä»£ç å’Œæ„å»ºè„šæœ¬ï¼Œå¹¶æ ¹æ® host_type é€‰æ‹©ä¸åŒçš„ä¸»æœºå®ç°æ–‡ä»¶ host_thread.cpp æˆ– host_stream.cpp.\nå‡½æ•°è¾“å…¥å‚æ•°ï¼š $1 (codegen_case): ä»£ç ç”Ÿæˆç”¨ä¾‹çš„åç§°æˆ–è·¯å¾„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªç›®å½• (ä¾‹å¦‚ codegen0 æˆ– codegen1) ï¼Œè¡¨ç¤ºæµ‹è¯•ç”¨ä¾‹çš„æ ¹ç›®å½•ã€‚ $2 (host_type): ä¸»æœºæ‰§è¡Œæ¨¡å¼ï¼Œ0: host_thread.cppï¼Œ1: host_stream.cpp. åˆ‡æ¢åˆ° ${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${codegen_case} ç›®å½•: ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾ç¬¦åˆ node_[0-9]+_[0-9] æ¨¡å¼ (ä¾‹å¦‚ node_123_4) çš„å­ç›®å½•ï¼Œè¡¨ç¤ºä»£ç ç”Ÿæˆä¸­çš„èŠ‚ç‚¹ã€‚ å¯¹æ¯ä¸ª node_dir è¿½åŠ ç‰ˆæœ¬ä¿¡æ¯å’Œå¤åˆ¶ç›¸å…³æ–‡ä»¶ã€‚ å¤„ç† chip ç›®å½•: åœ¨æ¯ä¸ªèŠ‚ç‚¹ç›®å½•ä¸‹ï¼ŒæŸ¥æ‰¾ç¬¦åˆ chip[0-9]+ æ¨¡å¼ (ä¾‹å¦‚ chip0, chip1) çš„å­ç›®å½• ä¸ºæ¯ä¸ª dir å¤åˆ¶ Makefile_tile åˆ° ./${node_dir}/${dir}/Makefile. åœ¨ ./${node_dir}/${dir}/ ä¸‹åˆ›å»º 16 ä¸ªå­ç›®å½• (tiles0 - tiles15)ï¼Œå¹¶ä¸ºæ¯ä¸ªå­ç›®å½•å¤åˆ¶ Makefile_main åˆ° t iles$i/Makefile æ ¹æ® host_type å¤åˆ¶ host_thread.cpp æˆ– host_stream.cpp åˆ°å½“å‰ç›®å½•çš„ host.cpp. å¤åˆ¶ CMakeLists.txt å’Œ Makefile åˆ°å½“å‰ç›®å½•ã€‚ # Function to prepare host-related files for a codegen test case function get_codegen_host() { # Print all input arguments for debugging echo \"$*\" # Assign first argument as the codegen case name or path codegen_case=$1 # Assign second argument as host type (0: thread mode, 1: stream mode) host_type=$2 # Define relative path for test_codegen directory oplib_path=\"tests/test_codegen\" # Change to the test_codegen directory for the codegen case pushd \"${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${codegen_case}\" # Find node directories matching node_[0-9]+_[0-9] pattern (e.g., node_123_4) node_dirs=$(find . -maxdepth 1 -type d -regex '.*/node_[0-9]+_[0-9]' -exec basename {} \\;) for node_dir in $node_dirs; do # # Iterate through each node directory # Append oplib version info to version.txt echo -e \"\\n\\ntx8be-oplib:\" \u003e\u003e \"${node_dir}/version.txt\" # Append git status to version.txt to record repository state git status --porcelain \u003e\u003e \"${node_dir}/version.txt\" # Write last two git commits to version.txt for version history git log -2 \u003e\u003e \"${node_dir}/version.txt\" # Copy all stream-related files to node directory cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/stream*\" \"./${node_dir}/\" # Copy CMakeLists_chip.txt as CMakeLists.txt for node cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/CMakeLists_chip.txt\" \"./${node_dir}/CMakeLists.txt\" # Copy main_kcore.c to node directory cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/main_kcore.c\" \"./${node_dir}/\" # Copy Makefile_chip as Makefile for node cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/Makefile_chip\" \"./${node_dir}/Makefile\" # Find chip directories matching chip[0-9]+ pattern (e.g., chip0, chip1) chip_dirs=$(find \"./${node_dir}\" -maxdepth 1 -type d -regex '.*/chip[0-9]+' -exec basename {} \\;) # Iterate through each chip directory for dir in $chip_dirs; do # Copy Makefile_tile as Makefile for chip cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/Makefile_tile\" \"./${node_dir}/${dir}/Makefile\" # Create Makefiles for 16 tiles (tiles0 to tiles15) for ((i=0; i\u003c16; i++)); do dst_file=\"./${node_dir}/${dir}/tiles${i}/Makefile\" # Copy Makefile_main to each tile's Makefile cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/Makefile_main\" \"$dst_file\" done done done # Copy host implementation based on host_type if [ $host_type -eq 0 ]; then # Use thread-based host implementation cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/host_thread.cpp\" \"host.cpp\" else # Use stream-based host implementation # Note: Fixed typo '$t{OPLIB_PROJECT_ROOT}' to '${{OPLIB_PROJECT_ROOT}}' cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/host_stream.cpp\" \"host.cpp\" fi # Copy top-level CMakeLists.txt for test case cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/CMakeLists.txt\" . # Copy top-level Makefile for test case cp \"${{OPLIB_PROJECT_ROOT}}/tools/codegen/Makefile\" . # Restore original directory popd } run_on_cmodel run_on_cmodel ç”¨äºåœ¨æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸­è¿è¡Œ cmodel ä»¿çœŸä»»åŠ¡ã€‚å‡½æ•°çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ç¯å¢ƒè®¾ç½®ã€æ„å»ºã€æ‰§è¡Œä»¿çœŸè„šæœ¬æˆ–ç¨‹åºï¼Œå¹¶å¤„ç†é”™è¯¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜ï¼š\nå‡½æ•°è¾“å…¥å‚æ•°ï¼š $1 (case_name): æ¥è‡ª run_codegen_layer çš„ codegen_pathï¼Œå¯èƒ½é™„åŠ  host_type. $2 (run_flag): è¿è¡Œæ ‡å¿—ï¼Œæ¥è‡ª run_codegen_layer çš„ cmp_flag ç”¨äºæ§åˆ¶ä»¿çœŸæ‰§è¡Œçš„æ–¹å¼ (ä¾‹å¦‚æ˜¯å¦è¿è¡Œæˆ–è¿è¡Œæ¨¡å¼) ã€‚ åˆ‡æ¢å·¥ä½œç›®å½•å¹¶æ‰§è¡Œ: åˆ‡æ¢åˆ°æµ‹è¯•ç”¨ä¾‹ç›®å½• ${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${case_name} è¿è¡Œ cmake .. -DUSING_RISCV=OFFï¼Œé…ç½®æ„å»ºç³»ç»Ÿï¼Œç¦ç”¨ RISCV æ”¯æŒã€‚ è¿è¡Œ make -j å¹¶åŠ¨æ€è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•° (åŸºäº CPU æ ¸å¿ƒæ•°ï¼Œcat /proc/stat | grep cpu[0-9] -c) ä»¿çœŸæ‰§è¡Œ: æ ¹æ®å‚æ•°è¿è¡Œä»¿çœŸè„šæœ¬ (host_sim.sh) æˆ– host_sim. # Function to run a cmodel simulation for a given test case function run_on_cmodel() { # Assign first argument as the test case name case_name=$1 # Assign second argument as the run flag (controls execution mode) run_flag=$2 # Check if case_name is empty if [ -z \"$case_name\" ]; then echo \"Error: case_name is empty\" return 1 fi # Check if the test case directory exists if [ ! -d \"${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${case_name}\" ]; then echo \"Can not find ${case_name}\" return 1 fi # Change to the test case directory pushd \"${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${case_name}\" # FIXED DIR rm -rf build mkdir build cd build # Run cmake to configure the build, disabling RISCV support cmake .. -DUSING_RISCV=OFF # Run make with parallel jobs based on CPU core count make -j$(cat /proc/stat | grep cpu[0-9] -c) ret=$? # Capture the return code # If make fails, restore directory, print error, and exit if [[ $ret -ne 0 ]]; then popd echo $ret return $ret fi # Check if run_flag is empty if [ -z \"$run_flag\" ]; then if [ -e ../host_sim.sh ]; then # Check if host_sim.sh exists in the parent directory cp ../host_sim.sh . sh ./host_sim.sh ret=$? # Capture the return code # If script fails, restore directory, print error, and exit if [[ $ret -ne 0 ]]; then popd echo $ret return $ret fi else ./host_sim ../ # Run host_sim with parent directory as argument ret=$? # Capture the return code # If host_sim fails, restore directory, print error, and exit if [[ $ret -ne 0 ]]; then popd echo $ret return $ret fi fi # Check if run_flag is \"0\" or \"1\" elif [[ $run_flag == \"0\" ]] || [[ $run_flag == \"1\" ]]; then # Run host_sim with parent directory and run_flag ./host_sim ../ \"$run_flag\" ret=$? # Capture the return code # If host_sim fails, restore directory, print error, and exit if [[ $ret -ne 0 ]]; then popd echo $ret return $ret fi fi popd echo \"${FUNCNAME[0]} $* passed\" } run_codegen_case_soc_rtt run_codegen_case_soc_rtt ä½äº tx8-oplib/scripts/regression.shï¼Œå‡½æ•°ç”¨äºåœ¨ SOC ç¯å¢ƒä¸‹è¿è¡Œ RTT (Real-Time Transfer) æµ‹è¯•ã€‚å…¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š\nåˆå§‹åŒ–å’Œå‚æ•°è·å–ï¼š å‡½æ•°ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å– case_name, copy_option, å’Œ multi_graph_enable. æ£€æŸ¥ case_name æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1. ç¯å¢ƒè®¾ç½®å’Œç›®å½•å¯¼èˆªï¼š å°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ° ${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name}. å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1ã€‚ æ„å»ºå’Œé…ç½®ï¼š æ‰§è¡Œ rm -rf ${case_name}_build æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ã€‚ æ ¹æ® multi_graph_enable è®¾ç½® CONFIG_ARGSï¼Œå¦‚æœå¯ç”¨å¤šå›¾åˆ™è®¾ç½®ä¸º â€œ-DMULTI_GRAPH=1â€ï¼Œå¦åˆ™ä¸ºç©ºã€‚ è°ƒç”¨ cmake å‘½ä»¤ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºç›®å½•ä¸º ${case_name}_buildï¼Œå¹¶æ ¹æ® copy_option è®¾ç½® COPY_RTT_FLAG. æ‰§è¡Œ make å‘½ä»¤è¿›è¡Œå®é™…æ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ all å’Œ chip_out. é”™è¯¯å¤„ç†å’Œé€€å‡ºï¼š æ¯æ¬¡å…³é”®æ­¥éª¤æ‰§è¡Œåï¼Œæ£€æŸ¥è¿”å›çŠ¶æ€ $retï¼Œå¦‚æœé 0ï¼Œåˆ™å¼¹å‡ºç›®å½•å¹¶è¿”å›é”™è¯¯ç ã€‚ æ„å»ºæˆåŠŸåè¾“å‡º ${FUNCNAME[0]} \"passed\" è¡¨ç¤ºé€šè¿‡ã€‚ æ¸…ç†å’Œè¿”å›: å‡½æ•°ç»“æŸæ—¶å¼¹å‡ºç›®å½•ï¼Œæ¢å¤åŸå§‹å·¥ä½œç›®å½•ã€‚ function run_codegen_case_soc_rtt() { echo \"${FUNCNAME[0]} 'start'\" # è¾“å‡ºå‡½æ•°åå’Œ\"start\"è¡¨ç¤ºå¼€å§‹ case_name=$1 # è·å–ç”¨ä¾‹åç§° copy_option=$2 # è·å–å¤åˆ¶é€‰é¡¹ multi_graph_enable=$3 # è·å–å¤šå›¾å¯ç”¨æ ‡å¿— if [ -z \"$case_name\" ]; then # å¦‚æœç”¨ä¾‹åç§°ä¸ºç©º echo \"case_name($case_name) not found \" # è¾“å‡ºé”™è¯¯ä¿¡æ¯ return 1 # è¿”å›é”™è¯¯ç  1 fi case_dir=${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name} # è®¾ç½®ç”¨ä¾‹ç›®å½• pushd ${case_dir} # åˆ‡æ¢åˆ°ç”¨ä¾‹ç›®å½• rm -rf ${case_name}_build # æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # æ£€æŸ¥æ¸…ç†æ˜¯å¦æˆåŠŸ if [ -z \"$multi_graph_enable\" ]; then # å¦‚æœå¤šå›¾å¯ç”¨æ ‡å¿—ä¸ºç©º CONFIG_ARGS=\"\" # é…ç½®å‚æ•°ä¸ºç©º else # å¦åˆ™ CONFIG_ARGS=\"-DMULTI_GRAPH=1\" # è®¾ç½®å¤šå›¾é…ç½®å‚æ•° fi cmake -B \"${case_name}_build\" -DUSING_RISCV=ON -TX8FW_BASE=${OPLIB_PROJECT_ROOT}/release/riscv/tx8-yoc-rt-thread-smp ${CONFIG_ARGS} ; ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # ç”Ÿæˆæ„å»ºæ–‡ä»¶ make -j -C \"${case_name}_build\" --target all chip_out ; ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # æ‰§è¡Œæ„å»º popd # æ¢å¤åˆ°åŸå§‹ç›®å½• echo \"${FUNCNAME[0]} 'passed'\" # è¾“å‡ºå‡½æ•°åå’Œ\"passed\"è¡¨ç¤ºé€šè¿‡ } export_tx8fw_to_env export_tx8fw_to_env å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯è®¾ç½®ä¸ TX8FW ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿åç»­æ„å»ºæˆ–è¿è¡Œæ—¶ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯å…¶æµç¨‹ï¼š\nè®¾ç½® SDK è·¯å¾„ï¼š å®šä¹‰ TX8FW çš„ SDK è·¯å¾„ soc_sdk_path ä¸º ${OPLIB_PROJECT_ROOT}/3rd_party/tx8-yoc-rt-thread-smp. æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨: æ£€æŸ¥è·¯å¾„ ${soc_sdk_path}/tool/tx8fw-xuantie-sdk æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºï¼ŒçŠ¶æ€ç ä¸º 1. å¯¼å‡ºç¯å¢ƒå˜é‡: æ‰“å°å¹¶è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ TX8FW_SDK_INSTALL_DIRï¼šæŒ‡å‘ ${soc_sdk_path}/tool/tx8fw-xuantie-sdkã€‚ TX8FW_TOOLCHAIN_VARIANTï¼šè®¾ç½®ä¸º cross-compileã€‚ æ¸…ç†ç›®å½•: ä½¿ç”¨ popd å‘½ä»¤æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•. function export_tx8fw_to_env() { soc_sdk_path=${OPLIB_PROJECT_ROOT}/3rd_party/tx8-yoc-rt-thread-smp # è®¾ç½® TX8FW SDK è·¯å¾„ pushd ${soc_sdk_path}/tool/tx8fw-xuantie-sdk # åˆ‡æ¢åˆ° TX8FW SDK å·¥å…·ç›®å½• if [ ! -d \"xuantie-900-gcc-elf-newlib-x86_64-V2.8.0\" ]; then # æ£€æŸ¥æŒ‡å®š SDK ç›®å½•æ˜¯å¦å­˜åœ¨ echo \"${soc_sdk_path}/tool/tx8fw-xuantie-sdk didn't exist\" # å¦‚æœä¸å­˜åœ¨ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯ exit 1 # é€€å‡ºå¹¶è¿”å›çŠ¶æ€ç  1 fi echo \"export TX8FW_SDK_INSTALL_DIR=${soc_sdk_path}/tool/tx8fw-xuantie-sdk\" # æ‰“å°å¹¶è®¾ç½® TX8FW SDK å®‰è£…ç›®å½•ç¯å¢ƒå˜é‡ export TX8FW_SDK_INSTALL_DIR=${soc_sdk_path}/tool/tx8fw-xuantie-sdk # å¯¼å‡º TX8FW SDK å®‰è£…ç›®å½•ç¯å¢ƒå˜é‡ export TX8FW_TOOLCHAIN_VARIANT=cross-compile # å¯¼å‡ºå·¥å…·é“¾å˜ä½“ä¸º cross-compile popd # æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½• } build_oplib_with_soc å‡½æ•° build_oplib_with_soc å‡½æ•°ç”¨äºæ„å»º OPLib å¹¶ç»“åˆç‰¹å®š SoC é…ç½®ã€‚ä»¥ä¸‹æ˜¯å…¶æµç¨‹ï¼š\næ‰“å°é¡¹ç›®æ ¹ç›®å½•ï¼š æ‰“å° OPLIB_PROJECT_ROOT ç¯å¢ƒå˜é‡ï¼Œç”¨äºè°ƒè¯•æˆ–æ—¥å¿—è®°å½•ã€‚\nåˆ‡æ¢ç›®å½•å’Œåˆå§‹åŒ–ï¼š ä½¿ç”¨ pushd åˆ‡æ¢åˆ° OPLIB_PROJECT_ROOT ç›®å½•ã€‚ å®šä¹‰å˜é‡ rm=rf build, mkdir=build å’Œ cd=buildï¼Œè¿™äº›å˜é‡å®é™…ä¸Šæ˜¯æ¨¡æ‹Ÿå‘½ä»¤ï¼ˆrm -rf buildã€mkdir build å’Œ cd buildï¼‰ã€‚ è®¾ç½®å¤åˆ¶æ ‡å¿—ï¼š æ£€æŸ¥ $1 (å³ copy_option) æ˜¯å¦ä¸º â€œNOT_COPYâ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¾ç½® COPY_RTT_FLAG ä¸º --DRTT_HOST_COPY=OFFï¼Œå¦åˆ™ä¸ºç©ºã€‚ å¯¼å‡ºç¯å¢ƒå˜é‡å¹¶æ„å»ºï¼š è°ƒç”¨ export_tx8fw_to_env å‡½æ•°è®¾ç½® TX8FW ç›¸å…³ç¯å¢ƒå˜é‡ã€‚ è¿è¡Œ cmake å‘½ä»¤ï¼Œç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºé€‰é¡¹ -DUSING_RISCV=ON å’Œ TX8FW_BASEï¼Œå¹¶æ ¹æ® COPY_RTT_FLAG æ·»åŠ é¢å¤–å‚æ•°ã€‚ ä½¿ç”¨ make å‘½ä»¤æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ grep epilog å’Œ c æ¸…ç†ç›®å½•: ä½¿ç”¨ popd å‘½ä»¤æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•. function build_oplib_with_soc() { echo ${OPLIB_PROJECT_ROOT} # æ‰“å° OPLib é¡¹ç›®æ ¹ç›®å½•è·¯å¾„ pushd ${OPLIB_PROJECT_ROOT} # åˆ‡æ¢åˆ° OPLib é¡¹ç›®æ ¹ç›®å½• rm=rf build # å®šä¹‰æ¸…ç†æ„å»ºç›®å½•çš„å‘½ä»¤ mkdir=build # å®šä¹‰åˆ›å»ºæ„å»ºç›®å½•çš„å‘½ä»¤ cd=build # å®šä¹‰åˆ‡æ¢åˆ°æ„å»ºç›®å½•çš„å‘½ä»¤ COPY_RTT_FLAG=\"\" # åˆå§‹åŒ– RTT å¤åˆ¶æ ‡å¿— if [ \"$1\" == \"NOT_COPY\" ]; then # å¦‚æœä¼ å…¥çš„å¤åˆ¶é€‰é¡¹ä¸º NOT_COPY COPY_RTT_FLAG=\"--DRTT_HOST_COPY=OFF\" # è®¾ç½® RTT å¤åˆ¶æ ‡å¿—ä¸ºå…³é—­ fi export_tx8fw_to_env # è°ƒç”¨å‡½æ•°å¯¼å‡º TX8FW ç›¸å…³ç¯å¢ƒå˜é‡ cmake .. -DUSING_RISCV=ON -TX8FW_BASE=${OPLIB_PROJECT_ROOT}/release/riscv/tx8-yoc-rt-thread-smp ${COPY_RTT_FLAG} # ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®š RISCV å’Œ TX8FW è·¯å¾„ ret=$?; if [ $ret -ne 0 ]; then popd; return $ret; fi # æ£€æŸ¥ cmake æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å› make -j cat /proc/stat | grep epilog -c # æ‰§è¡Œæ„å»ºå¹¶æ£€æŸ¥ epilog ç›¸å…³ä¿¡æ¯ ret=$?; if [ $ret -ne 0 ]; then popd; return $ret; fi # æ£€æŸ¥ make æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å› popd # æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½• echo ${FUNCNAME[0]} \"passed\" # è¾“å‡ºå‡½æ•°åå’Œ\"passed\"è¡¨ç¤ºæ„å»ºæˆåŠŸ } run_on_soc_rtt run_on_soc_rttï¼Œç”¨äºåœ¨ç‰¹å®š SoC å’Œ RTT ç¯å¢ƒä¸‹è¿è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸»è¦æµç¨‹ï¼š\nåˆå§‹åŒ–å’Œå‚æ•°è·å–: å‡½æ•°ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å– case_name, rtt_option å’Œ multi_graph_enable. æ£€æŸ¥ case_name æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1ã€‚ ç›®å½•åˆ‡æ¢å’Œæ¸…ç†: å°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ° ${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name}. æ‰§è¡Œ rm -rf ${case_name}_build æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ã€‚ é…ç½®è®¾ç½®: æ ¹æ® multi_graph_enable è®¾ç½® CONFIG_ARGSï¼Œå¦‚æœå¯ç”¨å¤šå›¾åˆ™è®¾ç½®ä¸º â€œ-DMULTI_GRAPH=1â€ï¼Œå¦åˆ™ä¸ºç©ºã€‚ æ„å»ºå’Œè¿è¡Œï¼š ä½¿ç”¨ cmake ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºç›®å½•ä¸º ${case_name}_buildï¼Œå¹¶è®¾ç½® -DUSING_RISCV=ON å’Œ -TX8FW_BASE è·¯å¾„ã€‚ ä½¿ç”¨ make å‘½ä»¤æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ all å’Œ chip_out. æ¸…ç†å’Œè¿”å›: ä½¿ç”¨ popd æ¢å¤åˆ°åŸå§‹ç›®å½•ã€‚ function run_on_soc_rtt() { echo \"${FUNCNAME[0]} 'start'\" # è¾“å‡ºå‡½æ•°åå’Œ\"start\"è¡¨ç¤ºå¼€å§‹ case_name=$1 # è·å–ç”¨ä¾‹åç§° rtt_option=$2 # è·å– RTT é€‰é¡¹ multi_graph_enable=$3 # è·å–å¤šå›¾å¯ç”¨æ ‡å¿— if [ -z \"$case_name\" ]; then # å¦‚æœç”¨ä¾‹åç§°ä¸ºç©º echo \"case_name($case_name) not found \" # è¾“å‡ºé”™è¯¯ä¿¡æ¯ return 1 # è¿”å›é”™è¯¯ç  1 fi case_dir=${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name} # è®¾ç½®ç”¨ä¾‹ç›®å½• pushd ${case_dir} # åˆ‡æ¢åˆ°ç”¨ä¾‹ç›®å½• rm -rf ${case_name}_build # æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # æ£€æŸ¥æ¸…ç†æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å› if [ -z \"$multi_graph_enable\" ]; then # å¦‚æœå¤šå›¾å¯ç”¨æ ‡å¿—ä¸ºç©º CONFIG_ARGS=\"\" # é…ç½®å‚æ•°ä¸ºç©º else # å¦åˆ™ CONFIG_ARGS=\"-DMULTI_GRAPH=1\" # è®¾ç½®å¤šå›¾é…ç½®å‚æ•° fi cmake -B \"${case_name}_build\" -DUSING_RISCV=ON -TX8FW_BASE=${OPLIB_PROJECT_ROOT}/release/riscv/tx8-yoc-rt-thread-smp ${CONFIG_ARGS} ; ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®š RISCV å’Œ TX8FW è·¯å¾„ make -C \"${case_name}_build\" --target all chip_out ; ret=$?; if [ [ $ret -ne 0 ]]; then popd; echo $ret; return $ret; fi # æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡ä¸º all å’Œ chip_out popd # æ¢å¤åˆ°åŸå§‹ç›®å½• echo \"${FUNCNAME[0]} 'passed'\" # è¾“å‡ºå‡½æ•°åå’Œ\"passed\"è¡¨ç¤ºé€šè¿‡ } ",
  "wordCount" : "6269",
  "inLanguage": "en",
  "datePublished": "2025-06-11T10:21:42+08:00",
  "dateModified": "2025-06-13T15:12:24+08:00",
  "author":[{
    "@type": "Person",
    "name": "WITHER"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blogs/tx8read/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "WITHER",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="WITHER (Alt + H)">WITHER</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/zh/" title="ç®€ä½“ä¸­æ–‡"
                            aria-label="ç®€ä½“ä¸­æ–‡">ç®€ä½“ä¸­æ–‡</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="ğŸ  Home">
                    <span>ğŸ  Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about_me/" title="ğŸ™‹ğŸ»â€â™‚ï¸ Me">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸ Me</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blogs/" title="ğŸ“š Blogs">
                    <span>ğŸ“š Blogs</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="ğŸ§© Categories">
                    <span>ğŸ§© Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ”– Tags">
                    <span>ğŸ”– Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="â± Archive">
                    <span>â± Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ” Search (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/friends/" title="ğŸ¤ Friends">
                    <span>ğŸ¤ Friends</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/blogs/">Blogs</a></div>
    <h1 class="post-title entry-hint-parent">
      Tx8read
    </h1>
    <div class="post-description">
      tx8 regression
    </div>
    <div class="post-meta"><span title='2025-06-11 10:21:42 +0800 CST'>Jun-11-2025</span>&nbsp;Â·&nbsp;13 min&nbsp;Â·&nbsp;6269 words&nbsp;Â·&nbsp;WITHER

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#testgraphcompute" aria-label="TestGraphCompute">TestGraphCompute</a><ul>
                            
                    <li>
                        <a href="#computegolden" aria-label="computeGolden">computeGolden</a></li></ul>
                    </li>
                    <li>
                        <a href="#run_code_gen_layer" aria-label="run_code_gen_layer">run_code_gen_layer</a><ul>
                            
                    <li>
                        <a href="#get_codegen_file" aria-label="get_codegen_file">get_codegen_file</a></li>
                    <li>
                        <a href="#get_codegen_host" aria-label="get_codegen_host">get_codegen_host</a></li>
                    <li>
                        <a href="#run_on_cmodel" aria-label="run_on_cmodel">run_on_cmodel</a></li></ul>
                    </li>
                    <li>
                        <a href="#run_codegen_case_soc_rtt" aria-label="run_codegen_case_soc_rtt">run_codegen_case_soc_rtt</a><ul>
                            
                    <li>
                        <a href="#export_tx8fw_to_env" aria-label="export_tx8fw_to_env">export_tx8fw_to_env</a></li>
                    <li>
                        <a href="#build_oplib_with_soc-%e5%87%bd%e6%95%b0" aria-label="build_oplib_with_soc å‡½æ•°">build_oplib_with_soc å‡½æ•°</a></li>
                    <li>
                        <a href="#run_on_soc_rtt" aria-label="run_on_soc_rtt">run_on_soc_rtt</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="testgraphcompute">TestGraphCompute<a hidden class="anchor" aria-hidden="true" href="#testgraphcompute">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆå§‹åŒ–ä¸å‘½ä»¤è¡Œå‚æ•°å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Timer</span> <span class="n">timer</span><span class="p">(</span><span class="s">&#34;TestGraphCompute&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlir</span><span class="o">::</span><span class="n">registerAsmPrinterCLOptions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlir</span><span class="o">::</span><span class="n">registerMLIRContextCLOptions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlir</span><span class="o">::</span><span class="n">registerPassManagerCLOptions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æå‘½ä»¤è¡Œå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cl</span><span class="o">::</span><span class="n">ParseCommandLineOptions</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&#34;tx8be compiler</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. åˆå§‹åŒ– MLIR æ¨¡å—å’Œä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mlir</span><span class="o">::</span><span class="n">OwningOpRef</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">ModuleOp</span><span class="o">&gt;</span> <span class="n">module</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mlir</span><span class="o">::</span><span class="n">MLIRContext</span> <span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºä»å‘½ä»¤è¡Œé€‰é¡¹ä¸­æå– codegen_path å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">regex</span> <span class="n">pattern</span><span class="p">(</span><span class="s">&#34;codegen_path=([a-zA-Z0-9_]+)&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">smatch</span> <span class="n">matches</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cachePath</span> <span class="o">=</span> <span class="s">&#34;codegen&#34;</span><span class="p">;</span>  <span class="c1">// é»˜è®¤æ–‡ä»¶å¤¹åå­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">optionstr</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// å¯»æ‰¾å‘½ä»¤è¡Œé€‰é¡¹ä¸­æ˜¯å¦æŒ‡å®š codegen_path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cachePath</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. åŠ è½½ MLIR æ¨¡å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ cache ä¸º 2 æˆ– 4ï¼Œåˆ™ä»ç¼“å­˜è·¯å¾„åŠ è½½æ¨¡å—ï¼›å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ gModelFil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">gModelFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">cache</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">cachePath</span> <span class="o">+</span> <span class="s">&#34;/cache.mlir&#34;</span> <span class="o">:</span> <span class="n">gModelFile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">getMLIRFromFile</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">gModelFile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4. é…ç½®æ¨¡å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">mconfig</span> <span class="o">=</span> <span class="n">getModuleConfig</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">optionstr</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mconfig</span><span class="p">.</span><span class="n">option</span> <span class="o">+=</span> <span class="n">optionstr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mconfig</span><span class="p">.</span><span class="n">constCache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">updateModuleConfig</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">mconfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mconfig</span> <span class="o">=</span> <span class="n">getModuleConfig</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">showModuleConfig</span><span class="p">(</span><span class="n">mconfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5. å¤„ç†å¤šå¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">json_info_multi_card_t</span> <span class="o">*</span><span class="n">multi_card_jinfo</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">multi_card_jinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">cache</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">get_multi_card_info_from_file</span><span class="p">(</span><span class="n">cachePath</span> <span class="o">+</span> <span class="s">&#34;/model_info.json&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">:</span> <span class="n">parseMultiCardModuleInfo</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dumpIR</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6. è¯»å–å‚è€ƒè·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fast_codegen</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// NOT fast_codegen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">in_files</span> <span class="o">=</span> <span class="n">parseStringArgs</span><span class="p">(</span><span class="n">gInputBin</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">out_files</span> <span class="o">=</span> <span class="n">parseStringArgs</span><span class="p">(</span><span class="n">gOutputBin</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å®šä¹‰ä¸€ä¸ª lambda å‡½æ•°ï¼Œç”¨äºä»æ–‡ä»¶ä¸­è¯»å–å‚è€ƒæ–‡ä»¶è·¯å¾„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">getRefFiles</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">gFile</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">gFile</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llvm</span><span class="o">::</span><span class="n">sys</span><span class="o">::</span><span class="n">fs</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span><span class="n">gFile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">gf</span><span class="p">(</span><span class="n">gFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">text</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gf</span><span class="p">)),</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span> <span class="o">=</span> <span class="n">parseStringArgs</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">gInputBin</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gInputFile</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">getRefFiles</span><span class="p">(</span><span class="n">gInputFile</span><span class="p">,</span> <span class="n">in_files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">getRefFiles</span><span class="p">(</span><span class="n">gOutputFile</span><span class="p">,</span> <span class="n">out_files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 7. computeGolden
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mconfig</span><span class="p">.</span><span class="n">tile</span><span class="p">.</span><span class="n">chip_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// éå†èŠ¯ç‰‡æ•°é‡ï¼Œåˆ›å»ºå¯¹åº”çš„ç›®å½•ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ„é€ å¹¶åˆ›å»ºåˆ›å»ºç›® codegen/node_0_0/chip0/agent/data 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#34;codegen/node_0_0/chip&#34;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;/agent/data&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">createDir</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨ computeGolden å‡½æ•°ï¼Œè®¡ç®—å‚è€ƒè¾“å‡ºä¿å­˜åˆ° codegenPath
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">computeGolden</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">multi_card_jinfo</span><span class="p">,</span> <span class="n">in_files</span><span class="p">,</span> <span class="n">out_files</span><span class="p">,</span> <span class="n">mconfig</span><span class="p">.</span><span class="n">codegenPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ moduleCompileCodegen å‡½æ•°ï¼Œå¯¹ MLIR æ¨¡å—è¿›è¡Œç¼–è¯‘å’Œä»£ç ç”Ÿæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">moduleCompileCodegen</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ASSERT</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 9. è·å–å†…å­˜å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»æ¨¡å—ä¸­è·å–ç«‹å³æ•° (Immediate) å’Œå¸¸é‡å‚æ•°çš„ DDR å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">imm_size</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasAttr</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ImmDdrSize</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">    <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAttrOfType</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">IntegerAttr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ImmDdrSize</span><span class="p">).</span><span class="n">getInt</span><span class="p">()</span> <span class="o">:</span> <span class="mi">2147483648</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">params_size</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasAttr</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ConstDdrSize</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">        <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAttrOfType</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">IntegerAttr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ConstDdrSize</span><span class="p">).</span><span class="n">getInt</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 10. æ›´æ–°æ¯ä¸ªèŠ¯ç‰‡çš„å†…å­˜å¤§å°ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mconfig</span><span class="p">.</span><span class="n">tile</span><span class="p">.</span><span class="n">chip_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">multi_card_jinfo</span><span class="o">-&gt;</span><span class="n">chip_infos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">imm_size</span> <span class="o">=</span> <span class="n">imm_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">multi_card_jinfo</span><span class="o">-&gt;</span><span class="n">chip_infos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">params_size</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">params_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 11. ä¿å­˜å¤šå¡æ¨¡å‹ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="n">chipIds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasAttr</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ChipIds</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// è·å–èŠ¯ç‰‡ ID 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mlir</span><span class="o">::</span><span class="n">ArrayAttr</span> <span class="n">chipIdsAttr</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAttrOfType</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">ArrayAttr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tx8be</span><span class="o">::</span><span class="n">ModuleAttr</span><span class="o">::</span><span class="n">ChipIds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chipIdsAttr</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">chipIds</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">chipIdsAttr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">IntegerAttr</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getInt</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤šå¡æ¨¡å‹æ–‡ä»¶ä¿å­˜åˆ° codegenPath è·¯å¾„ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">saveMultiCardModelJson</span><span class="p">(</span><span class="n">multi_card_jinfo</span><span class="p">,</span> <span class="n">mconfig</span><span class="p">.</span><span class="n">codegenPath</span><span class="p">,</span> <span class="n">chipIds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// uint64_t ddrSize = getModelDDRSize(multi_card_jinfo);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="computegolden">computeGolden<a hidden class="anchor" aria-hidden="true" href="#computegolden">#</a></h2>
<p>è¾“å…¥å‚æ•°çš„æ¥æºï¼š</p>
<ul>
<li><code>module</code>ï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>getMLIRFromFile</code> å‡½æ•°ä»æ–‡ä»¶ä¸­åŠ è½½ MLIR æ¨¡å—</li>
<li><code>multi_card_jinfo</code>ï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>get_multi_card_info_from_file</code> æˆ– <code>parseMultiCardModuleInfo</code> ä» JSON æ–‡ä»¶æˆ– MLIR æ¨¡å—ä¸­æå–å¤šå¡ä¿¡æ¯ã€‚</li>
<li><code>in_files</code> å’Œ <code>out_files</code>ï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>parseStringArgs</code> æˆ– <code>getRefFiles</code> è§£æè¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„ã€‚</li>
<li><code>mconfig.codegenPath</code>ï¼šåœ¨ main æ–‡ä»¶ä¸­ï¼Œé€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹æˆ–é»˜è®¤å€¼è®¾ç½®ä»£ç ç”Ÿæˆè·¯å¾„ï¼Œå¹¶ä¼ é€’ç»™ computeGoldenã€‚</li>
</ul>
<p>computeGolden å‡½æ•°ç”Ÿæˆçš„æ•°æ®ï¼ˆè¾“å…¥å’Œè¾“å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰å°†ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„ mconfig.codegenPath.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">computeGolden</span><span class="p">(</span><span class="n">mlir</span><span class="o">::</span><span class="n">OwningOpRef</span><span class="o">&lt;</span><span class="n">mlir</span><span class="o">::</span><span class="n">ModuleOp</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">module</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">json_info_multi_card_t</span> <span class="o">*</span><span class="n">multi_card_jinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">inFiles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">outFiles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å®šä¹‰å½¢çŠ¶ç±»å‹ï¼Œç”¨äºå­˜å‚¨å¤šç»´å¼ é‡çš„å½¢çŠ¶ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">using</span> <span class="n">ShapeType</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”¨äºå­˜å‚¨å¤šèŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int8_t</span> <span class="o">*&gt;&gt;</span> <span class="n">multiInputDdata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int8_t</span> <span class="o">*&gt;&gt;</span> <span class="n">multiOutputData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">chip_num</span> <span class="o">=</span> <span class="n">multi_card_jinfo</span><span class="o">-&gt;</span><span class="n">chip_num</span><span class="p">;</span>  <span class="c1">// è·å–èŠ¯ç‰‡æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">tile_info</span> <span class="o">=</span> <span class="n">get_tileinfo</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>  <span class="c1">// ä» MLIR æ¨¡å—ä¸­æå– tile ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ShapeType</span><span class="o">&gt;</span> <span class="n">outShapes</span><span class="p">(</span><span class="n">chip_num</span><span class="p">);</span>  <span class="c1">// å­˜å‚¨æ¯ä¸ªèŠ¯ç‰‡çš„è¾“å‡ºå½¢çŠ¶ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">chip_info_t</span> <span class="o">*</span><span class="n">chip_info</span> <span class="o">=</span> <span class="n">multi_card_jinfo</span><span class="o">-&gt;</span><span class="n">chip_infos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ†é…å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®æŒ‡é’ˆæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int8_t</span> <span class="o">*&gt;</span> <span class="n">input_data</span><span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">input_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int8_t</span> <span class="o">*&gt;</span> <span class="n">output_data</span><span class="p">(</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">output_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”¨äº OneDNN è®¡ç®—çš„è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span> <span class="o">*&gt;</span> <span class="n">computeInputs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span> <span class="o">*&gt;</span> <span class="n">computeOutputs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">chipInFiles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">chipOutFiles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">parseInOutfile</span><span class="p">(</span><span class="n">inFiles</span><span class="p">,</span> <span class="n">chipInFiles</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chip_num</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">input_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">parseInOutfile</span><span class="p">(</span><span class="n">outFiles</span><span class="p">,</span> <span class="n">chipOutFiles</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chip_num</span><span class="p">,</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">output_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”Ÿæˆå½“å‰èŠ¯ç‰‡çš„è¾“å…¥è¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">genInputs4SingleChip</span><span class="p">(</span><span class="n">computeInputs</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">chip_info</span><span class="p">,</span> <span class="n">chipInFiles</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">genOutputs4SingleChip</span><span class="p">(</span><span class="n">computeOutputs</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">chip_info</span><span class="p">,</span> <span class="n">chipOutFiles</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœè¾“å…¥æ–‡ä»¶ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®å¹¶æ ¡æ­£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">chipInFiles</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">updateSpecialInputData</span><span class="p">(</span><span class="n">computeModuleRef</span><span class="p">,</span> <span class="n">computeInputs</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">chip_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">multiInputDdata</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">input_data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">multiOutputData</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">output_data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">outFiles</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">moduleComputeInterface</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">computeModuleRef</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">outShapes</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">computeInputs</span><span class="p">,</span> <span class="n">computeOutputs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆè®¡ç®—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="kr">thread</span> <span class="o">:</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†æ¯ä¸ªèŠ¯ç‰‡ï¼Œä¿å­˜è¾“å…¥å’Œè¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">chip_info_t</span> <span class="o">*</span><span class="n">chip_info</span> <span class="o">=</span> <span class="n">multi_card_jinfo</span><span class="o">-&gt;</span><span class="n">chip_infos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">node_id</span> <span class="o">=</span> <span class="n">get_node_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tile_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int32_t</span> <span class="n">relative_chip_id</span> <span class="o">=</span> <span class="n">get_relative_chip_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tile_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ„é€ å½“å‰èŠ¯ç‰‡çš„æ•°æ®ä¿å­˜è·¯å¾„  file_path/node_x_y/chip_z/agent/data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="s">&#34;/node_&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">node_id</span> <span class="o">/</span> <span class="n">tile_info</span><span class="p">.</span><span class="n">node_y</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;_&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">node_id</span> <span class="o">%</span> <span class="n">tile_info</span><span class="p">.</span><span class="n">node_y</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;/chip&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">relative_chip_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;/agent/data&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">createDir</span><span class="p">(</span><span class="n">data_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// binæ ¼å¼ä¿å­˜å½“å‰èŠ¯ç‰‡çš„è¾“å…¥æ•°æ®  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">input_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">inout_tensor_info_t</span> <span class="o">*</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">saveInOutTensor</span><span class="p">(</span><span class="n">tensor</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">dim</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">dtype</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">data_path</span> <span class="o">+</span> <span class="s">&#34;/in&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;.bin&#34;</span><span class="p">,</span> <span class="n">multiInputDdata</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// binæ ¼å¼ä¿å­˜å½“å‰èŠ¯ç‰‡çš„è¾“å‡ºæ•°æ®  out_j_ref.bin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">output_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">inout_tensor_info_t</span> <span class="o">*</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int32_t</span> <span class="n">tensorShape</span><span class="p">[</span><span class="n">MAX_SHAPE_DIM</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// æ ¹æ® outShapes æˆ–åŸå§‹å½¢çŠ¶è®¡ç®—è¾“å‡ºå¼ é‡çš„å½¢çŠ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">dim</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outShapes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tensorShape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">outShapes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tensorShape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¿å­˜è¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">saveInOutTensor</span><span class="p">(</span><span class="n">tensorShape</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">dim</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">tensor</span><span class="o">-&gt;</span><span class="n">dtype</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">data_path</span> <span class="o">+</span> <span class="s">&#34;/out&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;_ref.bin&#34;</span><span class="p">,</span> <span class="n">multiOutputData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// é‡Šæ”¾å½“å‰èŠ¯ç‰‡çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">input_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">free</span><span class="p">(</span><span class="n">multiInputDdata</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">output_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">free</span><span class="p">(</span><span class="n">multiOutputData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="run_code_gen_layer">run_code_gen_layer<a hidden class="anchor" aria-hidden="true" href="#run_code_gen_layer">#</a></h1>
<p>ä¸»è¦ç”¨äºè¿è¡Œä»£ç ç”Ÿæˆ (codegen) ç›¸å…³çš„ä»»åŠ¡ï¼Œä»¥ä¸‹æ˜¯å‡½æ•°çš„è¯¦ç»†åŠŸèƒ½è§£é‡Šï¼š</p>
<ol>
<li>è§£æå‚æ•°ï¼š</li>
</ol>
<ul>
<li>æ¥å—è‡³å°‘ä¸¤ä¸ªå‚æ•°ï¼š$1 æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ï¼Œ$2 æ˜¯ç§å­æ–‡ä»¶ (seed file)</li>
<li>å¦‚æœæœ‰æ›´å¤šå‚æ•° ($# &gt; 2)ï¼Œåˆ™å°†é¢å¤–å‚æ•°å­˜å‚¨ä¸ºé…ç½®å‚æ•° (config_params)</li>
<li>ä» config_params ä¸­æå– <code>codegen_path</code> (ä»£ç ç”Ÿæˆè¾“å‡ºè·¯å¾„) ï¼Œå¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤å€¼ &ldquo;codegen&rdquo;</li>
</ul>
<ol start="2">
<li>åˆ‡æ¢å·¥ä½œç›®å½•ï¼š</li>
</ol>
<ul>
<li>åˆ‡æ¢åˆ° <code>${BEMLIR_PROJECT_ROOT}/build/bin</code> ç›®å½•ã€‚</li>
<li>åˆ é™¤æ—§çš„ <code>codegen_path</code> ç›®å½•ï¼Œç¡®ä¿ç¯å¢ƒå¹²å‡€ã€‚</li>
</ul>
<ol start="3">
<li>æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼š</li>
</ol>
<ul>
<li>ä½¿ç”¨ <code>${layer_cmd}</code> (å³ ./$1) è¿è¡ŒæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¼ å…¥ç§å­æ–‡ä»¶å’Œé…ç½®å‚æ•°ã€‚</li>
<li>æ£€æŸ¥è¿”å›å€¼ï¼Œå¦‚æœå¤±è´¥ <code>(ret != 0)</code>ï¼Œåˆ™æ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯ã€‚</li>
</ul>
<ol start="4">
<li>å¤„ç†ç”Ÿæˆçš„ä»£ç ï¼š</li>
</ol>
<ul>
<li>æ ¹æ®å‚æ•°ä¸­çš„ <code>chip_num</code> æˆ– <code>static_shape</code> åˆ¤æ–­ <code>host_type</code>.</li>
<li>è°ƒç”¨ <code>get_codegen_file</code> å¤„ç†ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ã€‚</li>
</ul>
<ol start="5">
<li>è¿è¡Œ cmodel æµ‹è¯•:</li>
</ol>
<ul>
<li>æ ¹æ®å‚æ•°ä¸­çš„ <code>fast_codegen</code> æˆ– <code>not_run</code> è®¾ç½® cmp_flag.</li>
<li>è°ƒç”¨ <code>run_on_cmodel</code> åœ¨ cmodel ä¸Šè¿è¡Œç”Ÿæˆçš„ä»£ç ã€‚</li>
<li>æ£€æŸ¥è¿”å›å€¼ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># å®šä¹‰ run_codegen_layer å‡½æ•°ï¼Œç”¨äºè¿è¡Œä»£ç ç”Ÿæˆå±‚æµ‹è¯•æµç¨‹</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> run_codegen_layer<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. æ‰“å°å¼€å§‹æ—¶é—´ï¼Œç”¨äºè°ƒè¯•å’Œæ€§èƒ½è¿½è¸ª</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -n <span class="s2">&#34;time==&gt;&gt;run_codegen_layer-start   &#34;</span><span class="p">;</span> date<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2. å‡½æ•°å‚æ•°è¯´æ˜</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># $1: å¯æ‰§è¡Œæ–‡ä»¶åç§°</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># $2: ç§å­æ–‡ä»¶ (seed fileï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="nv">layer_cmd</span><span class="o">=</span><span class="s2">&#34;./</span><span class="nv">$1</span><span class="s2">&#34;</span>  <span class="c1"># åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="nv">seed_file</span><span class="o">=</span><span class="nv">$2</span>      <span class="c1"># ç§å­æ–‡ä»¶æˆ–é…ç½®æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="nv">config_params</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="c1"># é…ç½®å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># é»˜è®¤ä»£ç ç”Ÿæˆè¾“å‡ºè·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="nv">codegen_path</span><span class="o">=</span><span class="s2">&#34;codegen&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3. æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡2ä¸ªå‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æå–é™¤å‰ä¸¤ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°ä½œä¸ºé…ç½®å‚æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="nv">config_params</span><span class="o">=</span><span class="nv">$*</span>
</span></span><span class="line"><span class="cl">        <span class="nv">config_params</span><span class="o">=</span><span class="si">${</span><span class="nv">config_params</span><span class="p">#*</span><span class="si">}</span>  <span class="c1"># ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•° (å¯æ‰§è¡Œæ–‡ä»¶ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="nv">config_params</span><span class="o">=</span><span class="si">${</span><span class="nv">config_params</span><span class="p">#*</span><span class="si">}</span>  <span class="c1"># ç§»é™¤ç¬¬äºŒä¸ªå‚æ•° (ç§å­æ–‡ä»¶ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4. å¦‚æœé…ç½®å‚æ•°ä¸­åŒ…å« --codegen_pathï¼Œæå–å…¶å€¼ä½œä¸ºä»£ç ç”Ÿæˆè·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="si">${</span><span class="nv">config_params</span><span class="si">}</span> <span class="o">==</span> *<span class="s2">&#34;--codegen_path=&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æå– --codegen_path= åé¢çš„å€¼</span>
</span></span><span class="line"><span class="cl">        <span class="nv">codegen_path</span><span class="o">=</span><span class="si">${</span><span class="nv">config_params</span><span class="p">#*codegen_path=</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç§»é™¤å¯èƒ½å­˜åœ¨çš„å¼•å·æˆ–å…¶ä»–å­—ç¬¦</span>
</span></span><span class="line"><span class="cl">        <span class="nv">codegen_path</span><span class="o">=</span><span class="si">${</span><span class="nv">codegen_path</span><span class="p">%%</span><span class="se">\&#34;</span><span class="p">*</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">codegen_path</span><span class="o">=</span><span class="si">${</span><span class="nv">codegen_path</span><span class="p">-*</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">codegen_path</span><span class="o">=</span><span class="si">${</span><span class="nv">codegen_path</span><span class="p">*</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 5. åˆ‡æ¢åˆ° build/bin ç›®å½•æ‰§è¡Œå‘½ä»¤</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="si">${</span><span class="nv">BEMLIR_PROJECT_ROOT</span><span class="si">}</span>/build/bin
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ é™¤æ—§çš„ codegen_path ç›®å½•ï¼Œç¡®ä¿ç¯å¢ƒå¹²å‡€</span>
</span></span><span class="line"><span class="cl">        rm -rf <span class="si">${</span><span class="nv">codegen_path</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ‰§è¡Œå±‚å‘½ä»¤ï¼Œä¼ å…¥ç§å­æ–‡ä»¶å’Œé…ç½®å‚æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="si">${</span><span class="nv">layer_cmd</span><span class="si">}</span> <span class="si">${</span><span class="nv">seed_file</span><span class="si">}</span> <span class="si">${</span><span class="nv">config_params</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ•è·å‘½ä»¤çš„è¿”å›å€¼</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥ (è¿”å›ç é0ï¼‰ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>  <span class="c1"># æ¢å¤åŸå§‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 6. æ‰“å°ä»£ç ç”Ÿæˆå®Œæˆçš„æ—¶é—´</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -n <span class="s2">&#34;time==&gt;&gt;run_codegen_layer-codegen=== &#34;</span><span class="p">;</span> date<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 7. æ ¹æ®å‚æ•°åˆ¤æ–­ä¸»æœºç±»å‹</span>
</span></span><span class="line"><span class="cl">    <span class="nv">host_type</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœå‚æ•°ä¸­åŒ…å« chip_num æˆ– static_shapeï¼Œåˆ™å°† host_type è®¾ä¸º 1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$*</span> <span class="o">==</span> *<span class="s2">&#34;chip_num&#34;</span>* <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="nv">$*</span> <span class="o">==</span> *<span class="s2">&#34;static_shape&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">host_type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 8. è°ƒç”¨ get_codegen_file å¤„ç†ç”Ÿæˆçš„ä»£ç æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    get_codegen_file <span class="si">${</span><span class="nv">codegen_path</span><span class="si">}</span> <span class="si">${</span><span class="nv">host_type</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ•è·è¿”å›å€¼</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœå¤„ç†å¤±è´¥ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 9. åˆå§‹åŒ–æ¯”è¾ƒæ ‡å¿—</span>
</span></span><span class="line"><span class="cl">    <span class="nv">cmp_flag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœå‚æ•°ä¸­åŒ…å« fast_codegen æˆ– not_runï¼Œåˆ™è®¾ç½® cmp_flag ä¸º &#34;not_run&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$*</span> <span class="o">==</span> *<span class="s2">&#34;fast_codegen&#34;</span>* <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="nv">$*</span> <span class="o">==</span> *<span class="s2">&#34;not_run&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">cmp_flag</span><span class="o">=</span><span class="s2">&#34;not_run&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 10. åœ¨ cmodel ä¸Šè¿è¡Œç”Ÿæˆçš„ä»£ç ï¼Œä¼ å…¥æ¯”è¾ƒæ ‡å¿—</span>
</span></span><span class="line"><span class="cl">    run_on_cmodel <span class="si">${</span><span class="nv">codegen_path</span><span class="si">}</span> <span class="si">${</span><span class="nv">cmp_flag</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ•è·è¿”å›å€¼</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœè¿è¡Œå¤±è´¥ï¼Œæ¢å¤ç›®å½•å¹¶è¿”å›é”™è¯¯</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="si">${</span><span class="nv">ret</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 11. æ‰“å°ç»“æŸæ—¶é—´</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -n <span class="s2">&#34;time==&gt;&gt;run codegen layer-end===   &#34;</span><span class="p">;</span> date<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="get_codegen_file">get_codegen_file<a hidden class="anchor" aria-hidden="true" href="#get_codegen_file">#</a></h2>
<p><code>get_codegen_file</code> ç”¨äºæ•´ç†ä»£ç ç”Ÿæˆçš„ç»“æœ (ä½äº <code>${BEMLIR_PROJECT_ROOT}/build/bin/${codegen_case}</code>)ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ (version.txt)ï¼Œå¹¶å°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°æµ‹è¯•ç›®å½• (<code>${BEMLIR_PROJECT_ROOT}/external/tx8be-oplib/tests/test_codegen</code>)ï¼Œæœ€åè°ƒç”¨ <code>get_codegen_host</code> å®Œæˆä¸»æœºç›¸å…³å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Function to process and organize generated codegen files</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> get_codegen_file<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Print all input arguments for debugging</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$*</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Assign first argument as the codegen case name or path</span>
</span></span><span class="line"><span class="cl">    <span class="nv">codegen_case</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Second argument: 0 for host thread mode, 1 for host stream mode</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Note: $2 is passed to get_codegen_host</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Change to the codegen case directory under build/bin</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BEMLIR_PROJECT_ROOT</span><span class="si">}</span><span class="s2">/build/bin/</span><span class="si">${</span><span class="nv">codegen_case</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find node directories matching node_[0-9]+_[0-9] pattern (e.g., node_123_4)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">node_dirs</span><span class="o">=</span><span class="k">$(</span>find . -maxdepth <span class="m">1</span> -type d -regex <span class="s1">&#39;.*/node_[0-9]+_[0-9]&#39;</span> -exec basename <span class="o">{}</span> <span class="se">\;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Iterate through each node directory</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> dir in <span class="nv">$node_dirs</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Check if libTX8MLIRTransforms.a exists to determine version type</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BEMLIR_PROJECT_ROOT</span><span class="si">}</span><span class="s2">/lib/libTX8MLIRTransforms.a&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Write &#39;tx8be-mlir&#39; to version.txt if library is absent</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> -e <span class="s2">&#34;tx8be-mlir&#34;</span> &gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Write &#39;tx8be-mlir-sdk&#39; to version.txt if library is present</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> -e <span class="s2">&#34;tx8be-mlir-sdk&#34;</span> &gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Append git status to version.txt to record repository state</span>
</span></span><span class="line"><span class="cl">            git status --porcelain &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Append last two git commits to version.txt for version history</span>
</span></span><span class="line"><span class="cl">            git log -2 &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Change to the test_codegen directory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BEMLIR_PROJECT_ROOT</span><span class="si">}</span><span class="s2">/external/tx8be-oplib/tests/test_codegen&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Remove existing codegen_case directory to ensure a clean state</span>
</span></span><span class="line"><span class="cl">        rm -rf <span class="s2">&#34;</span><span class="si">${</span><span class="nv">codegen_case</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Copy the codegen_case directory from build/bin</span>
</span></span><span class="line"><span class="cl">        cp -r <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BEMLIR_PROJECT_ROOT</span><span class="si">}</span><span class="s2">/build/bin/</span><span class="si">${</span><span class="nv">codegen_case</span><span class="si">}</span><span class="s2">&#34;</span> .
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call get_codegen_host to process host-related tasks</span>
</span></span><span class="line"><span class="cl">    get_codegen_host <span class="s2">&#34;</span><span class="si">${</span><span class="nv">codegen_case</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="get_codegen_host">get_codegen_host<a hidden class="anchor" aria-hidden="true" href="#get_codegen_host">#</a></h2>
<p><code>get_codegen_host </code> ç”¨äºä¸º host ç¯å¢ƒå‡†å¤‡ä»£ç ç”Ÿæˆç”¨ä¾‹çš„æµ‹è¯•æ–‡ä»¶ã€‚å®ƒåœ¨æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸­å¤„ç† node &amp; chip ç›¸å…³çš„æ–‡ä»¶ï¼Œå¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶ã€æºä»£ç å’Œæ„å»ºè„šæœ¬ï¼Œå¹¶æ ¹æ® host_type é€‰æ‹©ä¸åŒçš„ä¸»æœºå®ç°æ–‡ä»¶ host_thread.cpp æˆ– host_stream.cpp.</p>
<ol>
<li>å‡½æ•°è¾“å…¥å‚æ•°ï¼š</li>
</ol>
<ul>
<li><code>$1 (codegen_case)</code>: ä»£ç ç”Ÿæˆç”¨ä¾‹çš„åç§°æˆ–è·¯å¾„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªç›®å½• (ä¾‹å¦‚ codegen0 æˆ– codegen1) ï¼Œè¡¨ç¤ºæµ‹è¯•ç”¨ä¾‹çš„æ ¹ç›®å½•ã€‚</li>
<li><code>$2 (host_type)</code>: ä¸»æœºæ‰§è¡Œæ¨¡å¼ï¼Œ0: host_thread.cppï¼Œ1: host_stream.cpp.</li>
</ul>
<ol start="2">
<li>åˆ‡æ¢åˆ° <code>${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${codegen_case}</code> ç›®å½•:</li>
</ol>
<ul>
<li>ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾ç¬¦åˆ node_[0-9]+_[0-9] æ¨¡å¼ (ä¾‹å¦‚ node_123_4) çš„å­ç›®å½•ï¼Œè¡¨ç¤ºä»£ç ç”Ÿæˆä¸­çš„èŠ‚ç‚¹ã€‚</li>
<li>å¯¹æ¯ä¸ª node_dir è¿½åŠ ç‰ˆæœ¬ä¿¡æ¯å’Œå¤åˆ¶ç›¸å…³æ–‡ä»¶ã€‚</li>
</ul>
<ol start="3">
<li>å¤„ç† chip ç›®å½•:</li>
</ol>
<ul>
<li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ç›®å½•ä¸‹ï¼ŒæŸ¥æ‰¾ç¬¦åˆ <code> chip[0-9]+</code> æ¨¡å¼ (ä¾‹å¦‚ chip0, chip1) çš„å­ç›®å½•</li>
<li>ä¸ºæ¯ä¸ª dir å¤åˆ¶ Makefile_tile åˆ° <code>./${node_dir}/${dir}/Makefile</code>. åœ¨ <code>./${node_dir}/${dir}/</code> ä¸‹åˆ›å»º 16 ä¸ªå­ç›®å½• (tiles0 - tiles15)ï¼Œå¹¶ä¸ºæ¯ä¸ªå­ç›®å½•å¤åˆ¶ Makefile_main åˆ° t <code>iles$i/Makefile</code></li>
</ul>
<ol start="4">
<li>æ ¹æ® <code>host_type</code> å¤åˆ¶ host_thread.cpp æˆ– host_stream.cpp åˆ°å½“å‰ç›®å½•çš„ host.cpp.</li>
<li>å¤åˆ¶ CMakeLists.txt å’Œ Makefile åˆ°å½“å‰ç›®å½•ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Function to prepare host-related files for a codegen test case</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> get_codegen_host<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Print all input arguments for debugging</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$*</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Assign first argument as the codegen case name or path</span>
</span></span><span class="line"><span class="cl">    <span class="nv">codegen_case</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Assign second argument as host type (0: thread mode, 1: stream mode)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">host_type</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Define relative path for test_codegen directory</span>
</span></span><span class="line"><span class="cl">    <span class="nv">oplib_path</span><span class="o">=</span><span class="s2">&#34;tests/test_codegen&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Change to the test_codegen directory for the codegen case</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tests/test_codegen/</span><span class="si">${</span><span class="nv">codegen_case</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find node directories matching node_[0-9]+_[0-9] pattern (e.g., node_123_4)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">node_dirs</span><span class="o">=</span><span class="k">$(</span>find . -maxdepth <span class="m">1</span> -type d -regex <span class="s1">&#39;.*/node_[0-9]+_[0-9]&#39;</span> -exec basename <span class="o">{}</span> <span class="se">\;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> node_dir in <span class="nv">$node_dirs</span><span class="p">;</span> <span class="k">do</span>  <span class="c1"># # Iterate through each node directory</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Append oplib version info to version.txt</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;\n\ntx8be-oplib:&#34;</span> &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Append git status to version.txt to record repository state</span>
</span></span><span class="line"><span class="cl">            git status --porcelain &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Write last two git commits to version.txt for version history</span>
</span></span><span class="line"><span class="cl">            git log -2 &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/version.txt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Copy all stream-related files to node directory</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/stream*&#34;</span> <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Copy CMakeLists_chip.txt as CMakeLists.txt for node</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/CMakeLists_chip.txt&#34;</span> <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/CMakeLists.txt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Copy main_kcore.c to node directory</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/main_kcore.c&#34;</span> <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Copy Makefile_chip as Makefile for node</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/Makefile_chip&#34;</span> <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/Makefile&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Find chip directories matching chip[0-9]+ pattern (e.g., chip0, chip1)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">chip_dirs</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">&#34;</span> -maxdepth <span class="m">1</span> -type d -regex <span class="s1">&#39;.*/chip[0-9]+&#39;</span> -exec basename <span class="o">{}</span> <span class="se">\;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Iterate through each chip directory</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> dir in <span class="nv">$chip_dirs</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Copy Makefile_tile as Makefile for chip</span>
</span></span><span class="line"><span class="cl">                cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/Makefile_tile&#34;</span> <span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/Makefile&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Create Makefiles for 16 tiles (tiles0 to tiles15)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;16<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">dst_file</span><span class="o">=</span><span class="s2">&#34;./</span><span class="si">${</span><span class="nv">node_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">dir</span><span class="si">}</span><span class="s2">/tiles</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">/Makefile&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Copy Makefile_main to each tile&#39;s Makefile</span>
</span></span><span class="line"><span class="cl">                    cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/Makefile_main&#34;</span> <span class="s2">&#34;</span><span class="nv">$dst_file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Copy host implementation based on host_type</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> <span class="nv">$host_type</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Use thread-based host implementation</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/host_thread.cpp&#34;</span> <span class="s2">&#34;host.cpp&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Use stream-based host implementation</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Note: Fixed typo &#39;$t{OPLIB_PROJECT_ROOT}&#39; to &#39;${{OPLIB_PROJECT_ROOT}}&#39;</span>
</span></span><span class="line"><span class="cl">            cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/host_stream.cpp&#34;</span> <span class="s2">&#34;host.cpp&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Copy top-level CMakeLists.txt for test case</span>
</span></span><span class="line"><span class="cl">        cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/CMakeLists.txt&#34;</span> .
</span></span><span class="line"><span class="cl">        <span class="c1"># Copy top-level Makefile for test case</span>
</span></span><span class="line"><span class="cl">        cp <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tools/codegen/Makefile&#34;</span> .
</span></span><span class="line"><span class="cl">    <span class="c1"># Restore original directory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="run_on_cmodel">run_on_cmodel<a hidden class="anchor" aria-hidden="true" href="#run_on_cmodel">#</a></h2>
<p><code>run_on_cmodel</code> ç”¨äºåœ¨æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸­è¿è¡Œ cmodel ä»¿çœŸä»»åŠ¡ã€‚å‡½æ•°çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ç¯å¢ƒè®¾ç½®ã€æ„å»ºã€æ‰§è¡Œä»¿çœŸè„šæœ¬æˆ–ç¨‹åºï¼Œå¹¶å¤„ç†é”™è¯¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜ï¼š</p>
<ol>
<li>å‡½æ•°è¾“å…¥å‚æ•°ï¼š</li>
</ol>
<ul>
<li>$1 (case_name): æ¥è‡ª <code>run_codegen_layer</code> çš„ <code>codegen_path</code>ï¼Œå¯èƒ½é™„åŠ  <code>host_type</code>.</li>
<li>$2 (run_flag): è¿è¡Œæ ‡å¿—ï¼Œæ¥è‡ª <code>run_codegen_layer</code> çš„ <code>cmp_flag</code> ç”¨äºæ§åˆ¶ä»¿çœŸæ‰§è¡Œçš„æ–¹å¼ (ä¾‹å¦‚æ˜¯å¦è¿è¡Œæˆ–è¿è¡Œæ¨¡å¼) ã€‚</li>
</ul>
<ol start="2">
<li>åˆ‡æ¢å·¥ä½œç›®å½•å¹¶æ‰§è¡Œ:</li>
</ol>
<ul>
<li>åˆ‡æ¢åˆ°æµ‹è¯•ç”¨ä¾‹ç›®å½• <code>${{OPLIB_PROJECT_ROOT}}/tests/test_codegen/${case_name}</code></li>
<li>è¿è¡Œ <code>cmake .. -DUSING_RISCV=OFF</code>ï¼Œé…ç½®æ„å»ºç³»ç»Ÿï¼Œç¦ç”¨ RISCV æ”¯æŒã€‚</li>
<li>è¿è¡Œ <code>make -j</code> å¹¶åŠ¨æ€è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•° (åŸºäº CPU æ ¸å¿ƒæ•°ï¼Œ<code>cat /proc/stat | grep cpu[0-9] -c</code>)</li>
</ul>
<ol start="3">
<li>ä»¿çœŸæ‰§è¡Œ: æ ¹æ®å‚æ•°è¿è¡Œä»¿çœŸè„šæœ¬ (host_sim.sh) æˆ– host_sim.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Function to run a cmodel simulation for a given test case</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> run_on_cmodel<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Assign first argument as the test case name</span>
</span></span><span class="line"><span class="cl">    <span class="nv">case_name</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Assign second argument as the run flag (controls execution mode)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">run_flag</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Check if case_name is empty</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$case_name</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Error: case_name is empty&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Check if the test case directory exists</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tests/test_codegen/</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Can not find </span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Change to the test case directory</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="p">{OPLIB_PROJECT_ROOT</span><span class="si">}</span><span class="s2">}/tests/test_codegen/</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">&#34;</span>  <span class="c1"># FIXED DIR</span>
</span></span><span class="line"><span class="cl">        rm -rf build
</span></span><span class="line"><span class="cl">        mkdir build
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">        <span class="c1"># Run cmake to configure the build, disabling RISCV support</span>
</span></span><span class="line"><span class="cl">        cmake .. -DUSING_RISCV<span class="o">=</span>OFF
</span></span><span class="line"><span class="cl">        <span class="c1"># Run make with parallel jobs based on CPU core count</span>
</span></span><span class="line"><span class="cl">        make -j<span class="k">$(</span>cat /proc/stat <span class="p">|</span> grep cpu<span class="o">[</span>0-9<span class="o">]</span> -c<span class="k">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>  <span class="c1"># Capture the return code</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># If make fails, restore directory, print error, and exit</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Check if run_flag is empty</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$run_flag</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> -e ../host_sim.sh <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c1"># Check if host_sim.sh exists in the parent directory</span>
</span></span><span class="line"><span class="cl">                cp ../host_sim.sh .
</span></span><span class="line"><span class="cl">                sh ./host_sim.sh
</span></span><span class="line"><span class="cl">                <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>  <span class="c1"># Capture the return code</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># If script fails, restore directory, print error, and exit</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>  
</span></span><span class="line"><span class="cl">                    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                ./host_sim ../  <span class="c1"># Run host_sim with parent directory as argument</span>
</span></span><span class="line"><span class="cl">                <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>  <span class="c1"># Capture the return code</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># If host_sim fails, restore directory, print error, and exit</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Check if run_flag is &#34;0&#34; or &#34;1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$run_flag</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="nv">$run_flag</span> <span class="o">==</span> <span class="s2">&#34;1&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Run host_sim with parent directory and run_flag</span>
</span></span><span class="line"><span class="cl">            ./host_sim ../ <span class="s2">&#34;</span><span class="nv">$run_flag</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>  <span class="c1"># Capture the return code</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If host_sim fails, restore directory, print error, and exit</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nv">$ret</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> </span><span class="nv">$*</span><span class="s2"> passed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h1 id="run_codegen_case_soc_rtt">run_codegen_case_soc_rtt<a hidden class="anchor" aria-hidden="true" href="#run_codegen_case_soc_rtt">#</a></h1>
<p>run_codegen_case_soc_rtt ä½äº <code>tx8-oplib/scripts/regression.sh</code>ï¼Œå‡½æ•°ç”¨äºåœ¨ SOC ç¯å¢ƒä¸‹è¿è¡Œ RTT (Real-Time Transfer) æµ‹è¯•ã€‚å…¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆå§‹åŒ–å’Œå‚æ•°è·å–ï¼š</li>
</ol>
<ul>
<li>å‡½æ•°ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å– <code>case_name</code>, <code>copy_option</code>, å’Œ <code>multi_graph_enable</code>.</li>
<li>æ£€æŸ¥ <code>case_name</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1.</li>
</ul>
<ol start="2">
<li>ç¯å¢ƒè®¾ç½®å’Œç›®å½•å¯¼èˆªï¼š</li>
</ol>
<ul>
<li>å°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ° <code>${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name}</code>. å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1ã€‚</li>
</ul>
<ol start="3">
<li>æ„å»ºå’Œé…ç½®ï¼š</li>
</ol>
<ul>
<li>æ‰§è¡Œ <code>rm -rf ${case_name}_build</code> æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ã€‚</li>
<li>æ ¹æ® <code>multi_graph_enable</code> è®¾ç½® <code>CONFIG_ARGS</code>ï¼Œå¦‚æœå¯ç”¨å¤šå›¾åˆ™è®¾ç½®ä¸º &ldquo;-DMULTI_GRAPH=1&rdquo;ï¼Œå¦åˆ™ä¸ºç©ºã€‚</li>
<li>è°ƒç”¨ cmake å‘½ä»¤ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºç›®å½•ä¸º <code>${case_name}_build</code>ï¼Œå¹¶æ ¹æ® <code>copy_option</code> è®¾ç½® <code>COPY_RTT_FLAG</code>.</li>
<li>æ‰§è¡Œ make å‘½ä»¤è¿›è¡Œå®é™…æ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ all å’Œ chip_out.</li>
</ul>
<ol start="4">
<li>é”™è¯¯å¤„ç†å’Œé€€å‡ºï¼š</li>
</ol>
<ul>
<li>æ¯æ¬¡å…³é”®æ­¥éª¤æ‰§è¡Œåï¼Œæ£€æŸ¥è¿”å›çŠ¶æ€ <code>$ret</code>ï¼Œå¦‚æœé 0ï¼Œåˆ™å¼¹å‡ºç›®å½•å¹¶è¿”å›é”™è¯¯ç ã€‚</li>
<li>æ„å»ºæˆåŠŸåè¾“å‡º <code>${FUNCNAME[0]} &quot;passed&quot;</code> è¡¨ç¤ºé€šè¿‡ã€‚</li>
</ul>
<ol start="5">
<li>æ¸…ç†å’Œè¿”å›: å‡½æ•°ç»“æŸæ—¶å¼¹å‡ºç›®å½•ï¼Œæ¢å¤åŸå§‹å·¥ä½œç›®å½•ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">function</span> run_codegen_case_soc_rtt<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> &#39;start&#39;&#34;</span>  <span class="c1"># è¾“å‡ºå‡½æ•°åå’Œ&#34;start&#34;è¡¨ç¤ºå¼€å§‹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">case_name</span><span class="o">=</span><span class="nv">$1</span>                  <span class="c1"># è·å–ç”¨ä¾‹åç§°</span>
</span></span><span class="line"><span class="cl">    <span class="nv">copy_option</span><span class="o">=</span><span class="nv">$2</span>                 <span class="c1"># è·å–å¤åˆ¶é€‰é¡¹</span>
</span></span><span class="line"><span class="cl">    <span class="nv">multi_graph_enable</span><span class="o">=</span><span class="nv">$3</span>          <span class="c1"># è·å–å¤šå›¾å¯ç”¨æ ‡å¿—</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$case_name</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c1"># å¦‚æœç”¨ä¾‹åç§°ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;case_name(</span><span class="nv">$case_name</span><span class="s2">) not found &#34;</span>  <span class="c1"># è¾“å‡ºé”™è¯¯ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>                   <span class="c1"># è¿”å›é”™è¯¯ç  1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">case_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/tests/test_codegen/<span class="si">${</span><span class="nv">case_name</span><span class="si">}</span>  <span class="c1"># è®¾ç½®ç”¨ä¾‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="si">${</span><span class="nv">case_dir</span><span class="si">}</span>              <span class="c1"># åˆ‡æ¢åˆ°ç”¨ä¾‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    rm -rf <span class="si">${</span><span class="nv">case_name</span><span class="si">}</span>_build      <span class="c1"># æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ£€æŸ¥æ¸…ç†æ˜¯å¦æˆåŠŸ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$multi_graph_enable</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c1"># å¦‚æœå¤šå›¾å¯ç”¨æ ‡å¿—ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">        <span class="nv">CONFIG_ARGS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>                 <span class="c1"># é…ç½®å‚æ•°ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>                                 <span class="c1"># å¦åˆ™</span>
</span></span><span class="line"><span class="cl">        <span class="nv">CONFIG_ARGS</span><span class="o">=</span><span class="s2">&#34;-DMULTI_GRAPH=1&#34;</span>  <span class="c1"># è®¾ç½®å¤šå›¾é…ç½®å‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    cmake -B <span class="s2">&#34;</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">_build&#34;</span> -DUSING_RISCV<span class="o">=</span>ON -TX8FW_BASE<span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/release/riscv/tx8-yoc-rt-thread-smp <span class="si">${</span><span class="nv">CONFIG_ARGS</span><span class="si">}</span> <span class="p">;</span> <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># ç”Ÿæˆæ„å»ºæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    make -j -C <span class="s2">&#34;</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">_build&#34;</span> --target all chip_out <span class="p">;</span> <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ‰§è¡Œæ„å»º</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>                          <span class="c1"># æ¢å¤åˆ°åŸå§‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> &#39;passed&#39;&#34;</span> <span class="c1"># è¾“å‡ºå‡½æ•°åå’Œ&#34;passed&#34;è¡¨ç¤ºé€šè¿‡</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="export_tx8fw_to_env">export_tx8fw_to_env<a hidden class="anchor" aria-hidden="true" href="#export_tx8fw_to_env">#</a></h2>
<p><code>export_tx8fw_to_env</code> å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯è®¾ç½®ä¸ TX8FW ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿åç»­æ„å»ºæˆ–è¿è¡Œæ—¶ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯å…¶æµç¨‹ï¼š</p>
<ol>
<li>è®¾ç½® SDK è·¯å¾„ï¼š</li>
</ol>
<ul>
<li>å®šä¹‰ TX8FW çš„ SDK è·¯å¾„ <code>soc_sdk_path</code> ä¸º <code>${OPLIB_PROJECT_ROOT}/3rd_party/tx8-yoc-rt-thread-smp</code>.</li>
</ul>
<ol start="2">
<li>æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨:</li>
</ol>
<ul>
<li>æ£€æŸ¥è·¯å¾„ <code>${soc_sdk_path}/tool/tx8fw-xuantie-sdk</code> æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºï¼ŒçŠ¶æ€ç ä¸º 1.</li>
</ul>
<ol start="3">
<li>å¯¼å‡ºç¯å¢ƒå˜é‡: æ‰“å°å¹¶è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡</li>
</ol>
<ul>
<li>TX8FW_SDK_INSTALL_DIRï¼šæŒ‡å‘ ${soc_sdk_path}/tool/tx8fw-xuantie-sdkã€‚</li>
<li>TX8FW_TOOLCHAIN_VARIANTï¼šè®¾ç½®ä¸º cross-compileã€‚</li>
</ul>
<ol start="4">
<li>æ¸…ç†ç›®å½•: ä½¿ç”¨ popd å‘½ä»¤æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">function</span> export_tx8fw_to_env<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">soc_sdk_path</span><span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/3rd_party/tx8-yoc-rt-thread-smp  <span class="c1"># è®¾ç½® TX8FW SDK è·¯å¾„</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="si">${</span><span class="nv">soc_sdk_path</span><span class="si">}</span>/tool/tx8fw-xuantie-sdk  <span class="c1"># åˆ‡æ¢åˆ° TX8FW SDK å·¥å…·ç›®å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&#34;xuantie-900-gcc-elf-newlib-x86_64-V2.8.0&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c1"># æ£€æŸ¥æŒ‡å®š SDK ç›®å½•æ˜¯å¦å­˜åœ¨</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">soc_sdk_path</span><span class="si">}</span><span class="s2">/tool/tx8fw-xuantie-sdk didn&#39;t exist&#34;</span>  <span class="c1"># å¦‚æœä¸å­˜åœ¨ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>  <span class="c1"># é€€å‡ºå¹¶è¿”å›çŠ¶æ€ç  1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;export TX8FW_SDK_INSTALL_DIR=</span><span class="si">${</span><span class="nv">soc_sdk_path</span><span class="si">}</span><span class="s2">/tool/tx8fw-xuantie-sdk&#34;</span>  <span class="c1"># æ‰“å°å¹¶è®¾ç½® TX8FW SDK å®‰è£…ç›®å½•ç¯å¢ƒå˜é‡</span>
</span></span><span class="line"><span class="cl">    <span class="nb">export</span> <span class="nv">TX8FW_SDK_INSTALL_DIR</span><span class="o">=</span><span class="si">${</span><span class="nv">soc_sdk_path</span><span class="si">}</span>/tool/tx8fw-xuantie-sdk  <span class="c1"># å¯¼å‡º TX8FW SDK å®‰è£…ç›®å½•ç¯å¢ƒå˜é‡</span>
</span></span><span class="line"><span class="cl">    <span class="nb">export</span> <span class="nv">TX8FW_TOOLCHAIN_VARIANT</span><span class="o">=</span>cross-compile  <span class="c1"># å¯¼å‡ºå·¥å…·é“¾å˜ä½“ä¸º cross-compile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>  <span class="c1"># æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="build_oplib_with_soc-å‡½æ•°">build_oplib_with_soc å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#build_oplib_with_soc-å‡½æ•°">#</a></h2>
<p><code>build_oplib_with_soc</code> å‡½æ•°ç”¨äºæ„å»º OPLib å¹¶ç»“åˆç‰¹å®š SoC é…ç½®ã€‚ä»¥ä¸‹æ˜¯å…¶æµç¨‹ï¼š</p>
<p>æ‰“å°é¡¹ç›®æ ¹ç›®å½•ï¼š
æ‰“å° OPLIB_PROJECT_ROOT ç¯å¢ƒå˜é‡ï¼Œç”¨äºè°ƒè¯•æˆ–æ—¥å¿—è®°å½•ã€‚</p>
<ol>
<li>åˆ‡æ¢ç›®å½•å’Œåˆå§‹åŒ–ï¼š</li>
</ol>
<ul>
<li>ä½¿ç”¨ pushd åˆ‡æ¢åˆ° <code>OPLIB_PROJECT_ROOT</code> ç›®å½•ã€‚</li>
<li>å®šä¹‰å˜é‡ <code>rm=rf build</code>, <code>mkdir=build</code> å’Œ <code>cd=build</code>ï¼Œè¿™äº›å˜é‡å®é™…ä¸Šæ˜¯æ¨¡æ‹Ÿå‘½ä»¤ï¼ˆrm -rf buildã€mkdir build å’Œ cd buildï¼‰ã€‚</li>
</ul>
<ol start="2">
<li>è®¾ç½®å¤åˆ¶æ ‡å¿—ï¼š</li>
</ol>
<ul>
<li>æ£€æŸ¥ <code>$1</code> (å³ <code>copy_option</code>) æ˜¯å¦ä¸º &ldquo;NOT_COPY&rdquo;ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¾ç½® <code>COPY_RTT_FLAG</code> ä¸º <code>--DRTT_HOST_COPY=OFF</code>ï¼Œå¦åˆ™ä¸ºç©ºã€‚</li>
</ul>
<ol start="3">
<li>å¯¼å‡ºç¯å¢ƒå˜é‡å¹¶æ„å»ºï¼š</li>
</ol>
<ul>
<li>è°ƒç”¨ <code>export_tx8fw_to_env</code> å‡½æ•°è®¾ç½® TX8FW ç›¸å…³ç¯å¢ƒå˜é‡ã€‚</li>
<li>è¿è¡Œ cmake å‘½ä»¤ï¼Œç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºé€‰é¡¹ <code>-DUSING_RISCV=ON</code> å’Œ <code>TX8FW_BASE</code>ï¼Œå¹¶æ ¹æ® <code>COPY_RTT_FLAG</code> æ·»åŠ é¢å¤–å‚æ•°ã€‚</li>
<li>ä½¿ç”¨ make å‘½ä»¤æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ grep epilog å’Œ c</li>
</ul>
<ol start="4">
<li>æ¸…ç†ç›®å½•: ä½¿ç”¨ popd å‘½ä»¤æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">function</span> build_oplib_with_soc<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>  <span class="c1"># æ‰“å° OPLib é¡¹ç›®æ ¹ç›®å½•è·¯å¾„</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>  <span class="c1"># åˆ‡æ¢åˆ° OPLib é¡¹ç›®æ ¹ç›®å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">rm</span><span class="o">=</span>rf build  <span class="c1"># å®šä¹‰æ¸…ç†æ„å»ºç›®å½•çš„å‘½ä»¤</span>
</span></span><span class="line"><span class="cl">    <span class="nv">mkdir</span><span class="o">=</span>build  <span class="c1"># å®šä¹‰åˆ›å»ºæ„å»ºç›®å½•çš„å‘½ä»¤</span>
</span></span><span class="line"><span class="cl">    <span class="nv">cd</span><span class="o">=</span>build     <span class="c1"># å®šä¹‰åˆ‡æ¢åˆ°æ„å»ºç›®å½•çš„å‘½ä»¤</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">COPY_RTT_FLAG</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="c1"># åˆå§‹åŒ– RTT å¤åˆ¶æ ‡å¿—</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;NOT_COPY&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c1"># å¦‚æœä¼ å…¥çš„å¤åˆ¶é€‰é¡¹ä¸º NOT_COPY</span>
</span></span><span class="line"><span class="cl">        <span class="nv">COPY_RTT_FLAG</span><span class="o">=</span><span class="s2">&#34;--DRTT_HOST_COPY=OFF&#34;</span>  <span class="c1"># è®¾ç½® RTT å¤åˆ¶æ ‡å¿—ä¸ºå…³é—­</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    export_tx8fw_to_env  <span class="c1"># è°ƒç”¨å‡½æ•°å¯¼å‡º TX8FW ç›¸å…³ç¯å¢ƒå˜é‡</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    cmake .. -DUSING_RISCV<span class="o">=</span>ON -TX8FW_BASE<span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/release/riscv/tx8-yoc-rt-thread-smp <span class="si">${</span><span class="nv">COPY_RTT_FLAG</span><span class="si">}</span>  <span class="c1"># ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®š RISCV å’Œ TX8FW è·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ£€æŸ¥ cmake æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å›</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    make -j cat /proc/stat <span class="p">|</span> grep epilog -c  <span class="c1"># æ‰§è¡Œæ„å»ºå¹¶æ£€æŸ¥ epilog ç›¸å…³ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ£€æŸ¥ make æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å›</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>  <span class="c1"># æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span> <span class="s2">&#34;passed&#34;</span>  <span class="c1"># è¾“å‡ºå‡½æ•°åå’Œ&#34;passed&#34;è¡¨ç¤ºæ„å»ºæˆåŠŸ</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="run_on_soc_rtt">run_on_soc_rtt<a hidden class="anchor" aria-hidden="true" href="#run_on_soc_rtt">#</a></h2>
<p><code>run_on_soc_rtt</code>ï¼Œç”¨äºåœ¨ç‰¹å®š SoC å’Œ RTT ç¯å¢ƒä¸‹è¿è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸»è¦æµç¨‹ï¼š</p>
<ol>
<li>åˆå§‹åŒ–å’Œå‚æ•°è·å–:</li>
</ol>
<ul>
<li>å‡½æ•°ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å– <code>case_name</code>, <code>rtt_option</code> å’Œ <code>multi_graph_enable</code>.</li>
<li>æ£€æŸ¥ <code>case_name</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å› 1ã€‚</li>
</ul>
<ol start="2">
<li>ç›®å½•åˆ‡æ¢å’Œæ¸…ç†:</li>
</ol>
<ul>
<li>å°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ° <code>${OPLIB_PROJECT_ROOT}/tests/test_codegen/${case_name}</code>.</li>
<li>æ‰§è¡Œ <code>rm -rf ${case_name}_build</code> æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ã€‚</li>
</ul>
<ol start="3">
<li>é…ç½®è®¾ç½®: æ ¹æ® <code>multi_graph_enable</code> è®¾ç½® CONFIG_ARGSï¼Œå¦‚æœå¯ç”¨å¤šå›¾åˆ™è®¾ç½®ä¸º &ldquo;-DMULTI_GRAPH=1&rdquo;ï¼Œå¦åˆ™ä¸ºç©ºã€‚</li>
<li>æ„å»ºå’Œè¿è¡Œï¼š</li>
</ol>
<ul>
<li>ä½¿ç”¨ cmake ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®šæ„å»ºç›®å½•ä¸º <code>${case_name}_build</code>ï¼Œå¹¶è®¾ç½® <code>-DUSING_RISCV=ON</code> å’Œ <code>-TX8FW_BASE</code> è·¯å¾„ã€‚</li>
<li>ä½¿ç”¨ make å‘½ä»¤æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡åŒ…æ‹¬ all å’Œ chip_out.</li>
</ul>
<ol start="5">
<li>æ¸…ç†å’Œè¿”å›: ä½¿ç”¨ popd æ¢å¤åˆ°åŸå§‹ç›®å½•ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">function</span> run_on_soc_rtt<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> &#39;start&#39;&#34;</span>  <span class="c1"># è¾“å‡ºå‡½æ•°åå’Œ&#34;start&#34;è¡¨ç¤ºå¼€å§‹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">case_name</span><span class="o">=</span><span class="nv">$1</span>                  <span class="c1"># è·å–ç”¨ä¾‹åç§°</span>
</span></span><span class="line"><span class="cl">    <span class="nv">rtt_option</span><span class="o">=</span><span class="nv">$2</span>                 <span class="c1"># è·å– RTT é€‰é¡¹</span>
</span></span><span class="line"><span class="cl">    <span class="nv">multi_graph_enable</span><span class="o">=</span><span class="nv">$3</span>         <span class="c1"># è·å–å¤šå›¾å¯ç”¨æ ‡å¿—</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$case_name</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c1"># å¦‚æœç”¨ä¾‹åç§°ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;case_name(</span><span class="nv">$case_name</span><span class="s2">) not found &#34;</span>  <span class="c1"># è¾“å‡ºé”™è¯¯ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>                   <span class="c1"># è¿”å›é”™è¯¯ç  1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">case_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/tests/test_codegen/<span class="si">${</span><span class="nv">case_name</span><span class="si">}</span>  <span class="c1"># è®¾ç½®ç”¨ä¾‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">    <span class="nb">pushd</span> <span class="si">${</span><span class="nv">case_dir</span><span class="si">}</span>              <span class="c1"># åˆ‡æ¢åˆ°ç”¨ä¾‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    rm -rf <span class="si">${</span><span class="nv">case_name</span><span class="si">}</span>_build      <span class="c1"># æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ£€æŸ¥æ¸…ç†æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™è¿”å›</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$multi_graph_enable</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c1"># å¦‚æœå¤šå›¾å¯ç”¨æ ‡å¿—ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">        <span class="nv">CONFIG_ARGS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>                 <span class="c1"># é…ç½®å‚æ•°ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>                                 <span class="c1"># å¦åˆ™</span>
</span></span><span class="line"><span class="cl">        <span class="nv">CONFIG_ARGS</span><span class="o">=</span><span class="s2">&#34;-DMULTI_GRAPH=1&#34;</span>  <span class="c1"># è®¾ç½®å¤šå›¾é…ç½®å‚æ•°</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    cmake -B <span class="s2">&#34;</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">_build&#34;</span> -DUSING_RISCV<span class="o">=</span>ON -TX8FW_BASE<span class="o">=</span><span class="si">${</span><span class="nv">OPLIB_PROJECT_ROOT</span><span class="si">}</span>/release/riscv/tx8-yoc-rt-thread-smp <span class="si">${</span><span class="nv">CONFIG_ARGS</span><span class="si">}</span> <span class="p">;</span> <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼ŒæŒ‡å®š RISCV å’Œ TX8FW è·¯å¾„</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    make -C <span class="s2">&#34;</span><span class="si">${</span><span class="nv">case_name</span><span class="si">}</span><span class="s2">_build&#34;</span> --target all chip_out <span class="p">;</span> <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">[</span> <span class="nv">$ret</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> popd<span class="p">;</span> <span class="nb">echo</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># æ‰§è¡Œæ„å»ºï¼Œç›®æ ‡ä¸º all å’Œ chip_out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">popd</span>                          <span class="c1"># æ¢å¤åˆ°åŸå§‹ç›®å½•</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> &#39;passed&#39;&#34;</span> <span class="c1"># è¾“å‡ºå‡½æ•°åå’Œ&#34;passed&#34;è¡¨ç¤ºé€šè¿‡</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/tx8-script/">Tx8-Script</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blogs/llada/">
    <span class="title">Â« Prev</span>
    <br>
    <span>LLaDA</span>
  </a>
  <a class="next" href="http://localhost:1313/blogs/astra-sim/">
    <span class="title">Next Â»</span>
    <br>
    <span>astra-Sim</span>
  </a>
</nav>

  </footer><script src="https://giscus.app/client.js"
        data-repo="jamesnulliu/jamesnulliu.github.io"
        data-repo-id="R_kgDOMPCQIw"
        data-category="Announcements"
        data-category-id="DIC_kwDOMPCQI84Cgb2t"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>Â© 2024-2025 WITHER</span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
