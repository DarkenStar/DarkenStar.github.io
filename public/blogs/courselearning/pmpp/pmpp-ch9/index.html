<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=57770&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization | WITHER</title>
<meta name="keywords" content="CUDA">
<meta name="description" content="Personal notebook 9 of Programming Massively Parallel Processors.">
<meta name="author" content="WITHER">
<link rel="canonical" href="http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch9/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5989807471fe399ba380d3b1501334cf52bf92768fffdd44127d22f5eeae9f42.css" integrity="sha256-WYmAdHH&#43;OZujgNOxUBM0z1K/knaP/91EEn0i9e6un0I=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:57770/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:57770/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:57770/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:57770/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:57770/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch9/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    }
  };
</script>


<meta property="og:url" content="http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch9/">
  <meta property="og:site_name" content="WITHER">
  <meta property="og:title" content="PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization">
  <meta property="og:description" content="Personal notebook 9 of Programming Massively Parallel Processors.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blogs">
    <meta property="article:published_time" content="2024-09-09T10:27:42+08:00">
    <meta property="article:modified_time" content="2025-06-07T23:40:58+08:00">
    <meta property="article:tag" content="PMPP Learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization">
<meta name="twitter:description" content="Personal notebook 9 of Programming Massively Parallel Processors.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "http://localhost:57770/blogs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Course Learning",
      "item": "http://localhost:57770/blogs/courselearning/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Programming Massive Parallel",
      "item": "http://localhost:57770/blogs/courselearning/pmpp/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization",
      "item": "http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch9/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization",
  "name": "PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization",
  "description": "Personal notebook 9 of Programming Massively Parallel Processors.",
  "keywords": [
    "CUDA"
  ],
  "articleBody": "9 Parallel Histogram-An Introduction to Atomic Operations and Privatization æœ¬ç« ä»‹ç»å¹¶è¡Œç›´æ–¹å›¾è®¡ç®—æ¨¡å¼ï¼Œå…¶ä¸­æ¯ä¸ªè¾“å‡ºå…ƒç´ éƒ½å¯ä»¥ç”±ä»»ä½•çº¿ç¨‹æ›´æ–°ã€‚å› æ­¤ï¼Œå½“çº¿ç¨‹æ›´æ–°è¾“å‡ºå…ƒç´ æ—¶å¿…é¡»æ³¨æ„çº¿ç¨‹ä¹‹é—´çš„åè°ƒï¼Œé¿å…ä»»ä½•å¯èƒ½ç ´åæœ€ç»ˆç»“æœçš„å¹²æ‰°ã€‚\n9.1 Background ç›´æ–¹å›¾æ˜¯æ•°æ®é›†ä¸­æ•°æ®å€¼å‡ºç°çš„æ•°é‡è®¡æ•°æˆ–ç™¾åˆ†æ¯”çš„æ˜¾ç¤ºã€‚åœ¨æœ€å¸¸è§çš„ç›´æ–¹å›¾å½¢å¼ä¸­ï¼Œé—´éš”åŒºé—´æ²¿æ°´å¹³è½´ç»˜åˆ¶ï¼Œæ¯ä¸ªé—´éš”ä¸­çš„æ•°æ®å€¼è®¡æ•°è¡¨ç¤ºä¸ºä»æ°´å¹³è½´ä¸Šå‡çš„çŸ©å½¢æˆ–æ¡å½¢çš„é«˜åº¦ã€‚ è®¸å¤šåº”ç”¨é¢†åŸŸä¾èµ–äºç›´æ–¹å›¾æ¥æ€»ç»“æ•°æ®é›†è¿›è¡Œæ•°æ®åˆ†æã€‚å…¶ä¸­ä¸€ä¸ªé¢†åŸŸå°±æ˜¯è®¡ç®—æœºè§†è§‰ã€‚å›¾åƒå­åŒºåŸŸç›´æ–¹å›¾çš„è®¡ç®—è¿‡ç¨‹æ˜¯è®¡ç®—æœºè§†è§‰ä¸­ç‰¹å¾ (å›¾åƒä¸­æ„Ÿå…´è¶£çš„æ¨¡å¼) æå–çš„é‡è¦æ–¹æ³•ã€‚\nA Histogram Representation of â€œprogramming massively parallel processorsâ€\n9.2 Atomic Operations and A Basic Histogram Kernel å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¹¶è¡ŒåŒ–ç›´æ–¹å›¾è®¡ç®—çš„æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯å¯åŠ¨æ•°æ®ä¸€æ ·å¤šçš„çº¿ç¨‹ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªå…ƒç´ ã€‚æ¯ä¸ªçº¿ç¨‹è¯»å–å…¶åˆ†é…çš„è¾“å…¥å…ƒç´ ï¼Œå¹¶å¢åŠ å¯¹åº”çš„éš”è®¡æ•°å™¨çš„å€¼ã€‚\nBasic Parallelization of a Histogram\nhisto æ•°ç»„ä¸­é—´éš”è®¡æ•°å™¨çš„å¢åŠ æ˜¯å¯¹å†…å­˜ä½ç½®çš„æ›´æ–°æˆ– read-modify-write æ“ä½œã€‚è¯¥æ“ä½œåŒ…æ‹¬è¯»å–å†…å­˜ä½ç½®(è¯»)ï¼Œåœ¨åŸå§‹å€¼ä¸ŠåŠ  1(ä¿®æ”¹)ï¼Œå¹¶å°†æ–°å€¼å†™å›å†…å­˜ä½ç½® (å†™)ã€‚åœ¨å®é™…è¿‡ç¨‹ä¸­ä¼šå‡ºç°è¯»-ä¿®æ”¹-å†™ç«äº‰æ¡ä»¶ (read-modify-write race condition)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªæˆ–å¤šä¸ªåŒæ­¥æ›´æ–°æ“ä½œçš„ç»“æœä¼šæ ¹æ®æ‰€æ¶‰åŠçš„æ“ä½œçš„ç›¸å¯¹æ—¶é—´è€Œå˜åŒ–ã€‚ ä¸‹å›¾ A ä¸­çº¿ç¨‹ 1 åœ¨æ—¶é—´æ®µ 1~3 æœŸé—´å®Œæˆäº†å…¶è¯»-ä¿®æ”¹-å†™åºåˆ—çš„æ‰€æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç„¶åçº¿ç¨‹ 2 åœ¨æ—¶é—´æ®µ 4 å¼€å§‹ï¼Œæœ€åç»“æœæ­£ç¡®ã€‚åœ¨å›¾ B ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹çš„è¯»-ä¿®æ”¹-å†™é¡ºåºé‡å ã€‚çº¿ç¨‹ 1 åœ¨æ—¶é—´æ®µ 4 æ—¶å°†æ–°å€¼å†™å…¥ histo[x]ã€‚å½“çº¿ç¨‹ 2 åœ¨æ—¶é—´æ®µ 3 è¯»å– histo[x]æ—¶ï¼Œå®ƒçš„å€¼ä»ç„¶æ˜¯ 0ï¼Œå› æ­¤æœ€åçš„å†™å…¥çš„å€¼æ˜¯ 1.\nRace Condition in Updating a histo Array Element\nåŸå­æ“ä½œ (atomic operation) çš„è¯»ã€ä¿®æ”¹å’Œå†™éƒ¨åˆ†æ„æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„å•å…ƒï¼Œå› æ­¤ç§°ä¸ºåŸå­æ“ä½œã€‚å¯¹è¯¥ä½ç½®çš„å…¶ä»–è¯»-ä¿®æ”¹-å†™åºåˆ—ä¸èƒ½ä¸å…¶åœ¨æ—¶é—´ä¸Šæœ‰é‡å ã€‚éœ€è¦æ³¨æ„åŸå­æ“ä½œåœ¨çº¿ç¨‹ä¹‹é—´ä¸å¼ºåˆ¶ä»»ä½•ç‰¹å®šçš„æ‰§è¡Œé¡ºåºï¼Œæ¯”å¦‚çº¿ç¨‹ 1 å¯ä»¥åœ¨çº¿ç¨‹ 2 ä¹‹å‰æˆ–ä¹‹åè¿è¡Œã€‚CUDAå†…æ ¸å¯ä»¥é€šè¿‡å‡½æ•°è°ƒç”¨å¯¹å†…å­˜ä½ç½®æ‰§è¡ŒåŸå­åŠ æ³•æ“ä½œ:\n1 int atomicAdd(int* address, int val); atomicAdd æ˜¯ä¸€ä¸ªå†…å»ºå‡½æ•° (intrinsic function)ï¼Œå®ƒè¢«ç¼–è¯‘æˆä¸€ä¸ªç¡¬ä»¶åŸå­æ“ä½œæŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤è¯»å–å…¨å±€æˆ–å…±äº«å†…å­˜ä¸­ address å‚æ•°æ‰€æŒ‡å‘çš„32ä½å­—ï¼Œå°† val åŠ ä¸Šæ—§å€¼ä¸­å¹¶å†™å…¥ç»“æœå›ç›¸åŒåœ°å€çš„å†…å­˜ä¸­ã€‚è¯¥å‡½æ•°è¿”å›åœ°å€å¤„çš„æ—§å€¼ã€‚\nIntrinsic Functions ç°ä»£å¤„ç†å™¨é€šå¸¸æä¾›ç‰¹æ®ŠæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤è¦ä¹ˆæ‰§è¡Œå…³é”®åŠŸèƒ½ (å¦‚åŸå­æ“ä½œ)ï¼Œè¦ä¹ˆå¤§å¹…æé«˜æ€§èƒ½ (å¦‚çŸ¢é‡æŒ‡ä»¤)ã€‚è¿™äº›æŒ‡ä»¤é€šå¸¸ä½œä¸ºå†…å»ºå‡½æ•°æš´éœ²ç»™ç¨‹åºå‘˜ï¼Œä»ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº›æ˜¯åº“å‡½æ•°ã€‚ç„¶è€Œï¼Œå®ƒä»¬è¢«ç¼–è¯‘å™¨ä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼å¤„ç†ã€‚æ¯ä¸ªè¿™æ ·çš„è°ƒç”¨éƒ½è¢«ç¿»è¯‘æˆç›¸åº”çš„ç‰¹æ®ŠæŒ‡ä»¤ã€‚åœ¨æœ€ç»ˆä»£ç ä¸­æ²¡æœ‰å‡½æ•°è°ƒç”¨ï¼Œåªæœ‰ä¸ç”¨æˆ·ä»£ç ä¸€è‡´çš„ç‰¹æ®ŠæŒ‡ä»¤ã€‚ 1 2 3 4 5 6 7 8 9 10 __global__ void histo_kernel(char* data, unsigned int length, unsigned int* histo) { unsigned int i = threadIdx.x + blockIdx.x * blockDim.x; if (i \u003c length) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { atomicAdd(\u0026histo[alphabet_position / 4], 1); } } } 9.3 Latency and Throughput of Atomic Operations é«˜å†…å­˜è®¿é—®ååé‡çš„å…³é”®æ˜¯åŒæ—¶è¿›è¡Œè®¸å¤š DRAM è®¿é—®ã€‚ç„¶è€Œï¼Œå½“è®¸å¤šåŸå­æ“ä½œæ›´æ–°ç›¸åŒçš„å†…å­˜ä½ç½®æ—¶ï¼Œä¸€ä¸ªåé¢çº¿ç¨‹çš„è¯»-ä¿®æ”¹-å†™åºåˆ—åœ¨å‰ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œç»“æŸä¹‹å‰ä¸èƒ½å¼€å§‹ï¼Œå³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€å†…å­˜ä½ç½®æ‰§è¡ŒåŸå­æ“ä½œã€‚æ›´æ–°è¿™äº›é—´éš”çš„å¤§é‡äº‰ç”¨æµé‡ä¼šä½¿å¾—ååé‡é™ä½ã€‚\nThe Execution of Atomic Operations at the Same Location\næé«˜åŸå­æ“ä½œååé‡çš„ä¸€ç§æ–¹æ³•æ˜¯å‡å°‘å¯¹ç«äº‰ä¸¥é‡çš„ä½ç½®çš„è®¿é—®å»¶è¿Ÿã€‚ç°ä»£ GPU å…è®¸åœ¨è¢«æ‰€æœ‰ SM å…±äº«çš„æœ€åä¸€çº§ç¼“å­˜ä¸­æ‰§è¡ŒåŸå­æ“ä½œã€‚ç”±äºå¯¹æœ€åä¸€çº§ç¼“å­˜çš„è®¿é—®æ—¶é—´æ˜¯å‡ åä¸ªå‘¨æœŸè€Œä¸æ˜¯å‡ ç™¾ä¸ªå‘¨æœŸï¼Œå› æ­¤åŸå­æ“ä½œçš„ååé‡ä¸æ—©æœŸGPUç›¸æ¯”è‡³å°‘æé«˜äº†ä¸€ä¸ªæ•°é‡çº§ã€‚\n9.4 Privatization æé«˜åŸå­æ“ä½œååé‡çš„å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡å¼•å¯¼æµé‡è¿œç¦»ç«äº‰ä¸¥é‡çš„ä½ç½®ã€‚è¿™å¯ä»¥é€šè¿‡ä¸€ç§ç§°ä¸ºç§æœ‰åŒ– (privatization) çš„æŠ€æœ¯æ¥å®ç°ã€‚å…¶æ€æƒ³æ˜¯å°†é«˜åº¦ç«äº‰çš„è¾“å‡ºæ•°æ®ç»“æ„å¤åˆ¶åˆ°ç§æœ‰å‰¯æœ¬ä¸­ï¼Œä»¥ä¾¿çº¿ç¨‹çš„æ¯ä¸ªå­é›†éƒ½å¯ä»¥æ›´æ–°å…¶ç§æœ‰å‰¯æœ¬ã€‚ ä¸‹å›¾å±•ç¤ºäº†å¦‚ä½•å°†ç§æœ‰åŒ–åº”ç”¨äºç›´æ–¹å›¾ç»Ÿè®¡ã€‚æ¯ä¸ªçº¿ç¨‹å—ç”± 8 ä¸ªçº¿ç¨‹ç»„æˆï¼Œäº‰ç”¨åªä¼šåœ¨åŒä¸€å—ä¸­çš„çº¿ç¨‹ä¹‹é—´ä»¥åŠåœ¨æœ€ååˆå¹¶ç§æœ‰å‰¯æœ¬æ—¶å‘ç”Ÿï¼Œè€Œä¸æ˜¯æ›´æ–°ç›¸åŒç›´æ–¹å›¾ bin çš„æ‰€æœ‰çº¿ç¨‹ä¹‹é—´å‘ç”Ÿäº‰ç”¨ã€‚\nReduce Contention of Atomic Operations by Private Copies of Histogram\nä¸€ä¸ªç§æœ‰åŒ–ç‰ˆæœ¬çš„ä»£ç å¦‚ä¸‹ï¼Œä¸º histo æ•°ç»„åˆ†é…è¶³å¤Ÿçš„è®¾å¤‡å†…å­˜ (gridDim.x*NUM_BINS*4 bytes) æ¥ä¿å­˜ç›´æ–¹å›¾çš„æ‰€æœ‰ç§æœ‰å‰¯æœ¬ã€‚åœ¨æ‰§è¡Œç»“æŸæ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å—å°†æŠŠç§æœ‰å‰¯æœ¬ä¸­çš„å€¼æäº¤åˆ° å— 0 çš„éƒ¨åˆ†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #define NUM_BINS 7 // # histo bins __global__ void histo_private_kernel(char* data, unsigned int length, unsigned int* histo) { unsigned int i = threadIdx.x + blockIdx.x * blockDim.x; if (i \u003c length) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { atomicAdd(\u0026histo[blockIdx.x * 7 + alphabet_position / 4], 1); } } if (blockIdx.x \u003e 0) { __syncthreads(); // for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { unsigned int binValue = histo[blockIdx * NUM_BINS + bin]; atomicAdd(\u0026histo[bin], binValue); } } } åœ¨æ¯ä¸ªçº¿ç¨‹å—çš„åŸºç¡€ä¸Šåˆ›å»ºç›´æ–¹å›¾çš„ç§æœ‰å‰¯æœ¬çš„ä¸€ä¸ªå¥½å¤„æ˜¯çº¿ç¨‹å¯ä»¥åœ¨æäº¤è‡ªå·±çš„ç»Ÿè®¡ç»“æœä¹‹å‰ä½¿ç”¨ __syncthreads() æ¥ç­‰å¾…å½¼æ­¤ã€‚å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœç›´æ–¹å›¾ä¸­çš„ bin æ•°é‡è¶³å¤Ÿå°ï¼Œåˆ™å¯ä»¥åœ¨å…±äº«å†…å­˜ä¸­å£°æ˜ç›´æ–¹å›¾çš„ç§æœ‰å‰¯æœ¬ (æ¯ä¸ªçº¿ç¨‹å—ä¸€ä¸ª)ã€‚ä¸‹é¢ä»£ç ç›´æ–¹å›¾åœ¨å…±äº«å†…å­˜ä¸­åˆ†é…ç§æœ‰å‰¯æœ¬ histo_s æ•°ç»„ï¼Œå¹¶ç”±å—çš„çº¿ç¨‹å¹¶è¡Œåˆå§‹åŒ–ä¸º 0.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 __global__ void histo_shared_private_kernel(char* data, unsigned int length, unsigned int* histo) { // Initializing private bins __shared__ unsigned int histo_s[NUM_BINS]; for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { histo_s[bin] = 0; } __syncthreads(); // Histogram unsigned int i = threadIdx.x + blockIdx.x * blockDim.x; if (i \u003c length) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { atomicAdd(\u0026histo_s[alphabet_position / 4], 1); } } __syncthreads(); // Commit to global memory for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { unsigned binValue = histo_s[bin]; if (binValue \u003e 0) { atomicAdd(\u0026histo[bin], binValue); } } } 9.5 Coarsening ç§æœ‰åŒ–çš„å¼€é”€æ˜¯éœ€è¦å°†ç§æœ‰å‰¯æœ¬æäº¤åˆ°å…¬å…±å‰¯æœ¬ã€‚æ¯ä¸ªçº¿ç¨‹å—éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æäº¤æ“ä½œï¼Œå› æ­¤ï¼Œä½¿ç”¨çš„çº¿ç¨‹å—è¶Šå¤šï¼Œè¿™ä¸ªå¼€é”€å°±è¶Šå¤§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å°‘å—çš„æ•°é‡æ¥å‡å°‘ç§æœ‰å‰¯æœ¬çš„æ•°é‡ï¼Œä»è€Œå‡å°‘æäº¤åˆ°å…¬å…±å‰¯æœ¬çš„æ¬¡æ•°ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¾“å…¥å…ƒç´ ã€‚\nContiguous Partition of Input Elements\nä¸‹é¢ä»£ç æ˜¯ä¸€ä¸ªè¿ç»­åˆ†åŒº (contiguous partition) ç­–ç•¥çš„ç¤ºä¾‹ï¼Œè¾“å…¥è¢«è¿ç»­åˆ’åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯ä¸ªæ®µè¢«åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä» tid*CFACTOR è¿­ä»£åˆ° (tid+1)*CFACTOR è¿›è¡Œæ‰€è´Ÿè´£éƒ¨åˆ†çš„ç»Ÿè®¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #define CFACTOR 3 __global__ void histo_shared_private_contiguous_kernel(char* data, unsigned int length, unsigned int* histo) { { // Initializing private bins __shared__ unsigned int histo_s[NUM_BINS]; for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { histo_s[bin] = 0; } __syncthreads(); // Histogram unsigned tid = blockIdx.x * blockDim.x + threadIdx.x; for (unsigned int i = tid * CFACTOR; i \u003c (tid + 1)*CFACTOR \u0026\u0026 i \u003c length; i++) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { atomicAdd(\u0026histo_s[alphabet_position / 4], 1); } } __syncthreads(); // Commit to global memory for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { unsigned binValue = histo_s[bin]; if (binValue \u003e 0) { atomicAdd(\u0026histo[bin], binValue); } } } ä¸Šè¿°åœ¨ GPU ä¸Šè¿ç»­åˆ†åŒºçš„æ€è·¯ä¼šå¯¼è‡´å†…å­˜ä¸å‹å¥½çš„è®¿é—®æ¨¡å¼ï¼Œå› ä¸º threadIdx ç›¸åŒçš„çº¿ç¨‹è®¿é—®çš„ä¸æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸã€‚å› æ­¤æˆ‘ä»¬è¦é‡‡ç”¨äº¤é”™åˆ†åŒº (interleaved partition)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³ä¸åŒçº¿ç¨‹è¦å¤„ç†çš„åˆ†åŒºå½¼æ­¤äº¤é”™ã€‚å®é™…åº”ç”¨ä¸­æ¯ä¸ªçº¿ç¨‹åœ¨æ¯æ¬¡è¿­ä»£ä¸­åº”è¯¥å¤„ç† 4 ä¸ª char (ä¸€ä¸ª 32 ä½å­—)ï¼Œä»¥å……åˆ†åˆ©ç”¨ç¼“å­˜å’Œ SMs ä¹‹é—´çš„äº’è¿å¸¦å®½ã€‚\nInterleaved Partition of Input Elements\nä¸‹é¢ä»£ç æ˜¯ä¸€ä¸ªäº¤é”™åˆ†åŒºçš„ç¤ºä¾‹ã€‚åœ¨å¾ªç¯çš„ç¬¬ä¸€æ¬¡è¿­ä»£ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å…¶å…¨å±€çº¿ç¨‹ç´¢å¼•è®¿é—®æ•°æ®æ•°ç»„:çº¿ç¨‹ 0 è®¿é—®å…ƒç´  0ï¼Œçº¿ç¨‹ 1 è®¿é—®å…ƒç´  1ï¼Œçº¿ç¨‹ 2 è®¿é—®å…ƒç´  2â€¦æ‰€æœ‰çº¿ç¨‹å…±åŒå¤„ç†è¾“å…¥çš„ç¬¬ä¸€ä¸ª blockDim.x*gridDim.x å…ƒç´ ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 __global__ void histo_shared_private_interleaved_kernel(char* data, unsigned int length, unsigned int* histo) { { // Initializing private bins __shared__ unsigned int histo_s[NUM_BINS]; for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { histo_s[bin] = 0; } __syncthreads(); // Histogram unsigned tid = blockIdx.x * blockDim.x + threadIdx.x; for (unsigned int i = tid; i \u003c length; i += blockDim.x * gridDim.x) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { atomicAdd(\u0026histo_s[alphabet_position / 4], 1); } } __syncthreads(); // Commit to global memory for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { unsigned binValue = histo_s[bin]; if (binValue \u003e 0) { atomicAdd(\u0026histo[bin], binValue); } } } 9.6 Aggregation ä¸€äº›æ•°æ®é›†åœ¨å±€éƒ¨åŒºåŸŸæœ‰å¤§é‡ç›¸åŒçš„æ•°æ®å€¼ã€‚å¦‚æ­¤é«˜åº¦é›†ä¸­çš„ç›¸åŒå€¼ä¼šå¯¼è‡´ä¸¥é‡çš„äº‰ç”¨ï¼Œå¹¶é™ä½å¹¶è¡Œç›´æ–¹å›¾è®¡ç®—çš„ååé‡ã€‚ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„ä¼˜åŒ–æ˜¯ï¼Œå¦‚æœæ¯ä¸ªçº¿ç¨‹æ­£åœ¨æ›´æ–°ç›´æ–¹å›¾çš„ç›¸åŒå…ƒç´ ï¼Œåˆ™å°†è¿ç»­çš„æ›´æ–°èšåˆä¸ºå•ä¸ªæ›´æ–°ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†èšåˆçš„ç›´æ–¹å›¾è®¡ç®—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 __global__ void histo_shared_private_interleaved_aggregated_kernel(char* data, unsigned int length, unsigned int* histo) { // Initializing private bins __shared__ unsigned int histo_s[NUM_BINS]; for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { histo_s[bin] = 0; } __syncthreads(); // Histogram unsigned int accumulator = 0; int prevBinIdx = -1; unsigned tid = blockIdx.x * blockDim.x + threadIdx.x; for (unsigned int i = tid; i \u003c length; i += blockDim.x * gridDim.x) { int alphabet_position = data[i] - 'a'; if (alphabet_position \u003e= 0 \u0026\u0026 alphabet_position \u003c 26) { int currBinIdx = alphabet_position / 4; if (currBinIdx != prevBinIdx) { // Update previous statistics if (accumulator \u003e 0) { atomicAdd(\u0026histo_s[prevBinIdx], accumulator); } accumulator = 1; prevBinIdx = currBinIdx; } else { // Accumulate statistics accumulator++; } } } if (accumulator \u003e 0) { // Update last bin atomicAdd(\u0026histo_s[prevBinIdx], accumulator); } __syncthreads(); // Commit to global memory for (unsigned int bin = threadIdx.x; bin \u003c NUM_BINS; bin += blockDim.x) { unsigned binValue = histo_s[bin]; if (binValue \u003e 0) { atomicAdd(\u0026histo[bin], binValue); } } } å¯ä»¥çœ‹å‡ºèšåˆå†…æ ¸éœ€è¦æ›´å¤šçš„è¯­å¥å’Œå˜é‡ã€‚æ·»åŠ çš„ if è¯­å¥å¯èƒ½ä¼šå‡ºç°æ§åˆ¶å‘æ•£ã€‚ç„¶è€Œï¼Œå¦‚æœæ²¡æœ‰äº‰ç”¨æˆ–å­˜åœ¨ä¸¥é‡çš„äº‰ç”¨ï¼Œå°±å¾ˆå°‘æœ‰æ§åˆ¶å‘æ•£ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¹ˆéƒ½åœ¨å¢åŠ ç´¯åŠ å™¨å€¼ï¼Œè¦ä¹ˆéƒ½åœ¨è¿ç»­åˆ·æ–°ã€‚\n",
  "wordCount" : "3150",
  "inLanguage": "en",
  "datePublished": "2024-09-09T10:27:42+08:00",
  "dateModified": "2025-06-07T23:40:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "WITHER"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch9/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "WITHER",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:57770/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:57770/" accesskey="h" title="WITHER (Alt + H)">WITHER</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:57770/zh/" title="ç®€ä½“ä¸­æ–‡"
                            aria-label="ç®€ä½“ä¸­æ–‡">ç®€ä½“ä¸­æ–‡</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:57770/" title="ğŸ  Home">
                    <span>ğŸ  Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/about_me/" title="ğŸ™‹ğŸ»â€â™‚ï¸ Me">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸ Me</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/blogs/" title="ğŸ“š Blogs">
                    <span>ğŸ“š Blogs</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/categories/" title="ğŸ§© Categories">
                    <span>ğŸ§© Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/tags/" title="ğŸ”– Tags">
                    <span>ğŸ”– Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/archives/" title="â± Archive">
                    <span>â± Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/search/" title="ğŸ” Search (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:57770/friends/" title="ğŸ¤ Friends">
                    <span>ğŸ¤ Friends</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:57770/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:57770/blogs/">Blogs</a>&nbsp;Â»&nbsp;<a href="http://localhost:57770/blogs/courselearning/">Course Learning</a>&nbsp;Â»&nbsp;<a href="http://localhost:57770/blogs/courselearning/pmpp/">Programming Massive Parallel</a></div>
    <h1 class="post-title entry-hint-parent">
      PMPP Learning-Chapter 9 Parallel Histogram-An Introduction to Atomic Operations and Privatization
    </h1>
    <div class="post-description">
      Personal notebook 9 of Programming Massively Parallel Processors.
    </div>
    <div class="post-meta"><span title='2024-09-09 10:27:42 +0800 CST'>Sep-09-2024</span>&nbsp;Â·&nbsp;7 min&nbsp;Â·&nbsp;3150 words&nbsp;Â·&nbsp;WITHER

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#9-parallel-histogram-an-introduction-to-atomic-operations-and-privatization" aria-label="9 Parallel Histogram-An Introduction to Atomic Operations and Privatization">9 Parallel Histogram-An Introduction to Atomic Operations and Privatization</a><ul>
                            
                    <li>
                        <a href="#91-background" aria-label="9.1 Background">9.1 Background</a></li>
                    <li>
                        <a href="#92-atomic-operations-and-a-basic-histogram-kernel" aria-label="9.2 Atomic Operations and A Basic Histogram Kernel">9.2 Atomic Operations and A Basic Histogram Kernel</a></li>
                    <li>
                        <a href="#93-latency-and-throughput-of-atomic-operations" aria-label="9.3 Latency and Throughput of Atomic Operations">9.3 Latency and Throughput of Atomic Operations</a></li>
                    <li>
                        <a href="#94-privatization" aria-label="9.4 Privatization">9.4 Privatization</a></li>
                    <li>
                        <a href="#95-coarsening" aria-label="9.5 Coarsening">9.5 Coarsening</a></li>
                    <li>
                        <a href="#96-aggregation" aria-label="9.6 Aggregation">9.6 Aggregation</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h1 id="9-parallel-histogram-an-introduction-to-atomic-operations-and-privatization">9 Parallel Histogram-An Introduction to Atomic Operations and Privatization<a hidden class="anchor" aria-hidden="true" href="#9-parallel-histogram-an-introduction-to-atomic-operations-and-privatization">#</a></h1>
<p>æœ¬ç« ä»‹ç»å¹¶è¡Œç›´æ–¹å›¾è®¡ç®—æ¨¡å¼ï¼Œå…¶ä¸­æ¯ä¸ªè¾“å‡ºå…ƒç´ éƒ½å¯ä»¥ç”±ä»»ä½•çº¿ç¨‹æ›´æ–°ã€‚å› æ­¤ï¼Œå½“çº¿ç¨‹æ›´æ–°è¾“å‡ºå…ƒç´ æ—¶å¿…é¡»æ³¨æ„çº¿ç¨‹ä¹‹é—´çš„åè°ƒï¼Œé¿å…ä»»ä½•å¯èƒ½ç ´åæœ€ç»ˆç»“æœçš„å¹²æ‰°ã€‚</p>
<h2 id="91-background">9.1 Background<a hidden class="anchor" aria-hidden="true" href="#91-background">#</a></h2>
<p>ç›´æ–¹å›¾æ˜¯æ•°æ®é›†ä¸­æ•°æ®å€¼å‡ºç°çš„æ•°é‡è®¡æ•°æˆ–ç™¾åˆ†æ¯”çš„æ˜¾ç¤ºã€‚åœ¨æœ€å¸¸è§çš„ç›´æ–¹å›¾å½¢å¼ä¸­ï¼Œé—´éš”åŒºé—´æ²¿æ°´å¹³è½´ç»˜åˆ¶ï¼Œæ¯ä¸ªé—´éš”ä¸­çš„æ•°æ®å€¼è®¡æ•°è¡¨ç¤ºä¸ºä»æ°´å¹³è½´ä¸Šå‡çš„çŸ©å½¢æˆ–æ¡å½¢çš„é«˜åº¦ã€‚
è®¸å¤šåº”ç”¨é¢†åŸŸä¾èµ–äºç›´æ–¹å›¾æ¥æ€»ç»“æ•°æ®é›†è¿›è¡Œæ•°æ®åˆ†æã€‚å…¶ä¸­ä¸€ä¸ªé¢†åŸŸå°±æ˜¯è®¡ç®—æœºè§†è§‰ã€‚å›¾åƒå­åŒºåŸŸç›´æ–¹å›¾çš„è®¡ç®—è¿‡ç¨‹æ˜¯è®¡ç®—æœºè§†è§‰ä¸­ç‰¹å¾ (å›¾åƒä¸­æ„Ÿå…´è¶£çš„æ¨¡å¼) æå–çš„é‡è¦æ–¹æ³•ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEBf1b2ad27e9184b6ecf628e068c42e7e4?method=download&amp;shareKey=a44ec6cce3fffb07208a7a67ee8005a5" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEBf1b2ad27e9184b6ecf628e068c42e7e4?method=download&amp;shareKey=a44ec6cce3fffb07208a7a67ee8005a5" alt="A Histogram Representation of  â€œprogramming massively parallel processorsâ€">
    </a><figcaption>A Histogram Representation of  â€œprogramming massively parallel processorsâ€</figcaption></figure></p>
<h2 id="92-atomic-operations-and-a-basic-histogram-kernel">9.2 Atomic Operations and A Basic Histogram Kernel<a hidden class="anchor" aria-hidden="true" href="#92-atomic-operations-and-a-basic-histogram-kernel">#</a></h2>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¹¶è¡ŒåŒ–ç›´æ–¹å›¾è®¡ç®—çš„æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯å¯åŠ¨æ•°æ®ä¸€æ ·å¤šçš„çº¿ç¨‹ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªå…ƒç´ ã€‚æ¯ä¸ªçº¿ç¨‹è¯»å–å…¶åˆ†é…çš„è¾“å…¥å…ƒç´ ï¼Œå¹¶å¢åŠ å¯¹åº”çš„éš”è®¡æ•°å™¨çš„å€¼ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEBd162f505e52265f5421f0fa883e5d19b?method=download&amp;shareKey=4d8e366384fcc19aebe518ad8fecdc7d" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEBd162f505e52265f5421f0fa883e5d19b?method=download&amp;shareKey=4d8e366384fcc19aebe518ad8fecdc7d" alt="Basic Parallelization of a Histogram">
    </a><figcaption>Basic Parallelization of a Histogram</figcaption></figure></p>
<p>histo æ•°ç»„ä¸­é—´éš”è®¡æ•°å™¨çš„å¢åŠ æ˜¯å¯¹å†…å­˜ä½ç½®çš„æ›´æ–°æˆ– read-modify-write æ“ä½œã€‚è¯¥æ“ä½œåŒ…æ‹¬è¯»å–å†…å­˜ä½ç½®(è¯»)ï¼Œåœ¨åŸå§‹å€¼ä¸ŠåŠ  1(ä¿®æ”¹)ï¼Œå¹¶å°†æ–°å€¼å†™å›å†…å­˜ä½ç½® (å†™)ã€‚åœ¨å®é™…è¿‡ç¨‹ä¸­ä¼šå‡ºç°è¯»-ä¿®æ”¹-å†™ç«äº‰æ¡ä»¶ (<em>read-modify-write race condition</em>)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªæˆ–å¤šä¸ªåŒæ­¥æ›´æ–°æ“ä½œçš„ç»“æœä¼šæ ¹æ®æ‰€æ¶‰åŠçš„æ“ä½œçš„ç›¸å¯¹æ—¶é—´è€Œå˜åŒ–ã€‚
ä¸‹å›¾ A ä¸­çº¿ç¨‹ 1 åœ¨æ—¶é—´æ®µ 1~3 æœŸé—´å®Œæˆäº†å…¶è¯»-ä¿®æ”¹-å†™åºåˆ—çš„æ‰€æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç„¶åçº¿ç¨‹ 2 åœ¨æ—¶é—´æ®µ 4 å¼€å§‹ï¼Œæœ€åç»“æœæ­£ç¡®ã€‚åœ¨å›¾ B ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹çš„è¯»-ä¿®æ”¹-å†™é¡ºåºé‡å ã€‚çº¿ç¨‹ 1 åœ¨æ—¶é—´æ®µ 4 æ—¶å°†æ–°å€¼å†™å…¥ <code>histo[x]</code>ã€‚å½“çº¿ç¨‹ 2 åœ¨æ—¶é—´æ®µ 3 è¯»å– <code>histo[x]</code>æ—¶ï¼Œå®ƒçš„å€¼ä»ç„¶æ˜¯ 0ï¼Œå› æ­¤æœ€åçš„å†™å…¥çš„å€¼æ˜¯ 1.</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEBfcb1b1249b8c3eaa4b079cc3c6211f60?method=download&amp;shareKey=6c860292730da34f80c4f3020f5e709c" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEBfcb1b1249b8c3eaa4b079cc3c6211f60?method=download&amp;shareKey=6c860292730da34f80c4f3020f5e709c" alt="Race Condition in Updating a histo Array Element">
    </a><figcaption>Race Condition in Updating a histo Array Element</figcaption></figure></p>
<p>åŸå­æ“ä½œ (<em>atomic operation</em>) çš„è¯»ã€ä¿®æ”¹å’Œå†™éƒ¨åˆ†æ„æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„å•å…ƒï¼Œå› æ­¤ç§°ä¸ºåŸå­æ“ä½œã€‚å¯¹è¯¥ä½ç½®çš„å…¶ä»–è¯»-ä¿®æ”¹-å†™åºåˆ—ä¸èƒ½ä¸å…¶åœ¨æ—¶é—´ä¸Šæœ‰é‡å ã€‚éœ€è¦æ³¨æ„<em>åŸå­æ“ä½œåœ¨çº¿ç¨‹ä¹‹é—´ä¸å¼ºåˆ¶ä»»ä½•ç‰¹å®šçš„æ‰§è¡Œé¡ºåº</em>ï¼Œæ¯”å¦‚çº¿ç¨‹ 1 å¯ä»¥åœ¨çº¿ç¨‹ 2 ä¹‹å‰æˆ–ä¹‹åè¿è¡Œã€‚CUDAå†…æ ¸å¯ä»¥é€šè¿‡å‡½æ•°è°ƒç”¨å¯¹å†…å­˜ä½ç½®æ‰§è¡ŒåŸå­åŠ æ³•æ“ä½œ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">atomicAdd</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>atomicAdd</code> æ˜¯ä¸€ä¸ªå†…å»ºå‡½æ•° (intrinsic function)ï¼Œå®ƒè¢«ç¼–è¯‘æˆä¸€ä¸ªç¡¬ä»¶åŸå­æ“ä½œæŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤è¯»å–å…¨å±€æˆ–å…±äº«å†…å­˜ä¸­ <code>address</code> å‚æ•°æ‰€æŒ‡å‘çš„32ä½å­—ï¼Œå°† <code>val</code> åŠ ä¸Šæ—§å€¼ä¸­å¹¶å†™å…¥ç»“æœå›ç›¸åŒåœ°å€çš„å†…å­˜ä¸­ã€‚è¯¥å‡½æ•°è¿”å›åœ°å€å¤„çš„æ—§å€¼ã€‚</p>
<details class="custom-details">
    <summary class="custom-summary">Intrinsic Functions</summary>
    <div>ç°ä»£å¤„ç†å™¨é€šå¸¸æä¾›ç‰¹æ®ŠæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤è¦ä¹ˆæ‰§è¡Œå…³é”®åŠŸèƒ½ (å¦‚åŸå­æ“ä½œ)ï¼Œè¦ä¹ˆå¤§å¹…æé«˜æ€§èƒ½ (å¦‚çŸ¢é‡æŒ‡ä»¤)ã€‚è¿™äº›æŒ‡ä»¤é€šå¸¸ä½œä¸ºå†…å»ºå‡½æ•°æš´éœ²ç»™ç¨‹åºå‘˜ï¼Œä»ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº›æ˜¯åº“å‡½æ•°ã€‚ç„¶è€Œï¼Œå®ƒä»¬è¢«ç¼–è¯‘å™¨ä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼å¤„ç†ã€‚æ¯ä¸ªè¿™æ ·çš„è°ƒç”¨éƒ½è¢«ç¿»è¯‘æˆç›¸åº”çš„ç‰¹æ®ŠæŒ‡ä»¤ã€‚åœ¨æœ€ç»ˆä»£ç ä¸­æ²¡æœ‰å‡½æ•°è°ƒç”¨ï¼Œåªæœ‰ä¸ç”¨æˆ·ä»£ç ä¸€è‡´çš„ç‰¹æ®ŠæŒ‡ä»¤ã€‚</div>
</details><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">__global__</span> 
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="93-latency-and-throughput-of-atomic-operations">9.3 Latency and Throughput of Atomic Operations<a hidden class="anchor" aria-hidden="true" href="#93-latency-and-throughput-of-atomic-operations">#</a></h2>
<p>é«˜å†…å­˜è®¿é—®ååé‡çš„å…³é”®æ˜¯åŒæ—¶è¿›è¡Œè®¸å¤š DRAM è®¿é—®ã€‚ç„¶è€Œï¼Œå½“è®¸å¤šåŸå­æ“ä½œæ›´æ–°ç›¸åŒçš„å†…å­˜ä½ç½®æ—¶ï¼Œä¸€ä¸ªåé¢çº¿ç¨‹çš„è¯»-ä¿®æ”¹-å†™åºåˆ—åœ¨å‰ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œç»“æŸä¹‹å‰ä¸èƒ½å¼€å§‹ï¼Œå³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€å†…å­˜ä½ç½®æ‰§è¡ŒåŸå­æ“ä½œã€‚æ›´æ–°è¿™äº›é—´éš”çš„å¤§é‡äº‰ç”¨æµé‡ä¼šä½¿å¾—ååé‡é™ä½ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEBe7de6cb4432d570997a5d51a354269df?method=download&amp;shareKey=244ed14ff414262053d92e3b884321b4" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEBe7de6cb4432d570997a5d51a354269df?method=download&amp;shareKey=244ed14ff414262053d92e3b884321b4" alt="The Execution of Atomic Operations at the Same Location">
    </a><figcaption>The Execution of Atomic Operations at the Same Location</figcaption></figure></p>
<p>æé«˜åŸå­æ“ä½œååé‡çš„ä¸€ç§æ–¹æ³•æ˜¯å‡å°‘å¯¹ç«äº‰ä¸¥é‡çš„ä½ç½®çš„è®¿é—®å»¶è¿Ÿã€‚ç°ä»£ GPU å…è®¸åœ¨è¢«æ‰€æœ‰ SM å…±äº«çš„æœ€åä¸€çº§ç¼“å­˜ä¸­æ‰§è¡ŒåŸå­æ“ä½œã€‚ç”±äºå¯¹æœ€åä¸€çº§ç¼“å­˜çš„è®¿é—®æ—¶é—´æ˜¯å‡ åä¸ªå‘¨æœŸè€Œä¸æ˜¯å‡ ç™¾ä¸ªå‘¨æœŸï¼Œå› æ­¤åŸå­æ“ä½œçš„ååé‡ä¸æ—©æœŸGPUç›¸æ¯”è‡³å°‘æé«˜äº†ä¸€ä¸ªæ•°é‡çº§ã€‚</p>
<h2 id="94-privatization">9.4 Privatization<a hidden class="anchor" aria-hidden="true" href="#94-privatization">#</a></h2>
<p>æé«˜åŸå­æ“ä½œååé‡çš„å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡å¼•å¯¼æµé‡è¿œç¦»ç«äº‰ä¸¥é‡çš„ä½ç½®ã€‚è¿™å¯ä»¥é€šè¿‡ä¸€ç§ç§°ä¸ºç§æœ‰åŒ– (<em>privatization</em>) çš„æŠ€æœ¯æ¥å®ç°ã€‚å…¶æ€æƒ³æ˜¯å°†é«˜åº¦ç«äº‰çš„è¾“å‡ºæ•°æ®ç»“æ„å¤åˆ¶åˆ°ç§æœ‰å‰¯æœ¬ä¸­ï¼Œä»¥ä¾¿çº¿ç¨‹çš„æ¯ä¸ªå­é›†éƒ½å¯ä»¥æ›´æ–°å…¶ç§æœ‰å‰¯æœ¬ã€‚
ä¸‹å›¾å±•ç¤ºäº†å¦‚ä½•å°†ç§æœ‰åŒ–åº”ç”¨äºç›´æ–¹å›¾ç»Ÿè®¡ã€‚æ¯ä¸ªçº¿ç¨‹å—ç”± 8 ä¸ªçº¿ç¨‹ç»„æˆï¼Œäº‰ç”¨åªä¼šåœ¨åŒä¸€å—ä¸­çš„çº¿ç¨‹ä¹‹é—´ä»¥åŠåœ¨æœ€ååˆå¹¶ç§æœ‰å‰¯æœ¬æ—¶å‘ç”Ÿï¼Œè€Œä¸æ˜¯æ›´æ–°ç›¸åŒç›´æ–¹å›¾ bin çš„æ‰€æœ‰çº¿ç¨‹ä¹‹é—´å‘ç”Ÿäº‰ç”¨ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEBb7aa2df247e5dc432476efa8b601df20?method=download&amp;shareKey=82f3b5074429b6bf29ca79a092a0044d" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEBb7aa2df247e5dc432476efa8b601df20?method=download&amp;shareKey=82f3b5074429b6bf29ca79a092a0044d" alt="Reduce Contention of Atomic Operations by Private Copies of Histogram">
    </a><figcaption>Reduce Contention of Atomic Operations by Private Copies of Histogram</figcaption></figure></p>
<p>ä¸€ä¸ªç§æœ‰åŒ–ç‰ˆæœ¬çš„ä»£ç å¦‚ä¸‹ï¼Œä¸º histo æ•°ç»„åˆ†é…è¶³å¤Ÿçš„è®¾å¤‡å†…å­˜ (<code>gridDim.x*NUM_BINS*4</code> bytes) æ¥ä¿å­˜ç›´æ–¹å›¾çš„æ‰€æœ‰ç§æœ‰å‰¯æœ¬ã€‚åœ¨æ‰§è¡Œç»“æŸæ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å—å°†æŠŠç§æœ‰å‰¯æœ¬ä¸­çš„å€¼æäº¤åˆ° å— 0 çš„éƒ¨åˆ†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#define NUM_BINS 7  </span><span class="c1">// # histo bins 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__global__</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_private_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binValue</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="n">blockIdx</span> <span class="o">*</span> <span class="n">NUM_BINS</span> <span class="o">+</span> <span class="n">bin</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span> <span class="n">binValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ¯ä¸ªçº¿ç¨‹å—çš„åŸºç¡€ä¸Šåˆ›å»ºç›´æ–¹å›¾çš„ç§æœ‰å‰¯æœ¬çš„ä¸€ä¸ªå¥½å¤„æ˜¯çº¿ç¨‹å¯ä»¥åœ¨æäº¤è‡ªå·±çš„ç»Ÿè®¡ç»“æœä¹‹å‰ä½¿ç”¨ <code>__syncthreads()</code> æ¥ç­‰å¾…å½¼æ­¤ã€‚å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœç›´æ–¹å›¾ä¸­çš„ bin æ•°é‡è¶³å¤Ÿå°ï¼Œåˆ™å¯ä»¥åœ¨å…±äº«å†…å­˜ä¸­å£°æ˜ç›´æ–¹å›¾çš„ç§æœ‰å‰¯æœ¬ (æ¯ä¸ªçº¿ç¨‹å—ä¸€ä¸ª)ã€‚ä¸‹é¢ä»£ç ç›´æ–¹å›¾åœ¨å…±äº«å†…å­˜ä¸­åˆ†é…ç§æœ‰å‰¯æœ¬ <code>histo_s</code> æ•°ç»„ï¼Œå¹¶ç”±å—çš„çº¿ç¨‹å¹¶è¡Œåˆå§‹åŒ–ä¸º 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">__global__</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_shared_private_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initializing private bins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">__shared__</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">NUM_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Histogram
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo_s</span><span class="p">[</span><span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Commit to global memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="n">binValue</span> <span class="o">=</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">binValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span> <span class="n">binValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="95-coarsening">9.5 Coarsening<a hidden class="anchor" aria-hidden="true" href="#95-coarsening">#</a></h2>
<p>ç§æœ‰åŒ–çš„å¼€é”€æ˜¯éœ€è¦å°†ç§æœ‰å‰¯æœ¬æäº¤åˆ°å…¬å…±å‰¯æœ¬ã€‚æ¯ä¸ªçº¿ç¨‹å—éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æäº¤æ“ä½œï¼Œå› æ­¤ï¼Œä½¿ç”¨çš„çº¿ç¨‹å—è¶Šå¤šï¼Œè¿™ä¸ªå¼€é”€å°±è¶Šå¤§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å°‘å—çš„æ•°é‡æ¥å‡å°‘ç§æœ‰å‰¯æœ¬çš„æ•°é‡ï¼Œä»è€Œå‡å°‘æäº¤åˆ°å…¬å…±å‰¯æœ¬çš„æ¬¡æ•°ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¾“å…¥å…ƒç´ ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEB685390a635126cba569f8c85254bcfc5?method=download&amp;shareKey=bf894427e4a2c0fdce32f9bf00094c52" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEB685390a635126cba569f8c85254bcfc5?method=download&amp;shareKey=bf894427e4a2c0fdce32f9bf00094c52" alt="Contiguous Partition of Input Elements">
    </a><figcaption>Contiguous Partition of Input Elements</figcaption></figure></p>
<p>ä¸‹é¢ä»£ç æ˜¯ä¸€ä¸ªè¿ç»­åˆ†åŒº (<em>contiguous partition</em>) ç­–ç•¥çš„ç¤ºä¾‹ï¼Œè¾“å…¥è¢«è¿ç»­åˆ’åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯ä¸ªæ®µè¢«åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä» <code>tid*CFACTOR</code> è¿­ä»£åˆ° <code>(tid+1)*CFACTOR</code> è¿›è¡Œæ‰€è´Ÿè´£éƒ¨åˆ†çš„ç»Ÿè®¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#define CFACTOR 3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">__global__</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_shared_private_contiguous_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initializing private bins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">__shared__</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">NUM_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Histogram
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tid</span> <span class="o">*</span> <span class="n">CFACTOR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">CFACTOR</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo_s</span><span class="p">[</span><span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Commit to global memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="n">binValue</span> <span class="o">=</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">binValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span> <span class="n">binValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°åœ¨ GPU ä¸Šè¿ç»­åˆ†åŒºçš„æ€è·¯ä¼šå¯¼è‡´å†…å­˜ä¸å‹å¥½çš„è®¿é—®æ¨¡å¼ï¼Œå› ä¸º threadIdx ç›¸åŒçš„çº¿ç¨‹è®¿é—®çš„ä¸æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸã€‚å› æ­¤æˆ‘ä»¬è¦é‡‡ç”¨äº¤é”™åˆ†åŒº (<em>interleaved partition</em>)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³ä¸åŒçº¿ç¨‹è¦å¤„ç†çš„åˆ†åŒºå½¼æ­¤äº¤é”™ã€‚å®é™…åº”ç”¨ä¸­æ¯ä¸ªçº¿ç¨‹åœ¨æ¯æ¬¡è¿­ä»£ä¸­åº”è¯¥å¤„ç† 4 ä¸ª char (ä¸€ä¸ª 32 ä½å­—)ï¼Œä»¥å……åˆ†åˆ©ç”¨ç¼“å­˜å’Œ SMs ä¹‹é—´çš„äº’è¿å¸¦å®½ã€‚</p>
<p>
<figure class="post-figure">
    <a href="https://note.youdao.com/yws/api/personal/file/WEB166097c6dec3a7d7eed2c82d5706bf55?method=download&amp;shareKey=79fb19c70cf16d76fdc9113eeefd12e8" target="_blank" rel="noopener">
        <img loading="lazy" src="https://note.youdao.com/yws/api/personal/file/WEB166097c6dec3a7d7eed2c82d5706bf55?method=download&amp;shareKey=79fb19c70cf16d76fdc9113eeefd12e8" alt="Interleaved Partition of Input Elements">
    </a><figcaption>Interleaved Partition of Input Elements</figcaption></figure></p>
<p>ä¸‹é¢ä»£ç æ˜¯ä¸€ä¸ªäº¤é”™åˆ†åŒºçš„ç¤ºä¾‹ã€‚åœ¨å¾ªç¯çš„ç¬¬ä¸€æ¬¡è¿­ä»£ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å…¶å…¨å±€çº¿ç¨‹ç´¢å¼•è®¿é—®æ•°æ®æ•°ç»„:çº¿ç¨‹ 0 è®¿é—®å…ƒç´  0ï¼Œçº¿ç¨‹ 1 è®¿é—®å…ƒç´  1ï¼Œçº¿ç¨‹ 2 è®¿é—®å…ƒç´  2&hellip;æ‰€æœ‰çº¿ç¨‹å…±åŒå¤„ç†è¾“å…¥çš„ç¬¬ä¸€ä¸ª <code>blockDim.x*gridDim.x</code> å…ƒç´ ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">__global__</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_shared_private_interleaved_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initializing private bins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">__shared__</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">NUM_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Histogram
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo_s</span><span class="p">[</span><span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Commit to global memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="n">binValue</span> <span class="o">=</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">binValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span> <span class="n">binValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="96-aggregation">9.6 Aggregation<a hidden class="anchor" aria-hidden="true" href="#96-aggregation">#</a></h2>
<p>ä¸€äº›æ•°æ®é›†åœ¨å±€éƒ¨åŒºåŸŸæœ‰å¤§é‡ç›¸åŒçš„æ•°æ®å€¼ã€‚å¦‚æ­¤é«˜åº¦é›†ä¸­çš„ç›¸åŒå€¼ä¼šå¯¼è‡´ä¸¥é‡çš„äº‰ç”¨ï¼Œå¹¶é™ä½å¹¶è¡Œç›´æ–¹å›¾è®¡ç®—çš„ååé‡ã€‚ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„ä¼˜åŒ–æ˜¯ï¼Œå¦‚æœæ¯ä¸ªçº¿ç¨‹æ­£åœ¨æ›´æ–°ç›´æ–¹å›¾çš„ç›¸åŒå…ƒç´ ï¼Œåˆ™å°†è¿ç»­çš„æ›´æ–°èšåˆä¸ºå•ä¸ªæ›´æ–°ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†èšåˆçš„ç›´æ–¹å›¾è®¡ç®—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">__global__</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">histo_shared_private_interleaved_aggregated_kernel</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">histo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initializing private bins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">__shared__</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">NUM_BINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Histogram
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">accumulator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">prevBinIdx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">gridDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">alphabet_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">alphabet_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alphabet_position</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">currBinIdx</span> <span class="o">=</span> <span class="n">alphabet_position</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">currBinIdx</span> <span class="o">!=</span> <span class="n">prevBinIdx</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Update previous statistics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="p">(</span><span class="n">accumulator</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo_s</span><span class="p">[</span><span class="n">prevBinIdx</span><span class="p">],</span> <span class="n">accumulator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="n">accumulator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">prevBinIdx</span> <span class="o">=</span> <span class="n">currBinIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// Accumulate statistics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">accumulator</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">accumulator</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Update last bin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo_s</span><span class="p">[</span><span class="n">prevBinIdx</span><span class="p">],</span> <span class="n">accumulator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">__syncthreads</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Commit to global memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin</span> <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">bin</span> <span class="o">&lt;</span> <span class="n">NUM_BINS</span><span class="p">;</span> <span class="n">bin</span> <span class="o">+=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="n">binValue</span> <span class="o">=</span> <span class="n">histo_s</span><span class="p">[</span><span class="n">bin</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">binValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">histo</span><span class="p">[</span><span class="n">bin</span><span class="p">],</span> <span class="n">binValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºèšåˆå†…æ ¸éœ€è¦æ›´å¤šçš„è¯­å¥å’Œå˜é‡ã€‚æ·»åŠ çš„ if è¯­å¥å¯èƒ½ä¼šå‡ºç°æ§åˆ¶å‘æ•£ã€‚ç„¶è€Œï¼Œå¦‚æœæ²¡æœ‰äº‰ç”¨æˆ–å­˜åœ¨ä¸¥é‡çš„äº‰ç”¨ï¼Œå°±å¾ˆå°‘æœ‰æ§åˆ¶å‘æ•£ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¹ˆéƒ½åœ¨å¢åŠ ç´¯åŠ å™¨å€¼ï¼Œè¦ä¹ˆéƒ½åœ¨è¿ç»­åˆ·æ–°ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:57770/tags/pmpp-learning/">PMPP Learning</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch8/">
    <span class="title">Â« Prev</span>
    <br>
    <span>PMPP Learning-Chapter 8 Stencil</span>
  </a>
  <a class="next" href="http://localhost:57770/blogs/courselearning/pmpp/pmpp-ch7/">
    <span class="title">Next Â»</span>
    <br>
    <span>PMPP Learning-Chapter 7 Convolution-An Introduction to Constant Memory and Caching</span>
  </a>
</nav>

  </footer><script src="https://giscus.app/client.js"
        data-repo="jamesnulliu/jamesnulliu.github.io"
        data-repo-id="R_kgDOMPCQIw"
        data-category="Announcements"
        data-category-id="DIC_kwDOMPCQI84Cgb2t"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>Â© 2024-2025 WITHER</span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
